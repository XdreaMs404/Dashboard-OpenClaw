# S022 - Diagnostic parse-errors et recommandations

canonical_story_id: E02-S10
epic: E02
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Scope canonique
- Story ID canonique: `E02-S10`
- FR clés: FR-030, FR-031
- NFR clés: NFR-012, NFR-016
- Risques: P02, T01
- Dépendance story: E02-S09

## Checklist Delivery
- [x] Implémentation conforme au scope canonique
- [x] Tests unit/intégration
- [x] Tests edge
- [x] Tests e2e
- [x] Coverage >= seuil
- [x] Security scan dépendances
- [x] Build
- [x] Audit UX prêt pour revue

## Critères d’acceptation S022
- [x] **AC-01 / FR-030**: contexte fraîcheur/staleness exposé par issue parse via `stalenessContext`.
- [x] **AC-02 / FR-031**: parse-errors expliqués avec recommandations actionnables.
- [x] **AC-03**: priorité source respectée (`stalenessResult` > `stalenessInput`).
- [x] **AC-04**: propagation stricte blocages amont S021.
- [x] **AC-05**: retry policy bornée (`maxRetries<=3`) et reason `PARSE_RETRY_LIMIT_REACHED`.
- [x] **AC-06**: DLQ policy (`PARSE_DLQ_REQUIRED`, `dlqCandidates`, action `MOVE_TO_PARSE_DLQ`).
- [x] **AC-07**: lien staleness↔parse exposé par issue.
- [x] **AC-08**: contrat stable livré:
  `{ allowed, reasonCode, reason, diagnostics, parseIssues, recommendations, dlqCandidates, correctiveActions }`.
- [x] **AC-09**: e2e UI états `empty/loading/error/success` + reason/counters/issues/reco/dlq/actions.
- [x] **AC-10**: qualité/perf module conforme (coverage >=95/95, p95 <= 2s, lot < 60s sur 500 docs).

## Implémentation S022
### Fichiers touchés (strict S022)
- `app/src/artifact-parse-diagnostics.js`
- `app/src/index.js` (export S022 uniquement)
- `app/tests/unit/artifact-parse-diagnostics.test.js`
- `app/tests/edge/artifact-parse-diagnostics.edge.test.js`
- `app/tests/e2e/artifact-parse-diagnostics.spec.js`
- `_bmad-output/implementation-artifacts/stories/S022.md`
- `_bmad-output/implementation-artifacts/handoffs/S022-dev-to-uxqa.md`
- `_bmad-output/implementation-artifacts/handoffs/S022-dev-to-tea.md`
- `_bmad-output/implementation-artifacts/handoffs/S022-tech-gates.log`

### Résumé fonctionnel
1. Nouveau module `buildArtifactParseDiagnostics(input, options?)`.
2. Résolution source canonique:
   - `stalenessResult` prioritaire,
   - sinon délégation S021 via `stalenessInput` (`buildArtifactStalenessIndicator`),
   - sinon fail-closed `INVALID_PARSE_DIAGNOSTIC_INPUT`.
3. Diagnostic parse par artefact (`parseStage`, `errorType`, `errorLocation`, `recommendedFix`).
4. Politique retries bornée (`maxRetries <= 3`) + reason codes dédiés:
   - `ARTIFACT_PARSE_FAILED` (erreurs récupérables),
   - `PARSE_RETRY_LIMIT_REACHED` (borne atteinte),
   - `PARSE_DLQ_REQUIRED` (DLQ obligatoire).
5. `dlqCandidates` + recommandations + `correctiveActions` actionnables.
6. Enrichissement `stalenessContext` par issue parse (`isStale`, `ageSeconds`, `stalenessLevel`).
7. Diagnostics complets (`artifactsChecked`, `parseErrorCount`, `retryScheduledCount`, `dlqCount`, `durationMs`, `p95ParseDiagMs`, `sourceReasonCode`).

## Mapping AC → tests
- AC-01..AC-08 + AC-10:
  - `app/tests/unit/artifact-parse-diagnostics.test.js`
  - `app/tests/edge/artifact-parse-diagnostics.edge.test.js`
- AC-09:
  - `app/tests/e2e/artifact-parse-diagnostics.spec.js`

## Couverture/performance S022
- `app/src/artifact-parse-diagnostics.js`:
  - **100.00% lines**
  - **99.41% branches**
  - **97.56% functions**
  - **99.48% statements**
- Perf (test synthétique 500 docs):
  - `p95ParseDiagMs <= 2000`
  - `durationMs < 60000`

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/artifact-parse-diagnostics.test.js tests/edge/artifact-parse-diagnostics.edge.test.js`
4. `npx playwright test tests/e2e/artifact-parse-diagnostics.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests cas limites (edge)
- [x] coverage >= seuil
- [x] security scan dépendances
- [x] build

## Status
READY_FOR_UXQA_TEA
