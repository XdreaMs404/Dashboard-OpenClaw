# S028 - Blocage DONE si sous-gate non PASS

canonical_story_id: E03-S04
epic: E03
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Handoff courant
H12 PM -> DEV (pack story prêt pour H13)

## Scope canonique
- Story ID canonique: `E03-S04`
- FR clés: FR-014, FR-015
- NFR clés: NFR-029, NFR-031
- Risques: U03, T07
- Dépendance story: E03-S03

## User story
En tant qu’orchestrateur BMAD,
je veux bloquer automatiquement toute transition vers DONE tant que les sous-gates critiques ne sont pas PASS et qu’aucune preuve primaire valide n’est liée,
afin d’éliminer les faux DONE et de garantir une chaîne de preuve complète et auditable.

## Dépendances
- **S027** (`calculateGateVerdict`) : source de vérité du verdict gate + signal `canMarkDone`.
- **S026** (`evaluateG4DualCorrelation`) : source duale G4-T/G4-UX.
- **S025** (`buildGateCenterStatus`) : statut/owner/timestamps des gates.
- **Planning canonique** : `epics.md` section `E03-S04`.
- **PRD** : FR-014, FR-015, AC-014/015, NFR-029, NFR-031.

## Traçabilité
- **FR-014**: interdire DONE si G4-T ou G4-UX n’est pas PASS.
- **FR-015**: exiger au moins une preuve primaire liée pour toute décision de gate.
- **NFR-029**: chaîne de preuve complète obligatoire.
- **NFR-031**: 100% widgets critiques avec 4 états UI.
- **Risques couverts**: U03 (non-conformité accessibilité), T07 (faux DONE via G4-UX).

## Critères d’acceptation (mesurables)
- [ ] **AC-01 (FR-014) — Blocage DONE sur sous-gate non PASS**
      Si `G4-T` != PASS ou `G4-UX` != PASS, la transition DONE est refusée:
  - `allowed=false`
  - `reasonCode="DONE_TRANSITION_BLOCKED"`
  - `canMarkDone=false`
  - `correctiveActions` inclut `BLOCK_DONE_TRANSITION`.

- [ ] **AC-02 (FR-014) — Autorisation DONE uniquement sur PASS/PASS**
      Si `G4-T=PASS` et `G4-UX=PASS` et entrée valide,
      alors `allowed=true`, `reasonCode="OK"`, `canMarkDone=true`.

- [ ] **AC-03 (FR-015/NFR-029) — Preuve primaire obligatoire**
      Si preuve primaire absente/incomplète pour une décision gate:
  - `allowed=false`
  - `reasonCode="EVIDENCE_CHAIN_INCOMPLETE"`
  - action corrective explicite `LINK_PRIMARY_EVIDENCE`.

- [ ] **AC-04 — Résolution des sources stricte**
  - `gateVerdictResult` injecté -> utilisé tel quel
  - sinon `gateVerdictInput` -> délégation à S027
  - sinon `INVALID_DONE_TRANSITION_INPUT`.

- [ ] **AC-05 — Propagation stricte des blocages amont**
      Les reason codes bloquants de S027/S026/S025 sont propagés sans réécriture (fail-closed).

- [ ] **AC-06 — Contrat de sortie stable**
      La sortie respecte systématiquement:
      `{ allowed, reasonCode, reason, diagnostics, canMarkDone, targetState, blockingSubGates, correctiveActions }`.

- [ ] **AC-07 — Diagnostics minimaux obligatoires**
      `diagnostics` contient au minimum:
      `targetState`, `g4tStatus`, `g4uxStatus`, `evidenceCount`, `sourceReasonCode`, `durationMs`, `p95GuardMs`.

- [ ] **AC-08 (NFR-031) — E2E UI 4 états**
      États `empty/loading/error/success` couverts avec affichage explicite de:
      `reasonCode`, `reason`, `canMarkDone`, `blockingSubGates`, `correctiveActions`.

- [ ] **AC-09 — Robustesse anti-contournement**
      Aucune transition DONE ne doit passer en cas d’incohérence duale G4 (`G4_SUBGATE_MISMATCH` / `G4_SUBGATES_UNSYNC`).

- [ ] **AC-10 — Qualité module**
      Couverture `done-transition-guard` >= 95% lignes + 95% branches.

## Cas de test obligatoires
### Fonctionnels
- [ ] DONE refusé si `G4-UX=FAIL`.
- [ ] DONE refusé si `G4-T=CONCERNS`.
- [ ] DONE autorisé uniquement si `G4-T=PASS` et `G4-UX=PASS` avec preuve primaire valide.
- [ ] DONE refusé si preuve primaire manquante (`EVIDENCE_CHAIN_INCOMPLETE`).
- [ ] Propagation blocage amont (ex: `INVALID_G4_DUAL_INPUT`).
- [ ] Délégation S027 depuis `gateVerdictInput`.

### Non-régression
- [ ] Contrat public S027 inchangé.
- [ ] Contrat public S026/S025 inchangé.
- [ ] Suites existantes S001..S027 restent vertes.

### Sécurité / robustesse
- [ ] Validation stricte des entrées (targetState/evidence payload).
- [ ] Aucun bypass de blocage DONE par payload partiel.
- [ ] Aucune exécution shell dans le module S028.

## Scope DEV strict S028
### Autorisé
1. Implémenter/ajuster `evaluateDoneTransitionGuard(input, options?)` dans `app/src/done-transition-guard.js`.
2. Exporter S028 dans `app/src/index.js` (export S028 uniquement).
3. Ajouter/adapter les tests S028:
   - `app/tests/unit/done-transition-guard.test.js`
   - `app/tests/edge/done-transition-guard.edge.test.js`
   - `app/tests/e2e/done-transition-guard.spec.js`
4. Mettre à jour les handoffs DEV S028:
   - `_bmad-output/implementation-artifacts/handoffs/S028-dev-to-uxqa.md`
   - `_bmad-output/implementation-artifacts/handoffs/S028-dev-to-tea.md`

### Interdit (hors-scope)
- Toute implémentation du moteur de verdict global (S027) hors intégration minimale.
- Toute implémentation d’exigences FR-016+ (stories suivantes E03-S05+).
- Tout refactor transverse non requis par AC S028.

## Contraintes
- Scope strict S028 uniquement.
- Fail-closed par défaut sur toute ambiguïté de verdict/preuve.
- DONE interdit tant que G4-T/G4-UX non PASS.
- Story non-DONE tant que G4-T et G4-UX ne sont pas tous deux PASS **et** preuve primaire valide.

## Plan de preuve / gates
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/done-transition-guard.test.js tests/edge/done-transition-guard.edge.test.js`
4. `npx playwright test tests/e2e/done-transition-guard.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`
7. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-story-gates.sh S028`
8. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-ux-gates.sh S028`

## Checklist Delivery
- [ ] Implémentation conforme au scope canonique
- [ ] Tests unit/intégration
- [ ] Tests edge
- [ ] Tests e2e
- [ ] Coverage >= seuil
- [ ] Security scan dépendances
- [ ] Build
- [ ] Audit UX PASS

## Handoff explicite vers DEV (H13)
- DEV implémente strictement S028 selon ce pack.
- Toute divergence de scope => retour PM obligatoire avant modification.
- Sortie attendue DEV: handoffs `S028-dev-to-uxqa.md` et `S028-dev-to-tea.md` avec preuves complètes.

## Status
READY_FOR_DEV
