# S028 - Blocage DONE si sous-gate non PASS

canonical_story_id: E03-S04
epic: E03
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Scope canonique
- Story ID canonique: `E03-S04`
- FR clés: FR-014, FR-015
- NFR clés: NFR-029, NFR-031
- Risques: U03, T07
- Dépendance story: E03-S03

## Checklist Delivery
- [x] Implémentation conforme au scope canonique
- [x] Tests unit/intégration
- [x] Tests edge
- [x] Tests e2e
- [x] Coverage >= seuil
- [x] Security scan dépendances
- [x] Build
- [x] Audit UX prêt pour revue

## Critères d’acceptation S028
- [x] **AC-01 / FR-014**: DONE interdit si `G4-T` ou `G4-UX` n’est pas `PASS`.
- [x] **AC-02 / FR-015**: preuve primaire obligatoire pour autoriser DONE.
- [x] **AC-03 / NFR-029**: chaîne de preuve complète, fail-closed si incomplète.
- [x] **AC-04 / NFR-031**: widget critique avec 4 états (`empty/loading/error/success`) vérifié en e2e.
- [x] **AC-05**: résolution source stricte (`gateVerdictResult` prioritaire, sinon délégation S027 via `gateVerdictInput`).
- [x] **AC-06**: propagation stricte des blocages amont S027 autorisés.
- [x] **AC-07**: contrat stable livré:
  `{ allowed, reasonCode, reason, diagnostics, doneTransition, correctiveActions }`.
- [x] **AC-08**: qualité/perf module `done-transition-guard` >=95% lignes/branches + p95 <=2s.

## Implémentation S028
### Fichiers touchés (strict S028)
- `app/src/done-transition-guard.js`
- `app/src/index.js` (export S028)
- `app/tests/unit/done-transition-guard.test.js`
- `app/tests/edge/done-transition-guard.edge.test.js`
- `app/tests/e2e/done-transition-guard.spec.js`
- `_bmad-output/implementation-artifacts/stories/S028.md`
- `_bmad-output/implementation-artifacts/handoffs/S028-dev-to-uxqa.md`
- `_bmad-output/implementation-artifacts/handoffs/S028-dev-to-tea.md`

### Résumé fonctionnel
1. Nouveau module `guardDoneTransition(input, options?)`.
2. Source stricte:
   - `gateVerdictResult` injecté prioritaire.
   - sinon délégation S027 via `calculateGateVerdict(gateVerdictInput)`.
   - sinon `INVALID_DONE_TRANSITION_INPUT`.
3. Propagation fail-closed des reason codes bloquants amont S027 (ex. `G4_SUBGATES_UNSYNC`).
4. Blocage DONE explicite:
   - verdict non `PASS` => `DONE_TRANSITION_BLOCKED` + `BLOCK_DONE_TRANSITION`.
   - `G4-T` ou `G4-UX` non `PASS` => `DONE_TRANSITION_BLOCKED`.
   - `canMarkDone=false` amont => blocage conservé.
5. Chaîne de preuve:
   - seuil minimal configurable (`minEvidenceCount`, défaut 1).
   - absence de preuve primaire => `EVIDENCE_CHAIN_INCOMPLETE` + `LINK_PRIMARY_EVIDENCE`.
6. Diagnostics livrés:
   - `targetState`, `verdict`, `canMarkDone`, `g4tStatus`, `g4uxStatus`, `evidenceCount`, `durationMs`, `p95GuardMs`, `sourceReasonCode`.

## Mapping AC -> tests
- AC-01, AC-02, AC-03, AC-05, AC-06, AC-07, AC-08:
  - `app/tests/unit/done-transition-guard.test.js`
  - `app/tests/edge/done-transition-guard.edge.test.js`
- AC-04 (NFR-031 états widget 4 états + responsive):
  - `app/tests/e2e/done-transition-guard.spec.js`

## Couverture/performance S028
- `app/src/done-transition-guard.js`:
  - **99.34% statements**
  - **96.06% branches**
  - **96.00% functions**
  - **100% lines**
- Perf synthétique:
  - `p95GuardMs <= 2000` validé (stream 500 évaluations).

## Vérifications DEV exécutées
1. `npm run lint && npm run typecheck` ✅
2. `npx vitest run tests/unit/done-transition-guard.test.js tests/edge/done-transition-guard.edge.test.js` ✅
3. `npx playwright test tests/e2e/done-transition-guard.spec.js` ✅
4. `npx vitest run tests/unit/done-transition-guard.test.js tests/edge/done-transition-guard.edge.test.js --coverage --coverage.include=src/done-transition-guard.js` ✅
5. `npm run build && npm run security:deps` ✅
6. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-fast-quality-gates.sh S028` ✅

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/done-transition-guard.test.js tests/edge/done-transition-guard.edge.test.js`
4. `npx playwright test tests/e2e/done-transition-guard.spec.js`
5. `npx vitest run tests/unit/done-transition-guard.test.js tests/edge/done-transition-guard.edge.test.js --coverage --coverage.include=src/done-transition-guard.js`
6. `npm run build && npm run security:deps`
7. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-fast-quality-gates.sh S028`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests edge
- [x] coverage >= seuil
- [x] fast quality gates S028

## Status
READY_FOR_UXQA_TEA
