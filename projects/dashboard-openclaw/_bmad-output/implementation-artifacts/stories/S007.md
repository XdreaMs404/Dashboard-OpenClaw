# S007 - Exécution contrôlée des guards de phase (sequence-guard + ultra-quality-check)

## Epic
E01

## User story
En tant qu’orchestrateur BMAD,
je veux exécuter de façon contrôlée les scripts `phase13-sequence-guard.sh` et `phase13-ultra-quality-check.sh`,
afin de sécuriser les validations de phase avec un flux explicable (simulation, exécution, diagnostics, blocage traçable).

## Dépendances
- S002 (validateur de transition canonique + SLA notification) = source de vérité des blocages de transition.
- S004 (validation prérequis obligatoires) = précondition métier avant exécution des guards.

## Traçabilité
- FR-006: exécution contrôlée des scripts `sequence-guard` et `ultra-quality-check`.
- FR-005 (réutilisation): ne jamais exécuter les guards si les prérequis phase ne sont pas validés.
- NFR-011: fiabilité opérationnelle cible >= 99.5% (séquence déterministe + erreurs explicites).
- NFR-040: time-to-first-value < 14 jours (API simple + preuves de test rapides).
- Risques couverts: P01, P07.

## Critères d'acceptation
- [x] AC-01 (Nominal / simulation): pour `phaseNumber` dans `1|2|3` et prérequis validés (`S004.allowed=true`), `orchestratePhaseGuards` retourne `allowed: true`, `reasonCode: "OK"`, et un plan ordonné de commandes:
  1) `bash /root/.openclaw/workspace/bmad-total/scripts/phase13-sequence-guard.sh <phaseNumber>`
  2) `bash /root/.openclaw/workspace/bmad-total/scripts/phase13-ultra-quality-check.sh <phaseNumber>`
  sans exécution réelle quand `simulate=true` (valeur par défaut).
- [x] AC-02 (Blocage transition/prérequis propagé): si la validation S004 renvoie `allowed=false`, l’orchestrateur renvoie `allowed=false` et propage strictement le même `reasonCode` + `reason`.
- [x] AC-03 (Phase invalide): si `phaseNumber` n’est pas `1`, `2` ou `3`, le résultat est `allowed=false`, `reasonCode: "INVALID_GUARD_PHASE"`, sans exécution de commande.
- [x] AC-04 (Exécution contrôlée): quand `simulate=false`, les commandes sont exécutées séquentiellement via un exécuteur injecté; en cas d’échec d’une commande, l’exécution s’arrête immédiatement et le résultat est `allowed=false`, `reasonCode: "GUARD_EXECUTION_FAILED"` avec `diagnostics.failedCommand`.
- [x] AC-05 (Contrat stable): la fonction retourne systématiquement
  `{ allowed, reasonCode, reason, diagnostics, commands, results }`
  avec:
  - `reasonCode` dans
    `OK | INVALID_PHASE | TRANSITION_NOT_ALLOWED | PHASE_NOTIFICATION_MISSING | PHASE_NOTIFICATION_SLA_EXCEEDED | PHASE_PREREQUISITES_MISSING | PHASE_PREREQUISITES_INCOMPLETE | INVALID_PHASE_PREREQUISITES | INVALID_GUARD_PHASE | GUARD_EXECUTION_FAILED`
  - `diagnostics` contenant au minimum `phaseNumber`, `simulate`, `blockedByPrerequisites`, `executedCount`, `failedCommand`.
- [x] AC-06 (UI e2e): démonstrateur minimal couvrant les états `empty`, `loading`, `success`, `error` avec affichage explicite de `reasonCode`, `reason`, des commandes planifiées et du détail d’échec éventuel.
- [x] AC-07 (Seuil qualité): couverture du module S007 >= 95% (lignes + branches).

## Cas de test obligatoires
### Fonctionnels
- [x] Cas nominal simulation: `phaseNumber=2`, prérequis valides, `simulate=true` => plan de 2 commandes, `executedCount=0`, `reasonCode=OK`.
- [x] Cas nominal exécution: `phaseNumber=1`, `simulate=false`, exécuteur injecté succès sur 2 commandes => `allowed=true`, `executedCount=2`, résultats ordonnés.
- [x] Cas blocage S004 propagé: prérequis incomplets (`PHASE_PREREQUISITES_INCOMPLETE`) => blocage strictement propagé.
- [x] Cas phase invalide: `phaseNumber=4` ou `"H03"` => `INVALID_GUARD_PHASE`.
- [x] Cas erreur exécution: 1ère ou 2ème commande échoue => `GUARD_EXECUTION_FAILED` + `failedCommand` renseigné + arrêt séquentiel.
- [x] Cas UI e2e: parcours `empty -> loading -> error/success` avec rendu explicite du plan et des diagnostics.

### Non-régression
- [x] `validatePhaseTransition` (S002) conserve son contrat et reason codes.
- [x] `buildPhaseStateProjection` (S003) conserve son contrat stable.
- [x] `validatePhasePrerequisites` (S004) conserve son contrat stable.
- [x] Les suites unit/edge/e2e existantes restent vertes.

### Sécurité / robustesse
- [x] Allowlist stricte des commandes exécutable par S007 (exactement CMD-008/CMD-009).
- [x] Aucune concaténation shell non contrôlée; paramètre phase normalisé (`1|2|3` uniquement).
- [x] Aucune mutation observable des objets d’entrée.
- [x] Messages de blocage explicites, actionnables, et exploitables en UI.

## Contraintes
- Scope strict S007: pas de modification produit hors FR-006.
- Réutiliser S004 comme garde d’entrée obligatoire (pas de contournement des prérequis).
- Exécution par défaut en mode simulation (`simulate=true`) pour respecter le contrôle avant write.
- Story non-DONE tant que G4-T et G4-UX ne sont pas tous deux PASS.

## Implémentation
### Réalisé (DEV)
1. Création de `app/src/phase-guards-orchestrator.js` avec API publique `orchestratePhaseGuards(input, options?)`.
2. Réutilisation explicite de S004 via:
   - `prerequisitesValidation` injecté,
   - ou délégation à `validatePhasePrerequisites` via `prerequisitesInput`.
3. Planification stricte (ordre fixe + allowlist):
   - `CMD-008`: `bash /root/.openclaw/workspace/bmad-total/scripts/phase13-sequence-guard.sh <phaseNumber>`
   - `CMD-009`: `bash /root/.openclaw/workspace/bmad-total/scripts/phase13-ultra-quality-check.sh <phaseNumber>`
4. Exécution contrôlée implémentée:
   - `simulate=true` par défaut,
   - exécuteur injecté (`commandExecutor`) pour tests déterministes,
   - runner shell injecté (`execRunner`) pour validation robuste du chemin par défaut,
   - arrêt immédiat sur premier échec avec `reasonCode=GUARD_EXECUTION_FAILED` + `diagnostics.failedCommand`.
5. Contrat de sortie stable livré:
   `{ allowed, reasonCode, reason, diagnostics, commands, results }`.
6. Export public ajouté dans `app/src/index.js`: `orchestratePhaseGuards`.
7. Ajout des tests S007:
   - `app/tests/unit/phase-guards-orchestrator.test.js`
   - `app/tests/edge/phase-guards-orchestrator.edge.test.js`
   - `app/tests/e2e/phase-guards-orchestrator.spec.js`
8. Démonstrateur e2e S007 avec états `empty/loading/error/success`, rendu explicite `reasonCode/reason/commands/failedCommand/failedResult` + vérification responsive (mobile/tablette/desktop sans overflow).
9. Revalidation DEV exécutée via `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash scripts/run-quality-gates.sh` (lint/typecheck/test/test:e2e/test:edge/test:coverage/security/build) = PASS.

## Review
- [x] Mapping AC → tests documenté et complet.
- [x] Vérification explicite de la propagation des reason codes S002/S004.
- [x] Vérification coverage module >= 95% lignes + branches.
- [x] Résultat gates techniques publié (PASS/CONCERNS/FAIL).

### Mapping AC → tests
- AC-01/03/04/05: `app/tests/unit/phase-guards-orchestrator.test.js`, `app/tests/edge/phase-guards-orchestrator.edge.test.js`
- AC-02 (propagation stricte S004): `app/tests/unit/phase-guards-orchestrator.test.js`, `app/tests/edge/phase-guards-orchestrator.edge.test.js`
- AC-06 (UI e2e): `app/tests/e2e/phase-guards-orchestrator.spec.js`
- AC-07 (coverage module): `app/src/phase-guards-orchestrator.js` = **100% lines**, **100% branches** (`npm run test:coverage`)

### Gates techniques (DEV)
- `npm run lint` ✅
- `npm run typecheck` ✅
- `npx vitest run tests/unit tests/edge` ✅ (95 tests)
- `npx playwright test tests/e2e` ✅ (9 tests)
- `npm run test:coverage` ✅
- `npm run build` ✅
- `npm run security:deps` ✅ (0 vulnérabilité)
- Revalidation DEV (2026-02-21T13:04:48Z): `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash scripts/run-quality-gates.sh` = ✅ (`lint`, `typecheck`, `test`, `test:e2e`, `test:edge`, `test:coverage`, `security`, `build`)
- Verdict technique DEV: **PASS**

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit tests/edge`
4. `npx playwright test tests/e2e`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`


## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests cas limites (edge)
- [x] coverage >= seuil
- [x] security scan dépendances
- [x] build

## Règle Story DONE
- Interdit de passer DONE si un seul gate échoue (technique OU UX).
- Audit UX obligatoire: `_bmad-output/implementation-artifacts/ux-audits/<SID>-ux-audit.json` avec verdict PASS.
- Utiliser `bash scripts/story-done-guard.sh <SID>` pour valider la fin.

## UX Gates obligatoires
- [ ] conformité design-system (tokens, spacing, typo, composants)
- [ ] accessibilité WCAG 2.2 AA (minimum)
- [ ] responsive (mobile/tablet/desktop)
- [ ] états d'interface (loading/empty/error/success)
- [ ] hiérarchie visuelle et lisibilité
- [ ] evidence UX fournie (captures/rapports)

## Status
- Dernière revalidation DEV (UTC): 2026-02-21T13:04:48Z
READY_FOR_REVIEW
