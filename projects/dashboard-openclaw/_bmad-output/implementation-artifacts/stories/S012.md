# S012 - Validator metadata stepsCompleted + inputDocuments (FR-022/FR-023)

## Epic
E02

## Handoff courant
H13 PM → DEV (scope strict S012)

## User story
En tant qu’orchestrateur BMAD,
je veux valider de manière explicite et traçable les métadonnées obligatoires (`stepsCompleted`, `inputDocuments`) des artefacts ingérés,
afin d’empêcher l’indexation de preuves incomplètes et de préparer la navigation structurée des artefacts.

## Dépendances
- **S011** (`ingestBmadArtifacts`) : socle ingestion allowlist + parse markdown/yaml déjà livré.
- **Planning E02-S02** (`_bmad-output/planning-artifacts/epics.md`) : source de vérité story-level.
- **PRD** (`_bmad-output/planning-artifacts/prd.md`) : FR-022, FR-023, AC-022A/B, AC-023A/B, NFR-004, NFR-006.
- **Architecture** (`_bmad-output/planning-artifacts/architecture.md`) :
  - endpoint cible `/api/v1/artifacts/validate-metadata`,
  - projection cible `projection.artifact.metadata-compliance`,
  - événements cibles `artifact.metadata.missing`, `artifact.parsed.success`.

## Traçabilité
- **FR-022** : vérifier la présence et la validité de `stepsCompleted` et `inputDocuments`.
- **FR-023 (préparation)** : produire une sortie structurée exploitable par l’extracteur de sections H2/H3 (story suivante).
- **AC PRD** : AC-022A, AC-022B, AC-023A, AC-023B.
- **NFR-004** : p95 `< 2s` sur corpus de 500 documents.
- **NFR-006** : traitement lot complet `< 60s`.
- **Contraintes UX (H06)** : diagnostics explicites/actionnables + couverture des cas limites.
- **Risques couverts** : T02, T03.

## Critères d'acceptation (mesurables)
- [x] **AC-01 — Validation nominale metadata**
      Pour un lot d’artefacts `.md|.markdown|.yaml|.yml` sous allowlist avec metadata valide,
      `validateArtifactMetadataCompliance` retourne :
  - `allowed: true`
  - `reasonCode: "OK"`
  - `diagnostics.compliantCount = diagnostics.requestedCount`
  - `nonCompliantArtifacts: []`

- [x] **AC-02 — Détection metadata manquante**
      Si `stepsCompleted` ou `inputDocuments` est absent sur un artefact ciblé,
      la sortie retourne :
  - `allowed: false`
  - `reasonCode: "ARTIFACT_METADATA_MISSING"`
  - `nonCompliantArtifacts[*].missingFields` explicite les champs absents
  - `correctiveActions` contient `ADD_REQUIRED_METADATA`

- [x] **AC-03 — Détection metadata invalide**
      Si un champ existe mais ne respecte pas le contrat (tableau non vide de chaînes non vides),
      la sortie retourne :
  - `allowed: false`
  - `reasonCode: "ARTIFACT_METADATA_INVALID"`
  - `nonCompliantArtifacts[*].metadataErrors` explicite les violations
  - `correctiveActions` contient `FIX_INVALID_METADATA`

- [x] **AC-04 — Blocage hors allowlist**
      Si un artefact sort des racines autorisées,
      la sortie retourne `ARTIFACT_PATH_NOT_ALLOWED` sans exception non contrôlée.

- [x] **AC-05 — Blocage type non supporté**
      Si une extension hors `.md|.markdown|.yaml|.yml` est soumise,
      la sortie retourne `UNSUPPORTED_ARTIFACT_TYPE` avec raison explicite.

- [x] **AC-06 — Parse robuste markdown/yaml**
      Frontmatter markdown ou YAML invalide -> `ARTIFACT_PARSE_FAILED` localisé par artefact,
      sans crash global du lot.

- [x] **AC-07 — Résolution des sources de données**
  - `artifactDocuments` injecté : priorité 1.
  - sinon `artifactPaths` + `options.documentReader` : priorité 2.
  - aucune source exploitable : `INVALID_METADATA_VALIDATION_INPUT`.

- [x] **AC-08 — Contrat de sortie stable + préparation FR-023**
      La fonction retourne systématiquement :
      `{ allowed, reasonCode, reason, diagnostics, compliantArtifacts, nonCompliantArtifacts, correctiveActions }`
      avec :
  - `reasonCode` dans
    `OK | ARTIFACT_PATH_NOT_ALLOWED | UNSUPPORTED_ARTIFACT_TYPE | ARTIFACT_READ_FAILED | ARTIFACT_PARSE_FAILED | ARTIFACT_METADATA_MISSING | ARTIFACT_METADATA_INVALID | INVALID_METADATA_VALIDATION_INPUT`
  - `diagnostics` contient au minimum
    `requestedCount`, `validatedCount`, `compliantCount`, `nonCompliantCount`, `missingMetadataCount`, `invalidMetadataCount`, `allowlistRoots`, `durationMs`, `p95ValidationMs`
  - `compliantArtifacts[*].sectionExtractionEligible === true` (préparation S013)

- [x] **AC-09 — UI e2e démonstrateur minimal**
      Couvrir `empty`, `loading`, `success`, `error` avec affichage explicite :
  - `reasonCode`
  - `reason`
  - compteurs de conformité
  - `correctiveActions`

- [x] **AC-10 — Seuil qualité/performance module**
  - Couverture module S012 >= **95% lignes** et **95% branches**.
  - Benchmark corpus 500 docs :
    - `p95ValidationMs <= 2000`
    - durée lot complet `< 60000 ms`.

## Cas de test obligatoires
### Fonctionnels
- [x] Cas nominal: metadata valide sur lot complet -> `OK`.
- [x] Cas metadata manquante (`stepsCompleted` absent) -> `ARTIFACT_METADATA_MISSING`.
- [x] Cas metadata invalide (`inputDocuments` non tableau) -> `ARTIFACT_METADATA_INVALID`.
- [x] Cas hors allowlist -> `ARTIFACT_PATH_NOT_ALLOWED`.
- [x] Cas extension invalide (`.json`) -> `UNSUPPORTED_ARTIFACT_TYPE`.
- [x] Cas parse invalide (frontmatter/YAML cassé) -> `ARTIFACT_PARSE_FAILED`.
- [x] Cas source absente -> `INVALID_METADATA_VALIDATION_INPUT`.
- [x] Cas UI e2e: parcours `empty -> loading -> error/success` avec compteurs lisibles.

### Non-régression
- [x] `ingestBmadArtifacts` (S011) conserve son contrat public et ses reason codes.
- [x] Les suites S001..S011 restent vertes.
- [x] Aucun changement de comportement non requis hors scope S012.

### Sécurité / robustesse
- [x] Validation stricte des entrées (allowlist, chemins, payload, metadata).
- [x] Refus déterministe des chemins hors racines autorisées.
- [x] Aucune exécution shell dans S012.
- [x] Aucune mutation observable des entrées.

## Scope DEV strict S012
### Autorisé
1. Implémenter `validateArtifactMetadataCompliance(input, options?)` dans `app/src/artifact-metadata-validator.js`.
2. Exporter S012 dans `app/src/index.js` (export S012 uniquement).
3. Ajouter/adapter les tests S012:
   - `app/tests/unit/artifact-metadata-validator.test.js`
   - `app/tests/edge/artifact-metadata-validator.edge.test.js`
   - `app/tests/e2e/artifact-metadata-validator.spec.js`
4. Ajuster **minimalement** `app/src/artifact-ingestion-pipeline.js` uniquement si nécessaire pour partage utilitaire sans changement de comportement S011.
5. Mettre à jour la story S012 + handoffs DEV (`S012-dev-to-uxqa.md`, `S012-dev-to-tea.md`) avec preuves d’exécution.

### Interdit (hors-scope)
- Toute évolution hors FR-022/FR-023 / S012.
- Toute modification fonctionnelle des stories S001..S011 non strictement nécessaire à l’intégration S012.
- Tout refactor transverse non requis par les AC S012.
- Toute exécution shell depuis les modules S012.

## Contraintes
- Allowlist stricte obligatoire avant toute validation metadata.
- Extensions autorisées strictes: `.md`, `.markdown`, `.yaml`, `.yml`.
- Champs obligatoires stricts: `stepsCompleted`, `inputDocuments` (tableaux non vides de chaînes non vides).
- Contrat de sortie déterministe et reason codes stables.
- Story non-DONE tant que **G4-T** et **G4-UX** ne sont pas tous deux PASS.

## Implémentation
### Réalisé (DEV)
1. Création de `app/src/artifact-metadata-validator.js` avec API `validateArtifactMetadataCompliance(input, options?)`.
2. Résolution des sources conforme PM:
   - `artifactDocuments` prioritaire,
   - sinon `artifactPaths` + `options.documentReader`,
   - sinon `INVALID_METADATA_VALIDATION_INPUT`.
3. Implémentation allowlist stricte + extensions supportées avec reason codes déterministes.
4. Implémentation parse markdown/yaml robuste (frontmatter markdown + YAML simple), erreurs localisées `ARTIFACT_PARSE_FAILED`.
5. Implémentation validation explicite des metadata obligatoires sur artefacts ciblés (`targetArtifactNames` / alias `majorArtifactNames`):
   - détection manquants `ARTIFACT_METADATA_MISSING` + `missingFields`,
   - détection invalides `ARTIFACT_METADATA_INVALID` + `metadataErrors`.
6. Contrat de sortie stable livré:
   `{ allowed, reasonCode, reason, diagnostics, compliantArtifacts, nonCompliantArtifacts, correctiveActions }`.
7. Préparation FR-023 intégrée: `compliantArtifacts[*].sectionExtractionEligible = true`.
8. Export S012 ajouté dans `app/src/index.js` (`validateArtifactMetadataCompliance`).
9. Tests S012 ajoutés/renforcés:
   - `app/tests/unit/artifact-metadata-validator.test.js`
   - `app/tests/edge/artifact-metadata-validator.edge.test.js`
   - `app/tests/e2e/artifact-metadata-validator.spec.js`

## Review
- [x] Mapping AC → tests documenté.
- [x] Vérification explicite des seuils performance NFR-004/NFR-006.
- [x] Vérification couverture module >= 95% lignes + branches.
- [x] Résultat gates techniques publié (PASS/CONCERNS/FAIL).

### Mapping AC → tests
- AC-01/02/03/04/05/06/07/08/10: `app/tests/unit/artifact-metadata-validator.test.js`, `app/tests/edge/artifact-metadata-validator.edge.test.js`
- AC-09: `app/tests/e2e/artifact-metadata-validator.spec.js`
- AC-10 coverage: `npm run test:coverage` (S012 `artifact-metadata-validator.js` = **98.45% lines**, **95.21% branches**)
- AC-10 performance (500 docs): test unitaire dédié (`p95ValidationMs <= 2000`, durée `< 60000`)

### Gates techniques (DEV)
Commande de revalidation exécutée depuis `app/` (UTC 2026-02-21T23:12:40Z):
`npm run lint && npm run typecheck && npx vitest run tests/unit tests/edge && npx playwright test tests/e2e && npm run test:coverage && npm run build && npm run security:deps` ✅

Résultats observés:
- `npm run lint` ✅
- `npm run typecheck` ✅
- `npx vitest run tests/unit tests/edge` ✅ (**24 fichiers / 283 tests passés**)
- `npx playwright test tests/e2e` ✅ (**23/23 tests passés**)
- `npm run test:coverage` ✅
  - global: **99.46% statements / 97.82% branches / 100% functions / 99.45% lines**
  - module S012 `app/src/artifact-metadata-validator.js`: **98.51% statements / 95.21% branches / 100% functions / 98.45% lines**
- `npm run build` ✅
- `npm run security:deps` ✅ (`npm audit --audit-level=high`: **0 vulnérabilité**)
- Verdict technique DEV: **PASS**

### Revalidation PM (H13)
- Revalidation cadrage S012 effectuée (UTC 2026-02-21T23:18:00Z).
- Scope strict S012 confirmé, sans extension hors FR-022/FR-023.
- Handoff PM→DEV confirmé prêt: `_bmad-output/implementation-artifacts/handoffs/S012-pm-to-dev.md`.

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/artifact-metadata-validator.test.js tests/edge/artifact-metadata-validator.edge.test.js`
4. `npx playwright test tests/e2e/artifact-metadata-validator.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests cas limites (edge)
- [x] coverage >= seuil
- [x] security scan dépendances
- [x] build

## Règle Story DONE
- Interdit de passer DONE si un seul gate échoue (technique OU UX).
- Audit UX obligatoire: `_bmad-output/implementation-artifacts/ux-audits/<SID>-ux-audit.json` avec verdict PASS.
- Utiliser `bash scripts/story-done-guard.sh <SID>` pour valider la fin.

## UX Gates obligatoires
- [x] conformité design-system (tokens, spacing, typo, composants)
- [x] accessibilité WCAG 2.2 AA (minimum)
- [x] responsive (mobile/tablet/desktop)
- [x] états d'interface (loading/empty/error/success)
- [x] hiérarchie visuelle et lisibilité
- [x] evidence UX fournie (captures/rapports)

## Status
- Dernière revalidation DEV (UTC): 2026-02-21T23:12:40Z
- Dernière validation UX (UTC): 2026-02-21T23:22:37Z
UX_AUDIT_PASS
READY_FOR_TEA
