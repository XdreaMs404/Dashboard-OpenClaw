# S012 - Validator metadata stepsCompleted + inputDocuments (FR-022/FR-023)

## Epic
E02

## Handoff courant
H13 PM → DEV (scope strict S012)

## User story
En tant qu’orchestrateur BMAD,
je veux valider de manière explicite les métadonnées obligatoires (`stepsCompleted`, `inputDocuments`) sur les artefacts ingérés,
afin de bloquer les preuves incomplètes et préparer une navigation structurée fiable des artefacts.

## Dépendances
- **S011** (`ingestBmadArtifacts`) : source de vérité ingestion allowlist + parse markdown/yaml.
- **Planning E02-S02** (`_bmad-output/planning-artifacts/epics.md`) : story canonique FR-022/FR-023.
- **PRD** (`_bmad-output/planning-artifacts/prd.md`) : FR-022, FR-023, AC-022A/B, AC-023A/B, NFR-004, NFR-006.
- **Architecture** (`_bmad-output/planning-artifacts/architecture.md`) : endpoint `/api/v1/artifacts/validate-metadata`, projection `projection.artifact.metadata-compliance`.

## Traçabilité
- **FR-022** : vérifier la présence de `stepsCompleted` et `inputDocuments` sur les artefacts majeurs.
- **FR-023 (préparation)** : produire une sortie exploitable par l’extracteur sections H2/H3.
- **NFR-004** : p95 `< 2s` sur 500 docs.
- **NFR-006** : lot complet `< 60s`.
- **Risques couverts** : T02, T03.

## Critères d'acceptation (mesurables)
- [x] **AC-01 — Validation nominale metadata**
      Pour un lot `.md|.markdown|.yaml|.yml` sous allowlist avec metadata valide, `validateArtifactMetadataCompliance` retourne:
  - `allowed: true`
  - `reasonCode: "OK"`
  - `diagnostics.compliantCount = diagnostics.requestedCount`
  - `nonCompliantArtifacts: []`

- [x] **AC-02 — Détection metadata manquante**
      Si `stepsCompleted` ou `inputDocuments` est absent sur un artefact ciblé:
  - `allowed: false`
  - `reasonCode: "ARTIFACT_METADATA_MISSING"`
  - `nonCompliantArtifacts[*].missingFields` explicite les champs manquants
  - `correctiveActions` contient `ADD_REQUIRED_METADATA`

- [x] **AC-03 — Détection metadata invalide**
      Si un champ metadata existe mais ne respecte pas le contrat (tableau non vide de chaînes non vides):
  - `allowed: false`
  - `reasonCode: "ARTIFACT_METADATA_INVALID"`
  - `nonCompliantArtifacts[*].metadataErrors` explicite les violations
  - `correctiveActions` contient `FIX_INVALID_METADATA`

- [x] **AC-04 — Blocage hors allowlist**
      Si un artefact sort des racines autorisées:
  - `reasonCode: "ARTIFACT_PATH_NOT_ALLOWED"`
  - aucune exception non contrôlée

- [x] **AC-05 — Blocage extension non supportée**
      Si extension hors `.md|.markdown|.yaml|.yml`:
  - `reasonCode: "UNSUPPORTED_ARTIFACT_TYPE"`
  - diagnostic explicite par artefact

- [x] **AC-06 — Parse robuste markdown/yaml**
      Frontmatter markdown ou YAML invalide:
  - `reasonCode: "ARTIFACT_PARSE_FAILED"` localisé par artefact
  - aucun crash global du lot

- [x] **AC-07 — Résolution de sources flexible**
  - `artifactDocuments` injecté -> utilisé en priorité
  - sinon `artifactPaths` + `options.documentReader` -> lecture contrôlée
  - source absente -> `INVALID_METADATA_VALIDATION_INPUT`

- [x] **AC-08 — Contrat de sortie stable + préparation FR-023**
      La fonction retourne systématiquement:
      `{ allowed, reasonCode, reason, diagnostics, compliantArtifacts, nonCompliantArtifacts, correctiveActions }`
      avec:
  - `reasonCode` dans
    `OK | ARTIFACT_PATH_NOT_ALLOWED | UNSUPPORTED_ARTIFACT_TYPE | ARTIFACT_READ_FAILED | ARTIFACT_PARSE_FAILED | ARTIFACT_METADATA_MISSING | ARTIFACT_METADATA_INVALID | INVALID_METADATA_VALIDATION_INPUT`
  - `diagnostics` contient au minimum
    `requestedCount`, `validatedCount`, `compliantCount`, `nonCompliantCount`, `missingMetadataCount`, `invalidMetadataCount`, `allowlistRoots`, `durationMs`, `p95ValidationMs`
  - `compliantArtifacts[*].sectionExtractionEligible === true`

- [x] **AC-09 — UI e2e démonstrateur minimal**
      Couvrir `empty`, `loading`, `success`, `error` avec affichage explicite:
  - `reasonCode`
  - `reason`
  - compteurs de conformité
  - `correctiveActions`

- [x] **AC-10 — Seuil qualité/performance module**
  - Couverture module S012 >= **95% lignes** et **95% branches**
  - Benchmark 500 docs:
    - `p95ValidationMs <= 2000`
    - durée lot complet `< 60000 ms`

## Cas de test obligatoires
### Fonctionnels
- [x] Cas nominal metadata valide -> `OK`
- [x] Cas metadata manquante -> `ARTIFACT_METADATA_MISSING`
- [x] Cas metadata invalide -> `ARTIFACT_METADATA_INVALID`
- [x] Cas hors allowlist -> `ARTIFACT_PATH_NOT_ALLOWED`
- [x] Cas extension invalide -> `UNSUPPORTED_ARTIFACT_TYPE`
- [x] Cas parse invalide -> `ARTIFACT_PARSE_FAILED`
- [x] Cas source absente -> `INVALID_METADATA_VALIDATION_INPUT`
- [x] Cas UI e2e: `empty -> loading -> error/success`

### Non-régression
- [x] `ingestBmadArtifacts` (S011) conserve son contrat et ses reason codes
- [x] Les suites S001..S011 restent vertes
- [x] Aucun changement hors scope S012

### Sécurité / robustesse
- [x] Validation stricte des entrées (allowlist, paths, payloads, metadata)
- [x] Refus déterministe des chemins hors racines autorisées
- [x] Aucune exécution shell dans S012
- [x] Aucune mutation observable des entrées

## Scope DEV strict S012
### Autorisé
1. Implémenter `validateArtifactMetadataCompliance(input, options?)` dans `app/src/artifact-metadata-validator.js`
2. Exporter S012 dans `app/src/index.js` (export S012 uniquement)
3. Ajouter/adapter les tests S012:
   - `app/tests/unit/artifact-metadata-validator.test.js`
   - `app/tests/edge/artifact-metadata-validator.edge.test.js`
   - `app/tests/e2e/artifact-metadata-validator.spec.js`
4. Ajuster **minimalement** `app/src/artifact-ingestion-pipeline.js` uniquement si nécessaire au partage utilitaire, sans changement de comportement S011
5. Mettre à jour la story S012 + handoffs DEV (`S012-dev-to-uxqa.md`, `S012-dev-to-tea.md`) avec preuves d’exécution

### Interdit (hors-scope)
- Toute évolution hors FR-022/FR-023 / S012
- Toute modification fonctionnelle S001..S011 non strictement nécessaire à l’intégration S012
- Tout refactor transverse non requis par les AC S012
- Toute exécution shell depuis les modules S012

## Contraintes
- Allowlist stricte obligatoire avant validation metadata
- Extensions autorisées strictes: `.md`, `.markdown`, `.yaml`, `.yml`
- Champs obligatoires stricts: `stepsCompleted`, `inputDocuments` (tableaux non vides de chaînes non vides)
- Contrat de sortie déterministe et reason codes stables
- Story non-DONE tant que **G4-T** et **G4-UX** ne sont pas tous deux PASS

## Implémentation
### Réalisé (DEV)
1. Implémentation de `validateArtifactMetadataCompliance(input, options?)` dans `app/src/artifact-metadata-validator.js`.
2. Résolution des sources conforme au contrat:
   - `artifactDocuments` prioritaire,
   - sinon `artifactPaths` + `options.documentReader`,
   - sinon `INVALID_METADATA_VALIDATION_INPUT`.
3. Validation stricte:
   - allowlist racines,
   - extensions supportées,
   - parse markdown frontmatter + YAML,
   - metadata obligatoire pour artefacts ciblés (`stepsCompleted`, `inputDocuments`).
4. Diagnostics explicites et reason codes stables par artefact.
5. Contrat de sortie stable livré:
   `{ allowed, reasonCode, reason, diagnostics, compliantArtifacts, nonCompliantArtifacts, correctiveActions }`.
6. Préparation FR-023 intégrée: `compliantArtifacts[*].sectionExtractionEligible = true`.
7. Export S012 disponible via `app/src/index.js` (`validateArtifactMetadataCompliance`).
8. Tests S012 unit/edge/e2e opérationnels:
   - `app/tests/unit/artifact-metadata-validator.test.js`
   - `app/tests/edge/artifact-metadata-validator.edge.test.js`
   - `app/tests/e2e/artifact-metadata-validator.spec.js`

## Review
- [x] Mapping AC → tests documenté
- [x] Vérification explicite des seuils performance NFR-004/NFR-006
- [x] Vérification couverture module >= 95% lignes + branches
- [x] Résultat gates techniques publié (PASS/CONCERNS/FAIL)

### Mapping AC → tests
- AC-01/02/03/04/05/06/07/08/10: `app/tests/unit/artifact-metadata-validator.test.js`, `app/tests/edge/artifact-metadata-validator.edge.test.js`
- AC-09: `app/tests/e2e/artifact-metadata-validator.spec.js`
- AC-10 coverage: `npm run test:coverage` (S012 `artifact-metadata-validator.js` = **98.45% lines**, **95.21% branches**)
- AC-10 performance (500 docs): test unitaire dédié (`p95ValidationMs <= 2000`, durée `< 60000`)

### Gates techniques (DEV)
Commande de revalidation exécutée depuis `app/` (UTC 2026-02-22T09:37Z):
`npm run lint && npm run typecheck && npx vitest run tests/unit tests/edge && npx playwright test tests/e2e && npm run test:coverage && npm run build && npm run security:deps` ✅

Résultats observés:
- `npm run lint` ✅
- `npm run typecheck` ✅
- `npx vitest run tests/unit tests/edge` ✅ (**30 fichiers / 382 tests passés**)
- `npx playwright test tests/e2e` ✅ (**29/29 tests passés**)
- `npm run test:coverage` ✅
  - global: **99.34% statements / 97.86% branches / 100% functions / 99.32% lines**
  - module S012 `app/src/artifact-metadata-validator.js`: **98.51% statements / 95.21% branches / 100% functions / 98.45% lines**
- `npm run build` ✅
- `npm run security:deps` ✅ (`npm audit --audit-level=high`: **0 vulnérabilité**)
- Verdict technique DEV: **PASS**

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/artifact-metadata-validator.test.js tests/edge/artifact-metadata-validator.edge.test.js`
4. `npx playwright test tests/e2e/artifact-metadata-validator.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`


## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests cas limites (edge)
- [x] coverage >= seuil
- [x] security scan dépendances
- [x] build

## Règle Story DONE
- Interdit de passer DONE si un seul gate échoue (technique OU UX).
- Audit UX obligatoire: `_bmad-output/implementation-artifacts/ux-audits/<SID>-ux-audit.json` avec verdict PASS.
- Utiliser `bash scripts/story-done-guard.sh <SID>` pour valider la fin.

## UX Gates obligatoires
- [ ] conformité design-system (tokens, spacing, typo, composants)
- [ ] accessibilité WCAG 2.2 AA (minimum)
- [ ] responsive (mobile/tablet/desktop)
- [ ] états d'interface (loading/empty/error/success)
- [ ] hiérarchie visuelle et lisibilité
- [ ] evidence UX fournie (captures/rapports)

## Status
- Dernière revalidation DEV (UTC): 2026-02-22T09:38:19Z
READY_FOR_UX_AUDIT
READY_FOR_TEA
