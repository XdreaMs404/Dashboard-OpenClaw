# S012 - Journal décisionnel de gouvernance phase/gate

## Epic
E01

## Handoff courant
H13 PM → DEV (scope strict S012)

## User story
En tant qu’orchestrateur BMAD,
je veux journaliser chaque décision de gouvernance phase/gate avec contexte, raison et actions correctives,
afin de tracer strictement les blocages FR-002/FR-003 et d’exposer un historique consultable pour l’exploitation.

## Dépendances
- **S011** (`evaluatePhaseProgressionAlert`) : source de vérité des blocages progression phase.
- **S002** (`BMAD_PHASE_ORDER`) : référence canonique H01→H23.
- **Planning canonique E01-S12** (`_bmad-output/planning-artifacts/epics.md`) : AC/DoD story-level.
- **PRD** (`_bmad-output/planning-artifacts/prd.md`) : FR-002, FR-003, AC-002A/B, AC-003A/B, NFR-013, NFR-017.
- **Architecture** (`_bmad-output/planning-artifacts/architecture.md`) : modèle `DecisionRecord`, événements `phase.Hxx.transition.blocked`.

## Traçabilité
- **FR-002** : empêcher toute transition non autorisée + raison explicite.
- **FR-003** : bloquer sans `phase-notify` dans la fenêtre SLA.
- **NFR-013** : validation correcte >= 95%.
- **NFR-017** : MTTA alerte critique < 10 min.
- **Risques couverts** : P02 (handoff ambigu), P03 (notification de phase manquante).

## Critères d'acceptation (mesurables)
- [x] **AC-01 — Journalisation décisionnelle nominale**
      `recordPhaseGateGovernanceDecision` retourne une entrée déterministe contenant au minimum:
  - `decisionId`, `decisionType`, `phaseFrom`, `phaseTo`, `gateId`, `owner`
  - `allowed`, `reasonCode`, `reason`, `severity`, `decidedAt`
  - `sourceReasonCode`, `correctiveActions`, `evidenceRefs`

- [x] **AC-02 — Propagation stricte FR-002/FR-003**
      Les reason codes bloquants sont propagés strictement depuis S011, notamment:
  - `TRANSITION_NOT_ALLOWED`
  - `PHASE_NOTIFICATION_MISSING`
  - `PHASE_NOTIFICATION_SLA_EXCEEDED`
  avec `owner` + actions correctives explicites.

- [x] **AC-03 — Sources flexibles (dépendance S011 réutilisée)**
  - `progressionAlert` injecté : priorité 1.
  - sinon `progressionAlertInput` : délégation à `evaluatePhaseProgressionAlert`.
  - aucune source : `INVALID_GOVERNANCE_DECISION_INPUT`.

- [x] **AC-04 — Historique consultable filtré**
      Consultation `decisionHistory` avec filtres:
  - `phase`, `gate`, `owner`, `reasonCode`, `allowed`, `fromDate`, `toDate`
  - tri décroissant stable
  - limite bornée (`limit <= 200`, rétention <= 1000)

- [x] **AC-05 — Contrat de sortie stable**
      Retour systématique:
      `{ allowed, reasonCode, reason, diagnostics, decisionEntry, decisionHistory, correctiveActions }`
      avec diagnostics minimum:
  - `phaseFrom`, `phaseTo`, `gateId`, `owner`, `sourceReasonCode`
  - `decisionCount`, `returnedCount`, `droppedCount`
  - `blockedByGovernance`, `criticalAlertActive`, `mttaTargetMinutes`

- [x] **AC-06 — Validation stricte des entrées**
      Entrées invalides (payload non conforme, query invalide, contexte incomplet, historiques invalides) ->
  - `allowed=false`
  - `reasonCode=INVALID_GOVERNANCE_DECISION_INPUT`
  - aucune exception non contrôlée

- [x] **AC-07 — Déduplication actions/evidence**
      `correctiveActions` et `evidenceRefs` sont normalisés + dédupliqués de manière déterministe.

- [x] **AC-08 — Gravité/alerte exploitation (NFR-017)**
      Les reason codes critiques (`PHASE_NOTIFICATION_MISSING`, `PHASE_NOTIFICATION_SLA_EXCEEDED`, `REPEATED_BLOCKING_ANOMALY`) produisent:
  - `severity=critical`
  - `diagnostics.criticalAlertActive=true`
  - `diagnostics.mttaTargetMinutes=10`

- [x] **AC-09 — UI e2e démonstrateur minimal**
      Couverture `empty`, `loading`, `success`, `error` avec affichage explicite:
  - `reasonCode`, `reason`, `owner`
  - `decisionEntry`, `decisionHistory`, `correctiveActions`
  - responsive mobile/tablet/desktop sans overflow horizontal.

- [x] **AC-10 — Seuil qualité module**
  - Couverture module S012 >= **95% lignes** et **95% branches**.

## Cas de test obligatoires
### Fonctionnels
- [x] Cas nominal: décision `OK` journalisée avec entry complète.
- [x] Cas blocage propagé: `TRANSITION_NOT_ALLOWED`.
- [x] Cas blocage FR-003: `PHASE_NOTIFICATION_SLA_EXCEEDED`.
- [x] Cas délégation S011 via `progressionAlertInput`.
- [x] Cas filtres historiques combinés (phase/gate/owner/reason/date/allowed).
- [x] Cas bornes `maxEntries` + `query.limit`.

### Non-régression
- [x] Export `recordPhaseGateGovernanceDecision` ajouté sans casser les exports existants.
- [x] Suites unit/edge/e2e existantes restent vertes.
- [x] Réutilisation stricte S011 (pas de réimplémentation des règles progression).

### Sécurité / robustesse
- [x] Validation stricte des entrées + fail-closed.
- [x] Aucune exécution shell dans le module S012.
- [x] Aucune mutation observable des objets d’entrée.

## Scope DEV strict S012
### Autorisé
1. Implémenter `recordPhaseGateGovernanceDecision(input, options?)` dans `app/src/phase-gate-governance-journal.js`.
2. Exporter S012 dans `app/src/index.js` (export S012 uniquement).
3. Ajouter/adapter les tests S012:
   - `app/tests/unit/phase-gate-governance-journal.test.js`
   - `app/tests/edge/phase-gate-governance-journal.edge.test.js`
   - `app/tests/e2e/phase-gate-governance-journal.spec.js`
4. Mettre à jour la story S012 + handoffs DEV (`S012-dev-to-uxqa.md`, `S012-dev-to-tea.md`) avec preuves.

### Interdit (hors-scope)
- Toute évolution hors FR-002/FR-003, NFR-013/NFR-017.
- Toute modification fonctionnelle S001..S011 ou S013+ non strictement nécessaire.
- Tout refactor transverse non requis par les AC S012.
- Toute exécution shell depuis les modules S012.

## Contraintes
- Scope strict S012 uniquement.
- Reason codes strictement alignés contrat PM/H13.
- Contrat de sortie stable et déterministe.
- Story non-DONE tant que **G4-T** et **G4-UX** ne sont pas tous deux PASS.

## Implémentation
### Réalisé (DEV)
1. Création de `app/src/phase-gate-governance-journal.js` avec API `recordPhaseGateGovernanceDecision(input, options?)`.
2. Réutilisation stricte de S011:
   - `progressionAlert` injecté prioritaire,
   - sinon `progressionAlertInput` -> délégation `evaluatePhaseProgressionAlert`.
3. Construction d’entrée décisionnelle déterministe:
   - `decisionId`, `decisionType`, `phaseFrom`, `phaseTo`, `gateId`, `owner`,
   - `allowed`, `reasonCode`, `reason`, `severity`, `decidedAt`,
   - `sourceReasonCode`, `correctiveActions`, `evidenceRefs`.
4. Consultation historique filtrable + tri décroissant stable + limites bornées.
5. Propagation stricte des blocages FR-002/FR-003 (`TRANSITION_NOT_ALLOWED`, `PHASE_NOTIFICATION_MISSING`, `PHASE_NOTIFICATION_SLA_EXCEEDED`) avec owner/action explicite.
6. Contrat de sortie stable livré:
   `{ allowed, reasonCode, reason, diagnostics, decisionEntry, decisionHistory, correctiveActions }`.
7. Export public S012 ajouté dans `app/src/index.js` (`recordPhaseGateGovernanceDecision`).
8. Tests S012 ajoutés/renforcés:
   - `app/tests/unit/phase-gate-governance-journal.test.js`
   - `app/tests/edge/phase-gate-governance-journal.edge.test.js`
   - `app/tests/e2e/phase-gate-governance-journal.spec.js`

## Review
- [x] Mapping AC → tests documenté.
- [x] Vérification explicite réutilisation S011.
- [x] Vérification couverture module >= 95% lignes + branches.
- [x] Résultat gates techniques publié (PASS/CONCERNS/FAIL).

### Mapping AC → tests
- AC-01/02/03/04/05/06/07/08/10:
  - `app/tests/unit/phase-gate-governance-journal.test.js`
  - `app/tests/edge/phase-gate-governance-journal.edge.test.js`
- AC-09:
  - `app/tests/e2e/phase-gate-governance-journal.spec.js`
- AC-10 coverage (`npm run test:coverage`):
  - module S012 `app/src/phase-gate-governance-journal.js` = **100% lines**, **96.49% branches**, **100% functions**, **100% statements**.

### Gates techniques (DEV)
Commande exécutée depuis `app/` (UTC 2026-02-22T23:31:00Z):
`npm run lint && npm run typecheck && npx vitest run tests/unit tests/edge && npx playwright test tests/e2e && npm run test:coverage && npm run build && npm run security:deps` ✅

Log complet:
- `_bmad-output/implementation-artifacts/handoffs/S012-tech-gates.log`

Résultats observés:
- `npm run lint` ✅
- `npm run typecheck` ✅
- `npx vitest run tests/unit tests/edge` ✅ (**34 fichiers / 452 tests passés**)
- `npx playwright test tests/e2e` ✅ (**33/33 tests passés**)
- `npm run test:coverage` ✅
  - global: **99.41% statements / 97.73% branches / 100% functions / 99.39% lines**
  - module S012: **100% lines / 96.49% branches / 100% functions / 100% statements**
- `npm run build` ✅
- `npm run security:deps` ✅ (`npm audit --audit-level=high`: **0 vulnérabilité**)
- Verdict technique DEV: **PASS**

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/phase-gate-governance-journal.test.js tests/edge/phase-gate-governance-journal.edge.test.js`
4. `npx playwright test tests/e2e/phase-gate-governance-journal.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests cas limites (edge)
- [x] coverage >= seuil
- [x] security scan dépendances
- [x] build

## Règle Story DONE
- Interdit de passer DONE si un seul gate échoue (technique OU UX).
- Audit UX obligatoire: `_bmad-output/implementation-artifacts/ux-audits/<SID>-ux-audit.json` avec verdict PASS.
- Utiliser `bash scripts/story-done-guard.sh <SID>` pour valider la fin.

## UX Gates obligatoires
- [ ] conformité design-system (tokens, spacing, typo, composants)
- [ ] accessibilité WCAG 2.2 AA (minimum)
- [ ] responsive (mobile/tablet/desktop)
- [ ] états d'interface (loading/empty/error/success)
- [ ] hiérarchie visuelle et lisibilité
- [ ] evidence UX fournie (captures/rapports)

## Status
- Dernière revalidation DEV (UTC): 2026-02-22T23:31:00Z
READY_FOR_UX_AUDIT
READY_FOR_TEA
