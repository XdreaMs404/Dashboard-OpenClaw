# S027 - Calculateur verdict PASS/CONCERNS/FAIL

canonical_story_id: E03-S03
epic: E03
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Scope canonique
- Story ID canonique: `E03-S03`
- FR clés: FR-013, FR-014
- NFR clés: NFR-018, NFR-029
- Risques: P06, U03
- Dépendance story: E03-S02

## Checklist Delivery
- [x] Implémentation conforme au scope canonique
- [x] Tests unit/intégration
- [x] Tests edge
- [x] Tests e2e
- [x] Coverage >= seuil
- [x] Security scan dépendances
- [x] Build
- [x] Audit UX prêt pour revue

## Critères d’acceptation S027
- [x] **AC-01 / FR-013**: calcul automatique du verdict `PASS|CONCERNS|FAIL` selon règles de gate.
- [x] **AC-02 / FR-014**: blocage DONE si `G4-T` ou `G4-UX` n’est pas `PASS` (`canMarkDone=false` + `BLOCK_DONE_TRANSITION`).
- [x] **AC-03 / NFR-018**: baseline précision >=65% validée sur dataset de validation (9 cas).
- [x] **AC-04 / NFR-029**: chaîne de preuve obligatoire (`EVIDENCE_CHAIN_INCOMPLETE` si manquante).
- [x] **AC-05**: résolution source stricte (`g4DualResult` prioritaire, sinon délégation S026 via `g4DualInput`).
- [x] **AC-06**: propagation stricte des blocages amont S026 autorisés.
- [x] **AC-07**: verdict `FAIL` sur incohérence/mismatch dual ou sous-gate FAIL.
- [x] **AC-08**: contrat stable livré:
  `{ allowed, reasonCode, reason, diagnostics, verdict, canMarkDone, contributingFactors, correctiveActions }`.
- [x] **AC-09**: e2e états `empty/loading/error/success` + reason/verdict/canMarkDone/facteurs/actions.
- [x] **AC-10**: qualité module >=95% lignes/branches + perf p95 <=2s sur 500 évaluations.

## Implémentation S027
### Fichiers touchés (strict S027)
- `app/src/gate-verdict-calculator.js`
- `app/src/index.js` (export S027)
- `app/tests/unit/gate-verdict-calculator.test.js`
- `app/tests/edge/gate-verdict-calculator.edge.test.js`
- `app/tests/e2e/gate-verdict-calculator.spec.js`
- `_bmad-output/implementation-artifacts/stories/S027.md`
- `_bmad-output/implementation-artifacts/handoffs/S027-dev-to-uxqa.md`
- `_bmad-output/implementation-artifacts/handoffs/S027-dev-to-tea.md`

### Résumé fonctionnel
1. Résolution source stricte:
   - `g4DualResult` injecté prioritaire
   - sinon délégation S026 via `evaluateG4DualCorrelation(g4DualInput)`
   - sinon `INVALID_GATE_VERDICT_INPUT`
2. Propagation fail-closed des reason codes bloquants amont S026 (`INVALID_G4_DUAL_INPUT`, `G4_SUBGATES_UNSYNC`, `G4_DUAL_EVALUATION_FAILED`, etc.).
3. Calcul déterministe verdict:
   - base dual `G4-T/G4-UX`
   - prise en compte mismatch/maux synchronisation
   - prise en compte signaux additionnels (`PASS|CONCERNS|FAIL` + `blocking`).
4. Application FR-014:
   - `canMarkDone=true` uniquement si verdict `PASS` **et** `G4-T/G4-UX=PASS`
   - sinon `BLOCK_DONE_TRANSITION` forcé.
5. Chaîne de preuve:
   - validation `evidenceRefs` / `evidenceByGateRefs`
   - absence de preuve primaire => `EVIDENCE_CHAIN_INCOMPLETE` + `LINK_PRIMARY_EVIDENCE`.
6. Contrat stable + diagnostics:
   - `inputGatesCount`, `evidenceCount`, `g4tStatus`, `g4uxStatus`, `durationMs`, `p95VerdictMs`, `sourceReasonCode`
   - `contributingFactors` explicites pour traçabilité de décision.

## Mapping AC -> tests
- AC-01, AC-02, AC-05, AC-06, AC-07, AC-08, AC-10:
  - `app/tests/unit/gate-verdict-calculator.test.js`
  - `app/tests/edge/gate-verdict-calculator.edge.test.js`
- AC-03 (précision baseline):
  - `app/tests/unit/gate-verdict-calculator.test.js` (dataset 9 cas, précision observée 100%).
- AC-04 (chaîne preuve):
  - `app/tests/unit/gate-verdict-calculator.test.js`
  - `app/tests/edge/gate-verdict-calculator.edge.test.js`
- AC-09 (UX/e2e):
  - `app/tests/e2e/gate-verdict-calculator.spec.js`

## Couverture/performance S027
- `app/src/gate-verdict-calculator.js`:
  - **99.17% statements**
  - **99.21% branches**
  - **97.36% functions**
  - **99.57% lines**
- Perf synthétique:
  - `p95VerdictMs <= 2000`
  - `durationMs < 60000` sur flux de 500 évaluations
- Précision baseline:
  - dataset validation dual 9 cas: **100%** (>=65% requis)

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/gate-verdict-calculator.test.js tests/edge/gate-verdict-calculator.edge.test.js`
4. `npx playwright test tests/e2e/gate-verdict-calculator.spec.js`
5. `npx vitest run tests/unit/gate-verdict-calculator.test.js tests/edge/gate-verdict-calculator.edge.test.js --coverage --coverage.include=src/gate-verdict-calculator.js`
6. `npm run build && npm run security:deps`
7. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-fast-quality-gates.sh S027`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests edge
- [x] coverage >= seuil
- [x] fast quality gates S027

## Status
READY_FOR_UXQA_TEA
