# S029 - Validation preuve primaire obligatoire

canonical_story_id: E03-S05
epic: E03
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Scope canonique
- Story ID canonique: `E03-S05`
- FR clés: FR-015, FR-016
- NFR clés: NFR-031, NFR-002
- Risques: T07, P05
- Dépendance story: E03-S04 (S028)

## Checklist Delivery
- [x] Implémentation conforme au scope canonique
- [x] Tests unit/intégration
- [x] Tests edge
- [x] Tests e2e
- [x] Coverage >= seuil
- [x] Security scan dépendances
- [x] Build
- [x] Audit UX prêt pour revue

## Critères d’acceptation S029
- [x] **AC-01 / FR-015**: absence de preuve primaire valide => `allowed=false`, `EVIDENCE_CHAIN_INCOMPLETE`, `LINK_PRIMARY_EVIDENCE`.
- [x] **AC-02 / FR-015**: preuve primaire valide => `allowed=true`, `reasonCode=OK`, `primaryEvidence.valid=true`.
- [x] **AC-03 / FR-016**: verdict `CONCERNS` => action assignée avec échéance (`assignee`, `dueAt`, `status=OPEN`).
- [x] **AC-04 / FR-016**: verdict `CONCERNS` sans assignation valide => `CONCERNS_ACTION_ASSIGNMENT_INVALID` + actions correctives.
- [x] **AC-05**: résolution source stricte (`doneTransitionGuardResult` prioritaire, sinon délégation S028 via `doneTransitionGuardInput`).
- [x] **AC-06**: propagation stricte des blocages amont S028/S027 sans réécriture.
- [x] **AC-07**: contrat stable livré:
  `{ allowed, reasonCode, reason, diagnostics, primaryEvidence, concernsAction, correctiveActions }`.
- [x] **AC-08**: diagnostics obligatoires livrés (`verdict`, `canMarkDone`, `evidenceCount`, `concernsActionRequired`, `durationMs`, `p95ValidationMs`, `sourceReasonCode`).
- [x] **AC-09 / NFR-031**: e2e 4 états UI `empty/loading/error/success` + champs visibles requis.
- [x] **AC-10 / NFR-002**: couverture module >=95% lignes/branches + `p95ValidationMs <= 2500` sur 500 évaluations.

## Implémentation S029
### Fichiers touchés (strict S029)
- `app/src/gate-primary-evidence-validator.js`
- `app/src/index.js` (export S029)
- `app/tests/unit/gate-primary-evidence-validator.test.js`
- `app/tests/edge/gate-primary-evidence-validator.edge.test.js`
- `app/tests/e2e/gate-primary-evidence-validator.spec.js`
- `_bmad-output/implementation-artifacts/stories/S029.md`
- `_bmad-output/implementation-artifacts/handoffs/S029-dev-to-uxqa.md`
- `_bmad-output/implementation-artifacts/handoffs/S029-dev-to-tea.md`

### Résumé fonctionnel
1. Nouveau module `validatePrimaryGateEvidence(input, options?)`.
2. Source stricte:
   - `doneTransitionGuardResult` injecté prioritaire.
   - sinon délégation S028 via `guardDoneTransition(doneTransitionGuardInput)`.
   - sinon `INVALID_PRIMARY_EVIDENCE_INPUT`.
3. Validation preuve primaire:
   - fusion/déduplication `primaryEvidenceRefs` + `evidenceRefs`.
   - seuil minimal configurable (`minPrimaryEvidenceCount`, défaut 1).
   - fail-closed `EVIDENCE_CHAIN_INCOMPLETE` si preuve insuffisante.
4. Validation action `CONCERNS`:
   - `assignee` non vide + `dueAt` ISO/date/number valide + `status=OPEN` requis.
   - sinon `CONCERNS_ACTION_ASSIGNMENT_INVALID` + `ASSIGN_CONCERNS_OWNER` + `SET_CONCERNS_DUE_DATE`.
5. Propagation stricte amont:
   - reason codes bloquants S028/S027 propagés sans réécriture (ex: `DONE_TRANSITION_BLOCKED`, `G4_SUBGATES_UNSYNC`).
6. Contrat stable + diagnostics:
   - `verdict`, `canMarkDone`, `evidenceCount`, `concernsActionRequired`, `durationMs`, `p95ValidationMs`, `sourceReasonCode`.

## Mapping AC -> tests
- AC-01, AC-02, AC-03, AC-04, AC-05, AC-06, AC-07, AC-08, AC-10:
  - `app/tests/unit/gate-primary-evidence-validator.test.js`
  - `app/tests/edge/gate-primary-evidence-validator.edge.test.js`
- AC-09 (NFR-031 états UI + responsive):
  - `app/tests/e2e/gate-primary-evidence-validator.spec.js`

## Couverture/performance S029
- `app/src/gate-primary-evidence-validator.js`:
  - **98.91% statements**
  - **98.31% branches**
  - **96.29% functions**
  - **99.44% lines**
- Perf synthétique:
  - `p95ValidationMs <= 2500` validé sur stream 500 évaluations.

## Vérifications DEV exécutées
1. `npm run lint && npm run typecheck` ✅
2. `npx vitest run tests/unit/gate-primary-evidence-validator.test.js tests/edge/gate-primary-evidence-validator.edge.test.js` ✅
3. `npx playwright test tests/e2e/gate-primary-evidence-validator.spec.js` ✅
4. `npx vitest run tests/unit/gate-primary-evidence-validator.test.js tests/edge/gate-primary-evidence-validator.edge.test.js --coverage --coverage.include=src/gate-primary-evidence-validator.js` ✅
5. `npm run build && npm run security:deps` ✅
6. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-fast-quality-gates.sh S029` ✅

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/gate-primary-evidence-validator.test.js tests/edge/gate-primary-evidence-validator.edge.test.js`
4. `npx playwright test tests/e2e/gate-primary-evidence-validator.spec.js`
5. `npx vitest run tests/unit/gate-primary-evidence-validator.test.js tests/edge/gate-primary-evidence-validator.edge.test.js --coverage --coverage.include=src/gate-primary-evidence-validator.js`
6. `npm run build && npm run security:deps`
7. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-fast-quality-gates.sh S029`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests edge
- [x] coverage >= seuil
- [x] fast quality gates S029

## Status
READY_FOR_UXQA_TEA
