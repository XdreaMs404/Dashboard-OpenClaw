# S029 - Validation preuve primaire obligatoire

canonical_story_id: E03-S05
epic: E03
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Handoff courant
H12 PM -> DEV (pack story prêt pour H13)

## Scope canonique
- Story ID canonique: `E03-S05`
- FR clés: FR-015, FR-016
- NFR clés: NFR-031, NFR-002
- Risques: T07, P05
- Dépendance story: E03-S04 (S028)

## User story
En tant qu’orchestrateur BMAD,
je veux exiger une preuve primaire valide pour toute décision de gate et garantir une action assignée avec échéance quand un gate est en CONCERNS,
afin d’éviter les faux DONE et d’assurer la fermeture effective des points de risque.

## Dépendances
- **S028** (`guardDoneTransition`) : source de vérité blocage DONE + état G4.
- **S027** (`calculateGateVerdict`) : verdict PASS/CONCERNS/FAIL utilisé en amont via S028.
- **S026/S025** : cohérence des sous-gates G4 et du Gate Center.
- **Planning canonique** : `epics.md` section `E03-S05`.
- **PRD** : FR-015, FR-016, NFR-031, NFR-002.

## Traçabilité
- **FR-015**: preuve primaire obligatoire pour toute décision de gate.
- **FR-016**: action assignée avec échéance pour chaque gate en CONCERNS.
- **NFR-031**: couverture des 4 états UI (100% widgets critiques).
- **NFR-002**: p95 < 2.5s sur chargement/évaluation.
- **Risques couverts**: T07 (faux DONE), P05 (actions de mitigation non fermées).

## Critères d’acceptation (mesurables)
- [ ] **AC-01 (FR-015) — Preuve primaire obligatoire**
      Si aucune preuve primaire valide n’est liée à la décision de gate:
  - `allowed=false`
  - `reasonCode="EVIDENCE_CHAIN_INCOMPLETE"`
  - `correctiveActions` contient `LINK_PRIMARY_EVIDENCE`.

- [ ] **AC-02 (FR-015) — Passage nominal preuve valide**
      Si preuve primaire valide présente et entrée conforme:
  - `allowed=true`
  - `reasonCode="OK"`
  - `primaryEvidence.valid=true`.

- [ ] **AC-03 (FR-016) — Action CONCERNS obligatoire**
      Si verdict gate = `CONCERNS`, la sortie doit contenir une action assignée avec échéance:
  - `concernsAction.assignee` non vide
  - `concernsAction.dueAt` ISO valide
  - `concernsAction.status` = `OPEN`.

- [ ] **AC-04 (FR-016) — Cas CONCERNS sans données d’assignation**
      Si verdict `CONCERNS` et données d’assignation invalides/manquantes:
  - `allowed=false`
  - `reasonCode="CONCERNS_ACTION_ASSIGNMENT_INVALID"`
  - `correctiveActions` inclut `ASSIGN_CONCERNS_OWNER` et `SET_CONCERNS_DUE_DATE`.

- [ ] **AC-05 — Résolution source stricte**
  - `doneTransitionGuardResult` injecté -> utilisé tel quel
  - sinon `doneTransitionGuardInput` -> délégation à S028 (`guardDoneTransition`)
  - sinon `INVALID_PRIMARY_EVIDENCE_INPUT`.

- [ ] **AC-06 — Propagation stricte des blocages amont**
      Les reason codes bloquants S028/S027 sont propagés sans réécriture (fail-closed).

- [ ] **AC-07 — Contrat de sortie stable**
      La sortie respecte systématiquement:
      `{ allowed, reasonCode, reason, diagnostics, primaryEvidence, concernsAction, correctiveActions }`.

- [ ] **AC-08 — Diagnostics minimaux obligatoires**
      `diagnostics` contient au minimum:
      `verdict`, `canMarkDone`, `evidenceCount`, `concernsActionRequired`, `durationMs`, `p95ValidationMs`, `sourceReasonCode`.

- [ ] **AC-09 (NFR-031) — E2E UI 4 états**
      États `empty/loading/error/success` couverts avec affichage explicite de:
      `reasonCode`, `reason`, `primaryEvidence`, `concernsAction`, `correctiveActions`.

- [ ] **AC-10 (NFR-002) — Performance/qualité**
      Couverture module >= 95% lignes + 95% branches,
      et `p95ValidationMs <= 2500` sur dataset 500 évaluations.

## Cas de test obligatoires
### Fonctionnels
- [ ] Gate sans preuve primaire -> blocage `EVIDENCE_CHAIN_INCOMPLETE`.
- [ ] Gate avec preuve primaire valide -> passage `OK`.
- [ ] Gate `CONCERNS` avec assignee+dueAt -> action conforme créée/validée.
- [ ] Gate `CONCERNS` sans assignee/dueAt -> blocage `CONCERNS_ACTION_ASSIGNMENT_INVALID`.
- [ ] Délégation S028 via `doneTransitionGuardInput`.
- [ ] Propagation d’un blocage amont (ex: `DONE_TRANSITION_BLOCKED`).

### Non-régression
- [ ] Contrat public S028 inchangé.
- [ ] Contrat public S027 inchangé.
- [ ] Suites existantes S001..S028 restent vertes.

### Sécurité / robustesse
- [ ] Validation stricte des entrées (preuves/actions/échéances).
- [ ] Aucune mutation inattendue des entrées.
- [ ] Aucune exécution shell dans les modules S029.

## Scope DEV strict S029
### Autorisé
1. Implémenter `validatePrimaryGateEvidence(input, options?)` dans `app/src/gate-primary-evidence-validator.js`.
2. Exporter S029 dans `app/src/index.js` (export S029 uniquement).
3. Ajouter/adapter les tests S029:
   - `app/tests/unit/gate-primary-evidence-validator.test.js`
   - `app/tests/edge/gate-primary-evidence-validator.edge.test.js`
   - `app/tests/e2e/gate-primary-evidence-validator.spec.js`
4. Ajustement minimal de `app/src/done-transition-guard.js` uniquement si nécessaire au branchement S029, sans changement comportement fonctionnel S028.
5. Mettre à jour les handoffs DEV S029:
   - `_bmad-output/implementation-artifacts/handoffs/S029-dev-to-uxqa.md`
   - `_bmad-output/implementation-artifacts/handoffs/S029-dev-to-tea.md`

### Interdit (hors-scope)
- Toute automatisation étendue des actions CONCERNS au-delà du périmètre décision unitaire S029 (scope S030).
- Toute évolution de policy/versioning gate (scopes S031+).
- Tout refactor transverse non requis par les AC S029.

## Contraintes
- Scope strict S029 uniquement.
- Fail-closed par défaut sur toute ambiguïté preuve/action.
- DONE reste bloqué tant que garde S028 non satisfaite.
- Les actions CONCERNS S029 doivent être explicitement assignées et datées.

## Plan de preuve / gates
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/gate-primary-evidence-validator.test.js tests/edge/gate-primary-evidence-validator.edge.test.js`
4. `npx playwright test tests/e2e/gate-primary-evidence-validator.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`
7. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-story-gates.sh S029`
8. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-ux-gates.sh S029`

## Checklist Delivery
- [ ] Implémentation conforme au scope canonique
- [ ] Tests unit/intégration
- [ ] Tests edge
- [ ] Tests e2e
- [ ] Coverage >= seuil
- [ ] Security scan dépendances
- [ ] Build
- [ ] Audit UX PASS

## Handoff explicite vers DEV (H13)
- DEV implémente strictement S029 selon ce pack.
- Toute dérive de scope => retour PM obligatoire.
- Sortie attendue DEV: handoffs `S029-dev-to-uxqa.md` et `S029-dev-to-tea.md` avec preuves complètes.

## Status
READY_FOR_DEV
