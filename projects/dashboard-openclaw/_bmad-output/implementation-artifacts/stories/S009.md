# S009 - Workflow override exceptionnel avec approbateur

canonical_story_id: E01-S09
epic: E01
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Scope canonique
- Story ID canonique: `E01-S09`
- FR clés: FR-009, FR-010
- NFR clés: NFR-034, NFR-040
- Risques: P06, P07
- Dépendance story: E01-S08

## Pourquoi réouverture
- Story réouverte pour réalignement canonique: fr_missing:FR-010
- Ancienne version archivée sous `_bmad-output/implementation-artifacts/archive/`.

## Checklist Delivery
- [x] Implémentation conforme au scope canonique
- [x] Tests unit/intégration
- [x] Tests edge
- [x] Tests e2e
- [x] Coverage >= seuil
- [x] Security scan dépendances
- [x] Build
- [ ] Audit UX PASS

## Exécution DEV (H13/H16)
- Date exécution gates (UTC): 2026-02-22T15:11:32Z → 2026-02-22T15:12:18Z
- Preuve logs: `_bmad-output/implementation-artifacts/handoffs/S009-tech-gates.log`
- Décision d’implémentation: comportement S009 déjà conforme au contrat PM; validation stricte réalisée sans extension hors-scope.
- Fichiers scope validés:
  - `app/src/phase-transition-override.js`
  - `app/src/phase-dependency-matrix.js`
  - `app/tests/unit/phase-transition-override.test.js`
  - `app/tests/edge/phase-transition-override.edge.test.js`
  - `app/tests/e2e/phase-transition-override.spec.js`
  - `app/tests/unit/phase-dependency-matrix.test.js`
  - `app/tests/edge/phase-dependency-matrix.edge.test.js`
  - `app/tests/e2e/phase-dependency-matrix.spec.js`
- Résultats:
  - lint/typecheck/build/security: PASS
  - tests unit+edge: 32 fichiers / 425 tests PASS
  - tests e2e: 31/31 PASS
  - couverture modules S009:
    - `phase-transition-override.js`: 99.24% lines / 98.57% branches / 100% functions
    - `phase-dependency-matrix.js`: 99.63% lines / 99.23% branches / 100% functions

## Mapping AC -> preuves/tests
- **AC-01 / FR-009** — override exceptionnel autorisé uniquement avec justification + approbateur
  - unit (`phase-transition-override.test.js`):
    - `approves override on eligible blocked reason with complete request`
    - `returns OVERRIDE_REQUEST_MISSING when eligible blocked transition has no request`
    - `returns explicit validation errors for short justification and missing approver`
    - `returns OVERRIDE_APPROVER_CONFLICT ...`
  - edge (`phase-transition-override.edge.test.js`):
    - validation stricte input/config/contract (`INVALID_OVERRIDE_INPUT`)
    - règles `minJustificationLength` et `requireDistinctApprover`
  - e2e (`phase-transition-override.spec.js`):
    - états `empty/loading/error/success`
    - reason codes + actions correctives visibles

- **AC-02 / FR-010** — dépendances bloquantes inter-phases + état temps réel
  - unit (`phase-dependency-matrix.test.js`):
    - dépendances `TRANSITION/PREREQUISITES/OVERRIDE/FRESHNESS`
    - `blockingDependencies` + `correctiveActions`
    - stale state `DEPENDENCY_STATE_STALE`
  - edge (`phase-dependency-matrix.edge.test.js`):
    - validation stricte des payloads/contrats délégués
    - agrégation robuste des blocages transition/prérequis/override
  - e2e (`phase-dependency-matrix.spec.js`):
    - états `empty/loading/error/success`
    - owner, blocages, corrective actions, freshness lisibles

- **AC-03 / NFR-034** — métriques clés disponibles en continu
  - diagnostics override: `fromPhase`, `toPhase`, `sourceReasonCode`, `overrideEligible`, `overrideRequested`, `justificationLength`, `approverPresent`, `approverDistinct`
  - diagnostics dependency matrix: `owner`, `snapshotAgeMs`, `maxRefreshIntervalMs`, `isStale`, `blockedDependenciesCount`, `sourceReasonCode`

- **AC-04 / NFR-040** — time-to-first-value < 14 jours (actionnabilité)
  - reason codes explicites et actions opérables immédiatement (`CAPTURE_*`, `REQUEST_OVERRIDE_APPROVAL`, `REFRESH_DEPENDENCY_MATRIX`, etc.)

## Mapping DoD -> preuves
- **DoD-01** tests unit/intégration/e2e verts: ✅ (unit+edge + e2e PASS)
- **DoD-02** contrôle sécurité sans blocant: ✅ (`npm audit --audit-level=high` = 0 vulnérabilité)
- **DoD-03** preuve UX (states/a11y/responsive): ✅ (`phase-transition-override.spec.js`, `phase-dependency-matrix.spec.js`, handoff UXQA)
- **DoD-04** instrumentation métriques/alertes exploitation: ✅ diagnostics structurés S009 exposés en sortie
- **DoD-05** mapping FR/NFR/Risque + owner + échéance: ✅ voir traçabilité ci-dessous
- **DoD-06** dépendances aval/handoff clairs: ✅ DEV→UXQA et DEV→TEA produits

## Traçabilité owner / échéance (DoD-05)
- Owner DEV: `bmad-dev` (runtime mission H13 S009)
- Échéance mission: tick runtime 2026-02-22 (respectée)
- FR couverts: FR-009, FR-010
- NFR couverts: NFR-034, NFR-040
- Risques couverts: P06, P07

## Handoffs produits
- `_bmad-output/implementation-artifacts/handoffs/S009-dev-to-uxqa.md`
- `_bmad-output/implementation-artifacts/handoffs/S009-dev-to-tea.md`

## Comment tester (simple)
- `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-story-gates.sh S009`
- `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-ux-gates.sh S009`

## Status
READY_FOR_UXQA_TEA