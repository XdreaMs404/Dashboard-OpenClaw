# S030 - Création automatique actions CONCERNS

canonical_story_id: E03-S06
epic: E03
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Handoff courant
H12 PM -> DEV (pack story prêt pour H13)

## Scope canonique
- Story ID canonique: `E03-S06`
- FR clés: FR-016, FR-017
- NFR clés: NFR-002, NFR-007
- Risques: P05, P06
- Dépendance story: E03-S05 (S029)

## User story
En tant qu’orchestrateur BMAD,
je veux créer automatiquement une action assignée avec échéance pour chaque gate en CONCERNS et tracer la version de policy appliquée,
afin d’éviter les actions de mitigation orphelines et d’assurer une historisation fiable des décisions gate.

## Dépendances
- **S029** (`validatePrimaryGateEvidence`) : validation preuve primaire + conformité décision gate.
- **S028** (`guardDoneTransition`) : garde DONE et état de blocage.
- **S027** (`calculateGateVerdict`) : source verdict PASS/CONCERNS/FAIL.
- **Planning canonique** : `epics.md` section `E03-S06`.
- **PRD** : FR-016, FR-017, NFR-002, NFR-007.

## Traçabilité
- **FR-016**: action assignée avec échéance pour chaque gate en CONCERNS.
- **FR-017**: versionnement/historisation des règles gate.
- **NFR-002**: p95 < 2.5s.
- **NFR-007**: latence verdict <= 2s après preuve.
- **Risques couverts**: P05 (actions non fermées), P06 (contournement contrôles qualité).

## Critères d’acceptation (mesurables)
- [ ] **AC-01 (FR-016) — Création automatique action CONCERNS**
      Si verdict gate = `CONCERNS`, la sortie contient une action créée automatiquement:
  - `concernsAction.actionId` non vide
  - `concernsAction.assignee` non vide
  - `concernsAction.dueAt` ISO valide
  - `concernsAction.status="OPEN"`.

- [ ] **AC-02 (FR-016) — Aucun faux positif hors CONCERNS**
      Si verdict gate = `PASS` ou `FAIL`, aucune action CONCERNS n’est créée (`actionCreated=false`).

- [ ] **AC-03 (FR-016) — Données d’assignation invalides**
      Si verdict `CONCERNS` et assignation/échéance manquante ou invalide:
  - `allowed=false`
  - `reasonCode="CONCERNS_ACTION_ASSIGNMENT_INVALID"`
  - `correctiveActions` inclut `ASSIGN_CONCERNS_OWNER` et `SET_CONCERNS_DUE_DATE`.

- [ ] **AC-04 (FR-017) — Snapshot de policy obligatoire**
      Chaque action CONCERNS créée porte un snapshot policy:
  - `policySnapshot.policyScope="gate"`
  - `policySnapshot.version` non vide.

- [ ] **AC-05 (FR-017) — Historisation immuable**
      Chaque création/modification d’action écrit un `historyEntry` minimal:
      `{ actionId, policyVersion, changedAt, changedBy, changeType }`.

- [ ] **AC-06 — Résolution source stricte**
  - `primaryEvidenceResult` injecté -> utilisé tel quel
  - sinon `primaryEvidenceInput` -> délégation S029
  - sinon `INVALID_CONCERNS_ACTION_INPUT`.

- [ ] **AC-07 — Propagation stricte des blocages amont**
      Les reason codes bloquants S029/S028/S027 sont propagés sans réécriture (fail-closed).

- [ ] **AC-08 — Contrat de sortie stable**
      La sortie respecte systématiquement:
      `{ allowed, reasonCode, reason, diagnostics, concernsAction, policySnapshot, historyEntry, correctiveActions }`.

- [ ] **AC-09 (NFR-002/NFR-007) — Performance**
      Sur dataset 500 évaluations:
  - `p95ActionMs <= 2500`
  - `durationMs <= 2000` après preuve valide.

- [ ] **AC-10 — Qualité module + e2e 4 états**
      Couverture `gate-concerns-actions` >= 95% lignes + 95% branches,
      et e2e `empty/loading/error/success` avec affichage `reasonCode`, `concernsAction`, `policySnapshot`, `historyEntry`.

## Cas de test obligatoires
### Fonctionnels
- [ ] Verdict `CONCERNS` -> action auto créée avec assignee/dueAt/OPEN.
- [ ] Verdict `PASS` -> aucune action créée.
- [ ] Verdict `FAIL` -> aucune action CONCERNS créée.
- [ ] Verdict `CONCERNS` sans assignee/dueAt -> `CONCERNS_ACTION_ASSIGNMENT_INVALID`.
- [ ] Snapshot policy absent -> `GATE_POLICY_VERSION_MISSING`.
- [ ] Historique incomplet -> `CONCERNS_ACTION_HISTORY_INCOMPLETE`.
- [ ] Délégation S029 via `primaryEvidenceInput`.

### Non-régression
- [ ] Contrat public S029 inchangé.
- [ ] Contrat public S028/S027 inchangé.
- [ ] Suites existantes S001..S029 restent vertes.

### Sécurité / robustesse
- [ ] Validation stricte des entrées (action, assignee, dueAt, policy).
- [ ] Aucune mutation inattendue des entrées.
- [ ] Aucune exécution shell dans les modules S030.

## Scope DEV strict S030
### Autorisé
1. Implémenter `createGateConcernsAction(input, options?)` dans `app/src/gate-concerns-actions.js`.
2. Exporter S030 dans `app/src/index.js` (export S030 uniquement).
3. Ajouter/adapter les tests S030:
   - `app/tests/unit/gate-concerns-actions.test.js`
   - `app/tests/edge/gate-concerns-actions.edge.test.js`
   - `app/tests/e2e/gate-concerns-actions.spec.js`
4. Ajustement minimal de `app/src/gate-primary-evidence-validator.js` uniquement si nécessaire au branchement S030, sans changement fonctionnel S029.
5. Ajustement minimal de `app/src/phase-gate-governance-journal.js` uniquement si nécessaire pour historisation S030.
6. Mettre à jour les handoffs DEV S030:
   - `_bmad-output/implementation-artifacts/handoffs/S030-dev-to-uxqa.md`
   - `_bmad-output/implementation-artifacts/handoffs/S030-dev-to-tea.md`

### Interdit (hors-scope)
- Gestion complète cycle de vie des policies gate (publication/diff/admin) hors périmètre S030.
- Simulation pré-soumission avancée (scope S031+).
- Refactor transverse non requis par les AC S030.

## Contraintes
- Scope strict S030 uniquement.
- Fail-closed par défaut sur ambiguïté action/policy/history.
- Aucune validation DONE ne peut contourner un blocage amont de S029/S028.
- Toute action CONCERNS doit rester traçable (version + historique).

## Plan de preuve / gates
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/gate-concerns-actions.test.js tests/edge/gate-concerns-actions.edge.test.js`
4. `npx playwright test tests/e2e/gate-concerns-actions.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`
7. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-story-gates.sh S030`
8. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-ux-gates.sh S030`

## Checklist Delivery
- [ ] Implémentation conforme au scope canonique
- [ ] Tests unit/intégration
- [ ] Tests edge
- [ ] Tests e2e
- [ ] Coverage >= seuil
- [ ] Security scan dépendances
- [ ] Build
- [ ] Audit UX PASS

## Handoff explicite vers DEV (H13)
- DEV implémente strictement S030 selon ce pack.
- Toute dérive de scope => retour PM obligatoire.
- Sortie attendue DEV: handoffs `S030-dev-to-uxqa.md` et `S030-dev-to-tea.md` avec preuves complètes.

## Status
READY_FOR_DEV
