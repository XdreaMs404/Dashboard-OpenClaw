# S030 - Création automatique actions CONCERNS

canonical_story_id: E03-S06
epic: E03
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Scope canonique
- Story ID canonique: `E03-S06`
- FR clés: FR-016, FR-017
- NFR clés: NFR-002, NFR-007
- Risques: P05, P06
- Dépendance story: E03-S05 (S029)

## Checklist Delivery
- [x] Implémentation conforme au scope canonique
- [x] Tests unit/intégration
- [x] Tests edge
- [x] Tests e2e
- [x] Coverage >= seuil
- [x] Security scan dépendances
- [x] Build
- [x] Audit UX prêt pour revue

## Critères d’acceptation S030
- [x] **AC-01 / FR-016**: verdict `CONCERNS` => action auto créée (`actionId`, `assignee`, `dueAt` ISO, `status=OPEN`).
- [x] **AC-02 / FR-016**: verdict `PASS`/`FAIL` => aucune création d’action CONCERNS (`actionCreated=false`).
- [x] **AC-03 / FR-016**: assignation invalide en `CONCERNS` => `CONCERNS_ACTION_ASSIGNMENT_INVALID` + actions correctives.
- [x] **AC-04 / FR-017**: snapshot policy obligatoire (`policyScope="gate"`, `version` non vide).
- [x] **AC-05 / FR-017**: historisation immuable (`actionId`, `policyVersion`, `changedAt`, `changedBy`, `changeType`).
- [x] **AC-06**: résolution source stricte (`primaryEvidenceResult` prioritaire, sinon délégation S029 via `primaryEvidenceInput`).
- [x] **AC-07**: propagation stricte des blocages amont S029/S028/S027 sans réécriture.
- [x] **AC-08**: contrat stable livré:
  `{ allowed, reasonCode, reason, diagnostics, concernsAction, policySnapshot, historyEntry, correctiveActions }`.
- [x] **AC-09 / NFR-002 / NFR-007**: `p95ActionMs <= 2500` sur 500 évaluations + `durationMs <= 2000`.
- [x] **AC-10**: couverture module >=95% lignes/branches + e2e 4 états `empty/loading/error/success`.

## Implémentation S030
### Fichiers touchés (strict S030)
- `app/src/gate-concerns-actions.js`
- `app/src/index.js` (export S030)
- `app/tests/unit/gate-concerns-actions.test.js`
- `app/tests/edge/gate-concerns-actions.edge.test.js`
- `app/tests/e2e/gate-concerns-actions.spec.js`
- `_bmad-output/implementation-artifacts/stories/S030.md`
- `_bmad-output/implementation-artifacts/handoffs/S030-dev-to-uxqa.md`
- `_bmad-output/implementation-artifacts/handoffs/S030-dev-to-tea.md`

### Résumé fonctionnel
1. Nouveau module `createGateConcernsAction(input, options?)`.
2. Source stricte:
   - `primaryEvidenceResult` injecté prioritaire.
   - sinon délégation S029 via `validatePrimaryGateEvidence(primaryEvidenceInput)`.
   - sinon `INVALID_CONCERNS_ACTION_INPUT`.
3. Création automatique action CONCERNS:
   - si verdict `CONCERNS`: validation assignee/dueAt/status puis création déterministe `actionId`.
   - génération fallback (`actionIdGenerator` -> `idGenerator` -> UUID) sans effet de bord.
4. Policy snapshot obligatoire pour CONCERNS:
   - `policyScope="gate"` + `version` non vide.
   - sinon `GATE_POLICY_VERSION_MISSING`.
5. Historisation obligatoire:
   - `historyEntry` immuable (`actionId`, `policyVersion`, `changedAt`, `changedBy`, `changeType CREATE|UPDATE`).
   - sinon `CONCERNS_ACTION_HISTORY_INCOMPLETE`.
6. Propagation fail-closed amont:
   - reason codes bloquants S029/S028/S027 propagés tels quels.
7. Diagnostics livrés:
   - `verdict`, `concernsActionRequired`, `actionCreated`, `durationMs`, `p95ActionMs`, `sourceReasonCode`, `policyVersion`.

## Mapping AC -> tests
- AC-01, AC-02, AC-03, AC-04, AC-05, AC-06, AC-07, AC-08, AC-09, AC-10:
  - `app/tests/unit/gate-concerns-actions.test.js`
  - `app/tests/edge/gate-concerns-actions.edge.test.js`
- AC-10 (UI 4 états + responsive):
  - `app/tests/e2e/gate-concerns-actions.spec.js`

## Couverture/performance S030
- `app/src/gate-concerns-actions.js`:
  - **99.49% statements**
  - **95.75% branches**
  - **96.55% functions**
  - **100% lines**
- Perf synthétique:
  - `p95ActionMs <= 2500` validé (flux 500 évaluations).
  - `durationMs <= 2000` vérifié sur les évaluations synthétiques.

## Vérifications DEV exécutées
1. `npm run lint && npm run typecheck` ✅
2. `npx vitest run tests/unit/gate-concerns-actions.test.js tests/edge/gate-concerns-actions.edge.test.js` ✅
3. `npx playwright test tests/e2e/gate-concerns-actions.spec.js` ✅
4. `npx vitest run tests/unit/gate-concerns-actions.test.js tests/edge/gate-concerns-actions.edge.test.js --coverage --coverage.include=src/gate-concerns-actions.js` ✅
5. `npm run build && npm run security:deps` ✅
6. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-fast-quality-gates.sh S030` ✅

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/gate-concerns-actions.test.js tests/edge/gate-concerns-actions.edge.test.js`
4. `npx playwright test tests/e2e/gate-concerns-actions.spec.js`
5. `npx vitest run tests/unit/gate-concerns-actions.test.js tests/edge/gate-concerns-actions.edge.test.js --coverage --coverage.include=src/gate-concerns-actions.js`
6. `npm run build && npm run security:deps`
7. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-fast-quality-gates.sh S030`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests edge
- [x] coverage >= seuil
- [x] fast quality gates S030

## Status
- Dernière validation UX (UTC): 2026-02-24T04:43:14Z
- Dernière validation TEA (UTC): 2026-02-24T04:56:00Z
- Dernière validation reviewer (UTC): 2026-02-24T05:03:00Z
APPROVED_REVIEWER
READY_FOR_TECH_WRITER
