# S031 - Versioning des policies de gate

canonical_story_id: E03-S07
epic: E03
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Handoff courant
H12 PM -> DEV (pack story prêt pour H13)

## Scope canonique
- Story ID canonique: `E03-S07`
- FR clés: FR-017, FR-018
- NFR clés: NFR-007, NFR-018
- Risques: P06, U03
- Dépendance story: E03-S06 (S030)

## User story
En tant qu’orchestrateur BMAD,
je veux versionner les règles de gate avec historisation immuable et simuler un verdict avant soumission finale,
afin d’empêcher les contournements de contrôle qualité et de fiabiliser la décision avant écriture finale.

## Dépendances
- **S030** (`createGateConcernsAction`) : base action CONCERNS + snapshot policy initial.
- **S029** (`validatePrimaryGateEvidence`) : preuve primaire obligatoire.
- **S028** (`guardDoneTransition`) : garde DONE et blocages G4.
- **S027** (`calculateGateVerdict`) : logique de verdict PASS/CONCERNS/FAIL.
- **Planning canonique** : `epics.md` section `E03-S07`.
- **PRD** : FR-017, FR-018, NFR-007, NFR-018.

## Traçabilité
- **FR-017**: versionner les règles de gate et historiser les changements.
- **FR-018**: permettre simulation de verdict avant soumission finale.
- **NFR-007**: latence verdict gate <= 2s après preuve.
- **NFR-018**: précision baseline >= 65%.
- **Risques couverts**: P06 (contournement contrôles ULTRA quality), U03 (non-conformité accessibilité).

## Critères d’acceptation (mesurables)
- [ ] **AC-01 (FR-017) — Version policy obligatoire**
      Toute évaluation S031 inclut une version de policy gate active:
  - `policyVersioning.policyScope="gate"`
  - `policyVersioning.activeVersion` non vide (semver valide)
  - sinon `reasonCode="GATE_POLICY_VERSION_MISSING"`.

- [ ] **AC-02 (FR-017) — Historisation immuable des changements**
      Chaque changement de version produit une entrée d’historique immuable:
      `{ policyId, previousVersion, nextVersion, changedAt, changedBy, changeType }`.

- [ ] **AC-03 (FR-017) — Rejet des versions non actives/stale**
      Si version demandée inactive/stale:
  - `allowed=false`
  - `reasonCode="POLICY_VERSION_NOT_ACTIVE"`
  - action corrective `SYNC_ACTIVE_POLICY_VERSION`.

- [ ] **AC-04 (FR-018) — Simulation pré-soumission disponible**
      Avant soumission finale, simulation verdict exécutable sans effet de bord:
  - `simulation.eligible=true`
  - `simulation.simulatedVerdict` présent (`PASS|CONCERNS|FAIL`)
  - aucune mutation d’état persisté.

- [ ] **AC-05 (FR-018) — Blocage simulation en entrée invalide**
      Entrée simulation invalide/incomplète:
  - `allowed=false`
  - `reasonCode="INVALID_GATE_SIMULATION_INPUT"`
  - `simulation.eligible=false`.

- [ ] **AC-06 — Résolution source stricte**
  - `concernsActionResult` injecté -> utilisé tel quel
  - sinon `concernsActionInput` -> délégation S030
  - sinon `INVALID_GATE_POLICY_INPUT`.

- [ ] **AC-07 — Propagation stricte des blocages amont**
      Les reason codes bloquants S030/S029/S028/S027 sont propagés sans réécriture (fail-closed).

- [ ] **AC-08 — Contrat de sortie stable**
      La sortie respecte systématiquement:
      `{ allowed, reasonCode, reason, diagnostics, policyVersioning, simulation, correctiveActions }`.

- [ ] **AC-09 (NFR-007) — Performance simulation**
      Sur dataset 500 simulations:
  - `p95SimulationMs <= 2000`
  - `durationMs <= 2000` en flux nominal après preuve valide.

- [ ] **AC-10 (NFR-018) — Baseline précision**
      Baseline de simulation >= 65% sur dataset de validation versionné.

## Cas de test obligatoires
### Fonctionnels
- [ ] Version policy active valide -> exécution `OK`.
- [ ] Version policy manquante -> `GATE_POLICY_VERSION_MISSING`.
- [ ] Version policy inactive/stale -> `POLICY_VERSION_NOT_ACTIVE`.
- [ ] Historique incomplet -> `GATE_POLICY_HISTORY_INCOMPLETE`.
- [ ] Simulation nominale avant soumission -> verdict simulé fourni.
- [ ] Simulation en entrée invalide -> `INVALID_GATE_SIMULATION_INPUT`.
- [ ] Délégation S030 via `concernsActionInput`.

### Non-régression
- [ ] Contrat public S030 inchangé.
- [ ] Contrat public S029/S028/S027 inchangé.
- [ ] Suites existantes S001..S030 restent vertes.

### Sécurité / robustesse
- [ ] Validation stricte entrées (version semver, métadonnées history, payload simulation).
- [ ] Aucune mutation inattendue des entrées.
- [ ] Aucune exécution shell dans les modules S031.

## Scope DEV strict S031
### Autorisé
1. Implémenter `versionGatePolicy(input, options?)` dans `app/src/gate-policy-versioning.js`.
2. Implémenter `simulateGateVerdictBeforeSubmission(input, options?)` dans `app/src/gate-pre-submit-simulation.js`.
3. Exporter S031 dans `app/src/index.js` (exports S031 uniquement).
4. Ajouter/adapter les tests S031:
   - `app/tests/unit/gate-policy-versioning.test.js`
   - `app/tests/edge/gate-policy-versioning.edge.test.js`
   - `app/tests/e2e/gate-policy-versioning.spec.js`
5. Ajustement minimal de `app/src/gate-concerns-actions.js` uniquement si nécessaire au branchement S031, sans changement fonctionnel S030.
6. Mettre à jour les handoffs DEV S031:
   - `_bmad-output/implementation-artifacts/handoffs/S031-dev-to-uxqa.md`
   - `_bmad-output/implementation-artifacts/handoffs/S031-dev-to-tea.md`

### Interdit (hors-scope)
- Simulation avancée orientée tendances/analytics multi-période (scope S032+).
- Gestion complète admin publication/diff global policy hors besoins stricts S031.
- Refactor transverse non requis par les AC S031.

## Contraintes
- Scope strict S031 uniquement.
- Fail-closed par défaut sur ambiguïté de version/historique/simulation.
- Toute simulation est non mutative (read-only sur état gate).
- Toute décision issue d’une version non active est refusée.

## Plan de preuve / gates
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/gate-policy-versioning.test.js tests/edge/gate-policy-versioning.edge.test.js`
4. `npx playwright test tests/e2e/gate-policy-versioning.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`
7. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-story-gates.sh S031`
8. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-ux-gates.sh S031`

## Checklist Delivery
- [ ] Implémentation conforme au scope canonique
- [ ] Tests unit/intégration
- [ ] Tests edge
- [ ] Tests e2e
- [ ] Coverage >= seuil
- [ ] Security scan dépendances
- [ ] Build
- [ ] Audit UX PASS

## Handoff explicite vers DEV (H13)
- DEV implémente strictement S031 selon ce pack.
- Toute dérive de scope => retour PM obligatoire.
- Sortie attendue DEV: handoffs `S031-dev-to-uxqa.md` et `S031-dev-to-tea.md` avec preuves complètes.

## Status
READY_FOR_DEV
