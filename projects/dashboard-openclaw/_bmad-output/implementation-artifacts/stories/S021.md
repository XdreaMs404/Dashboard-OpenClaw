# S021 - Indicateur de fraîcheur/staleness des vues

canonical_story_id: E02-S09
epic: E02
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Scope canonique
- Story ID canonique: `E02-S09`
- FR clés: FR-029, FR-030
- NFR clés: NFR-006, NFR-012
- Risques: T08, P02
- Dépendance story: E02-S08

## Checklist Delivery
- [x] Implémentation conforme au scope canonique
- [x] Tests unit/intégration
- [x] Tests edge
- [x] Tests e2e
- [x] Coverage >= seuil
- [x] Security scan dépendances
- [x] Build
- [x] Audit UX prêt pour revue

## Critères d’acceptation S021
- [x] **AC-01 / FR-029**: `decisionFreshness[decisionId]` liste les artefacts justificatifs avec statut de fraîcheur.
- [x] **AC-02 / FR-030**: staleness explicite (`isStale`, `stalenessLevel`, `ARTIFACT_STALENESS_DETECTED`) en mode stale-but-available.
- [x] **AC-03**: priorité source respectée (`evidenceGraphResult` > `evidenceGraphInput`).
- [x] **AC-04**: propagation stricte des blocages amont S020 (`ARTIFACT_*`, `INVALID_ARTIFACT_*`, `EVIDENCE_LINK_INCOMPLETE`, `DECISION_NOT_FOUND`, `INVALID_EVIDENCE_GRAPH_INPUT`).
- [x] **AC-05**: incohérence ledger -> `EVENT_LEDGER_GAP_DETECTED` + action corrective.
- [x] **AC-06**: dépassement rebuild > 60000ms -> `PROJECTION_REBUILD_TIMEOUT` + action corrective.
- [x] **AC-07**: vue décisionnelle FR-029 enrichie sans doublons.
- [x] **AC-08**: contrat stable livré:
  `{ allowed, reasonCode, reason, diagnostics, stalenessBoard, decisionFreshness, correctiveActions }`.
- [x] **AC-09**: e2e UI états `empty/loading/error/success` + reason/counters/stale badges/actions.
- [x] **AC-10**: qualité/perf module conforme (coverage >=95/95, p95 <= 2s, lot < 60s sur 500 docs).

## Implémentation S021
### Fichiers touchés (strict S021)
- `app/src/artifact-staleness-indicator.js`
- `app/src/index.js` (export S021 uniquement)
- `app/tests/unit/artifact-staleness-indicator.test.js`
- `app/tests/edge/artifact-staleness-indicator.edge.test.js`
- `app/tests/e2e/artifact-staleness-indicator.spec.js`
- `_bmad-output/implementation-artifacts/stories/S021.md`
- `_bmad-output/implementation-artifacts/handoffs/S021-dev-to-uxqa.md`
- `_bmad-output/implementation-artifacts/handoffs/S021-dev-to-tea.md`
- `_bmad-output/implementation-artifacts/handoffs/S021-tech-gates.log`

### Résumé fonctionnel
1. Nouveau module `buildArtifactStalenessIndicator(input, options?)`.
2. Résolution de source canonique:
   - `evidenceGraphResult` prioritaire,
   - sinon délégation S020 via `evidenceGraphInput` (`buildArtifactEvidenceGraph`),
   - sinon fail-closed `INVALID_STALENESS_INPUT`.
3. Calcul staleness par artefact (`ageSeconds`, `isStale`, `stalenessLevel`) + agrégats de vue.
4. Support stale-but-available (retour `allowed=true` même si stale, avec `ARTIFACT_STALENESS_DETECTED`).
5. Enrichissement décisionnel FR-029 (`decisionFreshness`) avec artefacts justificatifs + statut fraîcheur.
6. Détection incidents:
   - gap ledger -> `EVENT_LEDGER_GAP_DETECTED`,
   - timeout rebuild -> `PROJECTION_REBUILD_TIMEOUT`.
7. Diagnostics complets (`artifactsCount`, `staleCount`, `staleRatio`, `maxAgeSeconds`, `rebuildDurationMs`, `durationMs`, `p95StalenessMs`, `sourceReasonCode`).

## Mapping AC → tests
- AC-01..AC-08 + AC-10:
  - `app/tests/unit/artifact-staleness-indicator.test.js`
  - `app/tests/edge/artifact-staleness-indicator.edge.test.js`
- AC-09:
  - `app/tests/e2e/artifact-staleness-indicator.spec.js`

## Couverture/performance S021
- `app/src/artifact-staleness-indicator.js`:
  - **99.64% lines**
  - **98.85% branches**
  - **100% functions**
  - **99.65% statements**
- Perf (test synthétique 500 docs):
  - `p95StalenessMs <= 2000`
  - `durationMs < 60000`

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/artifact-staleness-indicator.test.js tests/edge/artifact-staleness-indicator.edge.test.js`
4. `npx playwright test tests/e2e/artifact-staleness-indicator.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests cas limites (edge)
- [x] coverage >= seuil
- [x] security scan dépendances
- [x] build

## Status
- Dernière validation UX (UTC): 2026-02-23T14:29:20Z
- Dernière validation TEA (UTC): 2026-02-23T14:44:00Z
- Dernière validation reviewer (UTC): 2026-02-23T14:50:29Z
APPROVED_REVIEWER
READY_FOR_TECH_WRITER
