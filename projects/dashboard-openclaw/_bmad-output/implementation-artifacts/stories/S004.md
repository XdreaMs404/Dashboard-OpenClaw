# S004 - Capture owner/horodatage/statut de phase (FR-004/FR-005)

## Epic
E01

## Handoff courant
H13 PM → DEV (scope strict S004)

## User story
En tant qu’orchestrateur BMAD,
je veux disposer d’une projection d’état de phase qui expose les informations de pilotage (`owner`, horodatages, statut, durée) et l’état des prérequis d’activation,
afin de sécuriser les transitions et de rendre les blocages immédiatement actionnables.

## Dépendances
- **E01-S03 / S003** : source de vérité du blocage SLA de notification et des reason codes de transition.
- **S002** (`validatePhaseTransition`) : validation canonique de transition H01→H23.
- **S005-ready primitive** (`validatePhasePrerequisites`) : validation checklist pré-phase pour FR-005.
- **Planning E01-S04** (`_bmad-output/planning-artifacts/epics.md`) : source canonique story-level.
- **PRD** (`_bmad-output/planning-artifacts/prd.md`) : FR-004, FR-005, AC-004A/B, AC-005A/B, NFR-034, NFR-040.
- **Architecture** (`_bmad-output/planning-artifacts/architecture.md`) :
  - entité `PhaseState` (`owner`, `duration_ms`),
  - endpoints workflow `GET /api/v1/workflow/phases` et `GET /api/v1/workflow/phases/{phaseId}`,
  - métrique `m_phase_transition_latency_ms`.
- **Epics index** (`_bmad-output/planning-artifacts/epics-index.md`) : E01 = fondation canonique avant extensions.

## Traçabilité
- **FR-004** : afficher owner, started_at, finished_at, statut et durée pour chaque phase.
- **FR-005** : exiger les prérequis déclarés avant activation de la phase suivante.
- **AC PRD** : AC-004A, AC-004B, AC-005A, AC-005B.
- **NFR-034** : métriques clés disponibles en continu (diagnostics et latence de transition).
- **NFR-040** : time-to-first-value < 14 jours (lisibilité/explicabilité de la projection + blocages actionnables).
- **Risques couverts** : P06, P07.

## Critères d'acceptation (mesurables)
- [ ] **AC-01 — Projection nominale FR-004**
      `buildPhaseStateProjection` retourne systématiquement les champs:
  - `phaseId`, `owner`, `started_at`, `finished_at`, `status`, `duration_ms`
  - avec `status` dans `pending | running | done | blocked`.

- [ ] **AC-02 — Calcul de statut/durée déterministe**
      Pour une phase valide:
  - `startedAt && finishedAt` (`finishedAt >= startedAt`) -> `status=done`, `duration_ms = finishedAt-startedAt`
  - `startedAt && !finishedAt` -> `status=running`, `duration_ms = nowAt-startedAt`
  - `!startedAt && !finishedAt` -> `status=pending`, `duration_ms=null`.

- [ ] **AC-03 — Blocage transition/SLA propagé**
      Si validation de transition amont retourne `allowed=false` avec
      `TRANSITION_NOT_ALLOWED | PHASE_NOTIFICATION_MISSING | PHASE_NOTIFICATION_SLA_EXCEEDED`,
      la projection retourne:
  - `status=blocked`
  - `blockingReasonCode` + `blockingReason` explicites.

- [ ] **AC-04 — FR-005 activation gardée par prérequis**
      La projection expose un bloc `prerequisites` avec:
  - `requiredCount`, `satisfiedCount`, `missingPrerequisiteIds`
  - `activationAllowed` booléen
      et bloque l’activation (`activationAllowed=false`) si la checklist est absente/invalide/incomplète.

- [ ] **AC-05 — Codes de blocage prérequis explicites**
      En cas d’échec checklist, le résultat utilise strictement:
  - `PHASE_PREREQUISITES_MISSING`
  - `INVALID_PHASE_PREREQUISITES`
  - `PHASE_PREREQUISITES_INCOMPLETE`
      avec raison lisible et actionnable.

- [ ] **AC-06 — Entrées invalides robustes**
      `phaseId` invalide, owner vide/blanc, ou timestamps incohérents (`finishedAt < startedAt`) ->
  - `status=blocked`
  - `blockingReasonCode` dans `INVALID_PHASE_STATE | INVALID_PHASE_TIMESTAMPS`
  - aucune exception non contrôlée.

- [ ] **AC-07 — Contrat de sortie stable**
      La fonction retourne systématiquement:
      `{ phaseId, owner, started_at, finished_at, status, duration_ms, activationAllowed, prerequisites, blockingReasonCode, blockingReason, diagnostics }`
      avec `diagnostics` contenant au minimum:
  - `startedMs`, `finishedMs`, `nowMs`, `transitionReasonCode`, `prerequisiteReasonCode`, `durationComputationMs`.

- [ ] **AC-08 — Résolution de sources flexible**
  - `transitionValidation` injecté prioritaire, sinon `transitionInput` -> délégation `validatePhaseTransition`.
  - `prerequisiteValidation` injecté prioritaire, sinon `prerequisitesInput` -> délégation `validatePhasePrerequisites`.
  - absence de source exploitable pour FR-005 => blocage explicite `PHASE_PREREQUISITES_MISSING`.

- [ ] **AC-09 — UI e2e démonstrateur minimal**
      Couvrir `empty`, `loading`, `success`, `error` avec affichage explicite de:
  - owner/horodatages/statut/durée
  - `activationAllowed`
  - blocages (`blockingReasonCode`, `blockingReason`)
  - compteurs de prérequis.

- [ ] **AC-10 — Seuil qualité/performance module**
  - Couverture module S004 >= **95% lignes** et **95% branches**.
  - p95 projection `< 5000 ms` sur corpus de 500 entrées.
  - absence de régression sur S001..S003.

## Cas de test obligatoires
### Fonctionnels
- [ ] Cas nominal `done`: owner + started/finished valides.
- [ ] Cas nominal `running`: started valide, finished absent.
- [ ] Cas nominal `pending`: started/finished absents.
- [ ] Cas blocage SLA amont: `PHASE_NOTIFICATION_MISSING` / `PHASE_NOTIFICATION_SLA_EXCEEDED`.
- [ ] Cas checklist absente/invalide/incomplète -> blocage FR-005.
- [ ] Cas checklist complète -> `activationAllowed=true`.
- [ ] Cas timestamps invalides -> `INVALID_PHASE_TIMESTAMPS`.
- [ ] Cas phase/owner invalides -> `INVALID_PHASE_STATE`.
- [ ] Cas UI e2e: `empty -> loading -> error/success`.

### Non-régression
- [ ] `validatePhaseTransition` (S002) conserve son contrat et ses reason codes.
- [ ] `evaluatePhaseSlaAlert` (S003) conserve son contrat et ses reason codes.
- [ ] `validatePhasePrerequisites` conserve son contrat public.
- [ ] Les suites S001..S003 restent vertes.

### Sécurité / robustesse
- [ ] Validation stricte des entrées (phase, owner, dates, payload prerequis).
- [ ] Aucune mutation observable des objets d’entrée.
- [ ] Aucune exécution shell dans S004.
- [ ] Messages de blocage explicites et non ambigus.

## Scope DEV strict S004
### Autorisé
1. Implémenter/ajuster `buildPhaseStateProjection(input, options?)` dans `app/src/phase-state-projection.js`.
2. Intégrer la logique FR-005 via `validatePhasePrerequisites` (injection/délégation), sans implémenter S005 complet.
3. Exporter S004 dans `app/src/index.js` (export S004 uniquement si ajustement nécessaire).
4. Ajouter/adapter les tests S004:
   - `app/tests/unit/phase-state-projection.test.js`
   - `app/tests/edge/phase-state-projection.edge.test.js`
   - `app/tests/e2e/phase-state-projection.spec.js`
5. Ajuster **minimalement** `app/src/phase-prerequisites-validator.js` uniquement si requis par intégration S004, sans dérive fonctionnelle S005.
6. Mettre à jour la story S004 + handoffs DEV (`S004-dev-to-uxqa.md`, `S004-dev-to-tea.md`) avec preuves.

### Interdit (hors-scope)
- Toute évolution hors FR-004/FR-005 / S004.
- Toute implémentation des scripts sequence-guard / ultra-quality-check (scope S005/S006).
- Tout refactor transverse non requis par les AC S004.
- Toute modification fonctionnelle hors S004 non strictement nécessaire.

## Contraintes
- `BMAD_PHASE_ORDER` reste la source canonique des phases.
- Transition/SLA: S002/S003 restent sources de vérité (pas de duplication contradictoire).
- Prérequis: blocage explicite avant activation de phase suivante (FR-005).
- Contrat de sortie déterministe, reason codes stables, diagnostics exploitables.
- Story non-DONE tant que **G4-T** et **G4-UX** ne sont pas tous deux PASS.

## Implémentation
### À réaliser (DEV)
- Implémentation module + tests + e2e + evidence gates selon scope S004.

## Review
- [ ] Mapping AC → tests documenté.
- [ ] Vérification explicite FR-004/FR-005 + NFR-034/NFR-040.
- [ ] Vérification couverture >= 95% lignes + branches.
- [ ] Résultat gates techniques publié (PASS/CONCERNS/FAIL).

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/phase-state-projection.test.js tests/edge/phase-state-projection.edge.test.js`
4. `npx playwright test tests/e2e/phase-state-projection.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`

## Quality Gates obligatoires
- [ ] lint
- [ ] typecheck
- [ ] tests unit/intégration
- [ ] tests e2e
- [ ] tests cas limites (edge)
- [ ] coverage >= seuil
- [ ] security scan dépendances
- [ ] build

## Règle Story DONE
- Interdit de passer DONE si un seul gate échoue (technique OU UX).
- Audit UX obligatoire: `_bmad-output/implementation-artifacts/ux-audits/<SID>-ux-audit.json` avec verdict PASS.
- Utiliser `bash scripts/story-done-guard.sh <SID>` pour valider la fin.

## UX Gates obligatoires
- [ ] conformité design-system (tokens, spacing, typo, composants)
- [ ] accessibilité WCAG 2.2 AA (minimum)
- [ ] responsive (mobile/tablet/desktop)
- [ ] états d'interface (loading/empty/error/success)
- [ ] hiérarchie visuelle et lisibilité
- [ ] evidence UX fournie (captures/rapports)

## Status
READY_FOR_DEV
