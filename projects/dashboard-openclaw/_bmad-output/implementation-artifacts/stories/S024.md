# S024 - Backfill historique + migration corpus existant

canonical_story_id: E02-S12
epic: E02
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Scope canonique
- Story ID canonique: `E02-S12`
- FR clés: FR-032, FR-021
- NFR clés: NFR-038, NFR-003
- Risques: T02, T03
- Dépendance story: E02-S11 (S023)

## Checklist Delivery
- [x] Implémentation conforme au scope canonique
- [x] Tests unit/intégration
- [x] Tests edge
- [x] Tests e2e
- [x] Coverage >= seuil
- [x] Security scan dépendances *(pris en charge par gates globaux)*
- [x] Build *(pris en charge par gates globaux)*
- [x] Audit UX prêt pour revue

## Critères d’acceptation S024
- [x] **AC-01 / FR-032**: migration historique conserve `riskTags` + `contextAnnotations` dans `migratedArtifacts`.
- [x] **AC-02 / FR-021**: ingestion limitée aux roots allowlist + extensions supportées markdown/yaml.
- [x] **AC-03 / NFR-038**: contrat S023 préservé, propagation stricte des blocages amont sans rupture.
- [x] **AC-04 / NFR-003**: performance lot respectée (`p95BatchMs <= 5000`, lot `< 60000ms` sur 500 docs).
- [x] **AC-05**: idempotence path+hash (`dedupKey`) sans duplication en re-run.
- [x] **AC-06**: reprise checkpoint via `resumeToken` sans retraitement des lots validés.
- [x] **AC-07**: saturation queue -> `BACKFILL_QUEUE_SATURATED` + action `THROTTLE_BACKFILL_QUEUE`.
- [x] **AC-08**: entrée/payload invalides -> `INVALID_BACKFILL_INPUT` avec diagnostics exploitables.
- [x] **AC-09**: contrat stable livré:
  `{ allowed, reasonCode, reason, diagnostics, migratedArtifacts, skippedArtifacts, failedArtifacts, migrationReport, correctiveActions }`.
- [x] **AC-10**: qualité module >=95% lignes/branches + e2e états UX.

## Implémentation S024
### Fichiers touchés (strict S024)
- `app/src/artifact-corpus-backfill.js`
- `app/src/index.js` (export S024)
- `app/tests/unit/artifact-corpus-backfill.test.js`
- `app/tests/edge/artifact-corpus-backfill.edge.test.js`
- `app/tests/e2e/artifact-corpus-backfill.spec.js`
- `_bmad-output/implementation-artifacts/stories/S024.md`
- `_bmad-output/implementation-artifacts/handoffs/S024-dev-to-uxqa.md`
- `_bmad-output/implementation-artifacts/handoffs/S024-dev-to-tea.md`

### Résumé fonctionnel
1. Résolution source stricte: `riskAnnotationsResult` prioritaire, sinon délégation S023 via `riskAnnotationsInput`, sinon `legacyArtifacts`.
2. Propagation fail-closed des reason codes bloquants S023 (`ARTIFACT_*`, `INVALID_*`, `PARSE_*`, `RISK_*`).
3. Validation stricte allowlist/extensions et format input (`batchSize`, `queueDepth`, `resumeToken`, compat corpus).
4. Backfill par lots idempotents avec `dedupKey` stable (`artifactPath::hash`).
5. Reprise checkpoint: `resumeToken.nextOffset` + `processedDedupKeys` réutilisables, `completed` explicite.
6. Gestion incidents S024: `BACKFILL_QUEUE_SATURATED`, `MIGRATION_CORPUS_INCOMPATIBLE`, `BACKFILL_BATCH_FAILED`, `INVALID_BACKFILL_INPUT`.
7. Diagnostics complets: `requestedCount`, `migratedCount`, `skippedCount`, `failedCount`, `batchCount`, `durationMs`, `p95BatchMs`, `sourceReasonCode`.
8. Validation story confirmée en fin de cycle: reviewer **APPROVED**, G4-T **PASS** (`S024-tech-gates.log`) et G4-UX **PASS** (`S024-ux-audit.json`).

## Mapping AC -> tests
- AC-01..AC-10 (fonctionnel + erreurs + perf):
  - `app/tests/unit/artifact-corpus-backfill.test.js`
  - `app/tests/edge/artifact-corpus-backfill.edge.test.js`
- AC UX states/a11y/responsive:
  - `app/tests/e2e/artifact-corpus-backfill.spec.js`

## Couverture/performance S024
- `app/src/artifact-corpus-backfill.js`:
  - **99.72% statements**
  - **98.22% branches**
  - **100% functions**
  - **99.71% lines**
- Perf synthétique (500 docs):
  - `p95BatchMs <= 5000`
  - `durationMs < 60000`

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/artifact-corpus-backfill.test.js tests/edge/artifact-corpus-backfill.edge.test.js`
4. `npx playwright test tests/e2e/artifact-corpus-backfill.spec.js`
5. `npx vitest run tests/unit/artifact-corpus-backfill.test.js tests/edge/artifact-corpus-backfill.edge.test.js --coverage --coverage.include=src/artifact-corpus-backfill.js`
6. `npm run build && npm run security:deps`
7. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-fast-quality-gates.sh S024`
8. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-ux-gates.sh S024`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests edge
- [x] coverage >= seuil
- [x] fast quality gates S024

## Status
- Dernière validation UX (UTC): 2026-02-23T21:13:21Z
- Dernière validation TEA (UTC): 2026-02-23T21:17:00Z
- Dernière validation reviewer (UTC): 2026-02-23T21:25:40Z
APPROVED_REVIEWER
READY_FOR_TECH_WRITER
