# S023 - Tags risques et annotations contextuelles

canonical_story_id: E02-S11
epic: E02
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Scope canonique
- Story ID canonique: `E02-S11`
- FR clés: FR-031, FR-032
- NFR clés: NFR-016, NFR-038
- Risques: T01, T02
- Dépendance story: E02-S10

## Checklist Delivery
- [x] Implémentation conforme au scope canonique
- [x] Tests unit/intégration
- [x] Tests edge
- [x] Tests e2e
- [x] Coverage >= seuil
- [x] Security scan dépendances
- [x] Build
- [x] Audit UX prêt pour revue

## Critères d’acceptation S023
- [x] **AC-01 / FR-031**: chaque parse issue est convertie en annotation exploitable (`what`, `why`, `nextAction`) avec recommandation.
- [x] **AC-02 / FR-032**: tags risques normalisés + annotations contextuelles par artefact.
- [x] **AC-03**: résolution source stricte (`parseDiagnosticsResult` prioritaire, sinon délégation `parseDiagnosticsInput`).
- [x] **AC-04**: propagation stricte des blocages amont S022.
- [x] **AC-05**: tags sans doublons, tri stable, agrégation `riskTagCatalog`.
- [x] **AC-06**: artefact sans tags requis -> `RISK_TAGS_MISSING` + corrective action.
- [x] **AC-07**: conflit annotation/tags -> `RISK_ANNOTATION_CONFLICT`.
- [x] **AC-08**: contrat stable livré:
  `{ allowed, reasonCode, reason, diagnostics, taggedArtifacts, contextAnnotations, riskTagCatalog, correctiveActions }`.
- [x] **AC-09**: e2e UI états `empty/loading/error/success` + reason/counters/tags/annotations/catalog/actions.
- [x] **AC-10**: qualité/perf module conforme (coverage >=95/95, p95 <= 2s, lot < 60s sur 500 docs).

## Implémentation S023
### Fichiers touchés (strict S023)
- `app/src/artifact-risk-annotations.js`
- `app/src/index.js` (export S023 uniquement)
- `app/tests/unit/artifact-risk-annotations.test.js`
- `app/tests/edge/artifact-risk-annotations.edge.test.js`
- `app/tests/e2e/artifact-risk-annotations.spec.js`
- `_bmad-output/implementation-artifacts/stories/S023.md`
- `_bmad-output/implementation-artifacts/handoffs/S023-dev-to-uxqa.md`
- `_bmad-output/implementation-artifacts/handoffs/S023-dev-to-tea.md`
- `_bmad-output/implementation-artifacts/handoffs/S023-tech-gates.log`

### Résumé fonctionnel
1. Nouveau module `annotateArtifactRiskContext(input, options?)` avec contrat stable S023.
2. Priorité source: `parseDiagnosticsResult` > délégation S022 via `parseDiagnosticsInput`.
3. Propagation stricte des reason codes de blocage amont S022.
4. Génération de `taggedArtifacts` déterministes (tri stable, tags normalisés, sévérité et ownerHint).
5. Génération de `contextAnnotations` actionnables (`what/why/nextAction`) alignées FR-031.
6. Agrégation `riskTagCatalog` (fréquence + sévérité max) avec tri stable.
7. Contrôles S023 dédiés:
   - `RISK_TAGS_MISSING`
   - `RISK_ANNOTATION_CONFLICT`
   - `INVALID_RISK_ANNOTATION_INPUT`
8. Diagnostics complets:
   `artifactsTaggedCount`, `annotationsCount`, `highRiskCount`, `retryLimitedCount`, `dlqCount`, `durationMs`, `p95TaggingMs`, `sourceReasonCode`.

## Mapping AC → tests
- AC-01..AC-08 + AC-10:
  - `app/tests/unit/artifact-risk-annotations.test.js`
  - `app/tests/edge/artifact-risk-annotations.edge.test.js`
- AC-09:
  - `app/tests/e2e/artifact-risk-annotations.spec.js`

## Couverture/performance S023
- `app/src/artifact-risk-annotations.js`:
  - **99.08% lines**
  - **95.84% branches**
  - **100% functions**
  - **99.12% statements**
- Perf (test synthétique 500 docs):
  - `p95TaggingMs <= 2000`
  - `durationMs < 60000`

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/artifact-risk-annotations.test.js tests/edge/artifact-risk-annotations.edge.test.js`
4. `npx playwright test tests/e2e/artifact-risk-annotations.spec.js`
5. `npx vitest run tests/unit/artifact-risk-annotations.test.js tests/edge/artifact-risk-annotations.edge.test.js --coverage --coverage.include=src/artifact-risk-annotations.js`
6. `npm run build && npm run security:deps`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests cas limites (edge)
- [x] coverage >= seuil
- [x] security scan dépendances
- [x] build

## Status
READY_FOR_UXQA_TEA
