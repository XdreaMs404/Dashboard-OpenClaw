# S018 - Filtrage contextuel phase/agent/date/gate (FR-026/FR-027)

## Epic
E02

## Handoff courant
H14 UXQA + H16 TEA (handoff DEV complété, scope strict S018)

## User story
En tant qu’orchestrateur BMAD,
je veux appliquer des filtres contextuels fiables sur les résultats de recherche d’artefacts,
afin de réduire le bruit décisionnel et préparer la comparaison version-vers-version des artefacts critiques.

## Dépendances
- **S017** (`searchArtifactsFullText`) : source primaire des résultats de recherche FR-025.
- **S016** (`indexArtifactMarkdownTables`) : source de vérité de l’index artefact + blocages amont.
- **S015 / S014 / S013 / S012 / S011** : pipeline ingestion → metadata → sections → tables → recherche.
- **Planning E02-S06** (`_bmad-output/planning-artifacts/epics.md`) : story canonique FR-026/FR-027.
- **PRD** (`_bmad-output/planning-artifacts/prd.md`) : FR-026, FR-027, AC-026A/B, AC-027A/B, NFR-038, NFR-003.
- **Architecture** (`_bmad-output/planning-artifacts/architecture.md`) :
  - service `svc-search`,
  - endpoint cible `GET /api/v1/artifacts/search`,
  - projection cible `projection.artifact.search`.
- **Epics index** (`_bmad-output/planning-artifacts/epics-index.md`) : E02 dépend de E01 (cohérence de séquencement).

## Traçabilité
- **FR-026** : filtrer par phase, agent, date, gate, owner et niveau de risque.
- **FR-027 (préparation)** : préparer la comparaison version-vers-version via des candidats de diff déterministes.
- **AC PRD** : AC-026A, AC-026B, AC-027A, AC-027B.
- **NFR-038** : aucune rupture sur corpus de référence.
- **NFR-003** : p95 < 5s (filtrage/requête contextuelle).
- **Risques couverts** : T01, T02.

## Critères d'acceptation (mesurables)
- [ ] **AC-01 — Filtrage contextuel nominal (FR-026)**
      Pour un jeu de résultats de recherche valide, `applyArtifactContextFilters` retourne :
  - `allowed: true`
  - `reasonCode: "OK"`
  - `filteredResults` contenant uniquement les artefacts correspondant aux filtres demandés
  - `diagnostics.filteredCount` cohérent avec les éléments retenus.

- [ ] **AC-02 — Support complet des filtres FR-026**
      Les filtres `phase`, `agent`, `dateFrom/dateTo`, `gate`, `owner`, `riskLevel` sont appliqués en intersection stricte, avec :
  - `appliedFilters` explicitant les valeurs normalisées,
  - `diagnostics.filteredOutCount` reflétant les exclusions.

- [ ] **AC-03 — Ordonnancement déterministe**
      Les résultats filtrés restent triés de façon stable (`score` décroissant puis `artifactPath`) sans variation non déterministe entre deux runs identiques.

- [ ] **AC-04 — Entrées invalides**
      Filtres/pagination invalides (types incorrects, date incohérente, tableau vide invalide) ->
  - `allowed: false`
  - `reasonCode: "INVALID_ARTIFACT_CONTEXT_FILTER_INPUT"`
  - aucune exception non contrôlée.

- [ ] **AC-05 — Résolution des sources flexible**
  - `searchResult` injecté -> utilisé tel quel
  - sinon `searchInput` -> délégation à S017 (`searchArtifactsFullText`)
  - absence de source exploitable -> `INVALID_ARTIFACT_CONTEXT_FILTER_INPUT`.

- [ ] **AC-06 — Propagation stricte des blocages amont**
      Si S017/S016 est bloquant (`ARTIFACT_PATH_NOT_ALLOWED | UNSUPPORTED_ARTIFACT_TYPE | ARTIFACT_READ_FAILED | ARTIFACT_PARSE_FAILED | ARTIFACT_METADATA_MISSING | ARTIFACT_METADATA_INVALID | ARTIFACT_SECTIONS_MISSING | ARTIFACT_TABLES_MISSING | INVALID_ARTIFACT_SEARCH_INPUT`), S018 :
  - propage strictement le `reasonCode` et la `reason`,
  - conserve `allowed: false`,
  - expose des `correctiveActions` explicites.

- [ ] **AC-07 — Préparation FR-027 (diff candidates)**
      La sortie expose `diffCandidates` déterministes regroupant les résultats comparables (même artefact logique avec versions distinctes), avec :
  - `groupKey` stable,
  - `artifactIds` ordonnés,
  - action recommandée `RUN_ARTIFACT_DIFF` si au moins un groupe éligible.

- [ ] **AC-08 — Contrat de sortie stable**
      La fonction retourne systématiquement :
      `{ allowed, reasonCode, reason, diagnostics, filteredResults, appliedFilters, diffCandidates, correctiveActions }`
      avec :
  - `reasonCode` dans
    `OK | ARTIFACT_PATH_NOT_ALLOWED | UNSUPPORTED_ARTIFACT_TYPE | ARTIFACT_READ_FAILED | ARTIFACT_PARSE_FAILED | ARTIFACT_METADATA_MISSING | ARTIFACT_METADATA_INVALID | ARTIFACT_SECTIONS_MISSING | ARTIFACT_TABLES_MISSING | INVALID_ARTIFACT_SEARCH_INPUT | INVALID_ARTIFACT_CONTEXT_FILTER_INPUT`
  - `diagnostics` contenant au minimum
    `requestedCount`, `filteredCount`, `filteredOutCount`, `diffCandidateGroupsCount`, `durationMs`, `p95FilterMs`, `sourceReasonCode`.

- [ ] **AC-09 — UI e2e démonstrateur minimal**
      Couvrir `empty`, `loading`, `success`, `error` avec affichage explicite :
  - `reasonCode`
  - `reason`
  - `appliedFilters`
  - `filteredCount`/`filteredOutCount`
  - `diffCandidates`
  - `correctiveActions`.

- [ ] **AC-10 — Seuil qualité/performance module**
  - Couverture module S018 >= **95% lignes** et **95% branches**.
  - Benchmark corpus 500 docs :
    - `p95FilterMs <= 5000`
    - durée lot complet `< 60000 ms`.
  - Compatibilité corpus de référence sans rupture (NFR-038).

## Cas de test obligatoires
### Fonctionnels
- [ ] Cas nominal: filtres contextuels simples (`phase`, `owner`) -> résultats cohérents.
- [ ] Cas intersection multi-filtres (`phase+agent+gate+riskLevel`) -> exclusions correctes.
- [ ] Cas bornes temporelles (`dateFrom/dateTo`) -> filtrage strict dans fenêtre.
- [ ] Cas aucun résultat après filtre -> `allowed=true`, `reasonCode=OK`, `filteredResults=[]`.
- [ ] Cas délégation S017 via `searchInput` -> résolution correcte.
- [ ] Cas propagation blocage amont -> reason code strictement propagé.
- [ ] Cas préparation diff -> `diffCandidates` stables et action `RUN_ARTIFACT_DIFF` si éligible.
- [ ] Cas UI e2e: `empty -> loading -> error/success`.

### Non-régression
- [ ] `searchArtifactsFullText` (S017) conserve son contrat public et ses reason codes.
- [ ] `indexArtifactMarkdownTables` (S016) conserve son contrat public et ses reason codes.
- [ ] Les suites S001..S017 restent vertes.
- [ ] Aucun changement de comportement non requis hors scope S018.

### Sécurité / robustesse
- [ ] Validation stricte des entrées (`filters`, `dateRange`, `pagination`, payload search result).
- [ ] Aucune exécution shell dans S018.
- [ ] Aucune mutation observable des entrées.
- [ ] Normalisation déterministe des filtres (pas d’ambiguïté de casse/format).

## Scope DEV strict S018
### Autorisé
1. Implémenter `applyArtifactContextFilters(input, options?)` dans `app/src/artifact-context-filter.js`.
2. Exporter S018 dans `app/src/index.js` (export S018 uniquement).
3. Ajouter/adapter les tests S018:
   - `app/tests/unit/artifact-context-filter.test.js`
   - `app/tests/edge/artifact-context-filter.edge.test.js`
   - `app/tests/e2e/artifact-context-filter.spec.js`
4. Ajuster **minimalement** `app/src/artifact-fulltext-search.js` uniquement si nécessaire au partage utilitaire, sans changement de comportement S017.
5. Mettre à jour la story S018 + handoffs DEV (`S018-dev-to-uxqa.md`, `S018-dev-to-tea.md`) avec preuves d’exécution.

### Interdit (hors-scope)
- Toute évolution hors FR-026/FR-027 / S018.
- Toute implémentation complète du moteur diff version-vers-version (scope S019).
- Toute modification fonctionnelle des stories S001..S017 non strictement nécessaire à l’intégration S018.
- Tout refactor transverse non requis par les AC S018.
- Toute exécution shell depuis les modules S018.

## Contraintes
- S017 reste la source de vérité pour la recherche full-text brute.
- S018 applique des filtres contextuels déterministes, sans réécrire le moteur de recherche S017.
- Préparation FR-027 limitée à `diffCandidates` (pas de rendu diff complet dans S018).
- Contrat de sortie stable et reason codes bornés.
- Story non-DONE tant que **G4-T** et **G4-UX** ne sont pas tous deux PASS.

## Implémentation
### À réaliser (DEV)
- Implémentation module + tests + e2e + evidence gates conformément au scope S018 ci-dessus.

## Review
- [ ] Mapping AC → tests documenté.
- [ ] Vérification explicite des seuils performance NFR-003 / NFR-038.
- [ ] Vérification couverture module >= 95% lignes + branches.
- [ ] Résultat gates techniques publié (PASS/CONCERNS/FAIL).

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/artifact-context-filter.test.js tests/edge/artifact-context-filter.edge.test.js`
4. `npx playwright test tests/e2e/artifact-context-filter.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`

## Quality Gates obligatoires
- [ ] lint
- [ ] typecheck
- [ ] tests unit/intégration
- [ ] tests e2e
- [ ] tests cas limites (edge)
- [ ] coverage >= seuil
- [ ] security scan dépendances
- [ ] build

## Règle Story DONE
- Interdit de passer DONE si un seul gate échoue (technique OU UX).
- Audit UX obligatoire: `_bmad-output/implementation-artifacts/ux-audits/<SID>-ux-audit.json` avec verdict PASS.
- Utiliser `bash scripts/story-done-guard.sh <SID>` pour valider la fin.

## UX Gates obligatoires
- [ ] conformité design-system (tokens, spacing, typo, composants)
- [ ] accessibilité WCAG 2.2 AA (minimum)
- [ ] responsive (mobile/tablet/desktop)
- [ ] états d'interface (loading/empty/error/success)
- [ ] hiérarchie visuelle et lisibilité
- [ ] evidence UX fournie (captures/rapports)

## Exécution DEV (preuves H13/H16)
- Date exécution gates (UTC): 2026-02-22T11:03:05Z → 2026-02-22T11:03:18Z
- Commandes rejouées (depuis `app/`):
  - `npm run lint`
  - `npm run typecheck`
  - `npx vitest run tests/unit/artifact-context-filter.test.js tests/edge/artifact-context-filter.edge.test.js`
  - `npx playwright test tests/e2e/artifact-context-filter.spec.js`
  - `npm run test:coverage`
  - `npm run build`
  - `npm run security:deps`
- Résultat gates techniques: **PASS** (preuve: `_bmad-output/implementation-artifacts/handoffs/S018-tech-gates.log`)
- Couverture module `app/src/artifact-context-filter.js`: **99.63% lignes / 98.29% branches** (>= 95% requis)
- E2E S018: **2/2 PASS** (états `empty/loading/error/success` couverts)

## Status
READY_FOR_UXQA_TEA
