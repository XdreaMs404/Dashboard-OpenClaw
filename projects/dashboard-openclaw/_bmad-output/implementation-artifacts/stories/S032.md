# S032 - Simulation de verdict pré-soumission

canonical_story_id: E03-S08
epic: E03
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Handoff courant
H12 PM -> DEV (pack story prêt pour H13)

## Scope canonique
- Story ID canonique: `E03-S08`
- FR clés: FR-018, FR-019
- NFR clés: NFR-018, NFR-029
- Risques: U03, T07
- Dépendance story: E03-S07 (S031)

## User story
En tant qu’orchestrateur BMAD,
je veux simuler un verdict gate avant soumission finale et visualiser une tendance PASS/CONCERNS/FAIL par phase et période,
afin d’anticiper les blocages, réduire les faux DONE et décider avec une chaîne de preuve complète.

## Dépendances
- **S031** (`versionGatePolicy`, `simulateGateVerdictBeforeSubmission`) : base versioning + simulation pré-submit.
- **S030** (`createGateConcernsAction`) : contexte des actions CONCERNS amont.
- **S029/S028** : garanties preuve primaire + blocage DONE.
- **Planning canonique** : `epics.md` section `E03-S08`.
- **PRD** : FR-018, FR-019, NFR-018, NFR-029.

## Traçabilité
- **FR-018**: simulation de verdict avant soumission finale.
- **FR-019**: tendances PASS/CONCERNS/FAIL par phase et période.
- **NFR-018**: précision baseline >= 65%.
- **NFR-029**: chaîne de preuve complète obligatoire.
- **Risques couverts**: U03 (non-conformité UX/a11y), T07 (faux DONE via mauvais câblage G4-UX).

## Critères d’acceptation (mesurables)
- [ ] **AC-01 (FR-018) — Simulation pré-soumission exécutable**
      Simulation disponible avant soumission finale, sans effet de bord:
  - `allowed=true`
  - `reasonCode="OK"`
  - `simulation.eligible=true`
  - `simulation.nonMutative=true`
  - `simulation.simulatedVerdict` présent (`PASS|CONCERNS|FAIL`).

- [ ] **AC-02 (FR-018) — Entrée simulation invalide bloquée**
      Entrée invalide/incomplète:
  - `allowed=false`
  - `reasonCode="INVALID_GATE_SIMULATION_INPUT"`
  - `simulation.eligible=false`.

- [ ] **AC-03 (FR-019) — Tendance phase+période obligatoire**
      La sortie inclut `trendSnapshot` agrégé par phase et période:
  - `trendSnapshot.phase` non vide
  - `trendSnapshot.period` non vide
  - compteurs `passCount`, `concernsCount`, `failCount`, `totalCount` cohérents
  - `trendSnapshot.trendDirection` présent (`UP|FLAT|DOWN`).

- [ ] **AC-04 (FR-019) — Fenêtre de tendance invalide**
      Si fenêtre de période invalide (bornes/format incohérents):
  - `allowed=false`
  - `reasonCode="SIMULATION_TREND_WINDOW_INVALID"`
  - `correctiveActions` inclut `FIX_TREND_WINDOW_INPUT`.

- [ ] **AC-05 (NFR-029) — Chaîne de preuve complète**
      Toute simulation exploitable pour décision doit inclure:
  - `evidenceChain.primaryEvidenceRefs` non vide
  - `evidenceChain.trendEvidenceRefs` non vide
  - sinon `reasonCode="EVIDENCE_CHAIN_INCOMPLETE"`.

- [ ] **AC-06 — Résolution source stricte**
  - `policyVersionResult` injecté -> utilisé tel quel
  - sinon `policyVersionInput` -> délégation S031 (`versionGatePolicy`)
  - sinon `INVALID_PRE_SUBMIT_SIMULATION_INPUT`.

- [ ] **AC-07 — Propagation stricte des blocages amont**
      Les reason codes bloquants S031/S030/S029/S028/S027 sont propagés sans réécriture (fail-closed).

- [ ] **AC-08 — Contrat de sortie stable**
      La sortie respecte systématiquement:
      `{ allowed, reasonCode, reason, diagnostics, simulation, trendSnapshot, evidenceChain, correctiveActions }`.

- [ ] **AC-09 (NFR-018) — Baseline précision simulation**
      Précision >= 65% sur dataset de validation versionné (simulation + tendance).

- [ ] **AC-10 — Qualité/performance**
      Couverture module >= 95% lignes + 95% branches,
      `p95SimulationMs <= 2000` sur 500 simulations,
      et e2e 4 états `empty/loading/error/success` avec affichage `reasonCode/simulatedVerdict/trendSnapshot/evidenceChain`.

## Cas de test obligatoires
### Fonctionnels
- [ ] Simulation nominale non mutative -> `OK`.
- [ ] Simulation invalide -> `INVALID_GATE_SIMULATION_INPUT`.
- [ ] Tendance calculée avec compteurs cohérents sur période valide.
- [ ] Fenêtre de tendance invalide -> `SIMULATION_TREND_WINDOW_INVALID`.
- [ ] Chaîne preuve incomplète -> `EVIDENCE_CHAIN_INCOMPLETE`.
- [ ] Délégation S031 via `policyVersionInput`.

### Non-régression
- [ ] Contrat public S031 inchangé.
- [ ] Contrat public S030/S029/S028/S027 inchangé.
- [ ] Suites existantes S001..S031 restent vertes.

### Sécurité / robustesse
- [ ] Validation stricte des entrées (fenêtre période, phase, payload simulation, preuves).
- [ ] Aucune mutation inattendue des entrées.
- [ ] Aucune exécution shell dans les modules S032.

## Scope DEV strict S032
### Autorisé
1. Étendre `simulateGateVerdictBeforeSubmission(input, options?)` dans `app/src/gate-pre-submit-simulation.js` pour intégrer `trendSnapshot` + `evidenceChain`.
2. Implémenter `buildSimulationTrendSnapshot(input, options?)` dans `app/src/gate-simulation-trends.js`.
3. Exporter S032 dans `app/src/index.js` (exports S032 uniquement).
4. Ajouter/adapter les tests S032:
   - `app/tests/unit/gate-pre-submit-simulation.test.js`
   - `app/tests/edge/gate-pre-submit-simulation.edge.test.js`
   - `app/tests/unit/gate-simulation-trends.test.js`
   - `app/tests/edge/gate-simulation-trends.edge.test.js`
   - `app/tests/e2e/gate-pre-submit-simulation.spec.js`
5. Ajustement minimal de `app/src/gate-policy-versioning.js` uniquement si nécessaire au branchement S032, sans changement fonctionnel S031.
6. Mettre à jour les handoffs DEV S032:
   - `_bmad-output/implementation-artifacts/handoffs/S032-dev-to-uxqa.md`
   - `_bmad-output/implementation-artifacts/handoffs/S032-dev-to-tea.md`

### Interdit (hors-scope)
- Tableau de bord tendances complet multi-vues/export (scope S033+).
- Export rapport gate (scope S034+).
- Refactor transverse non requis par les AC S032.

## Contraintes
- Scope strict S032 uniquement.
- Fail-closed par défaut sur ambiguïté simulation/tendance/preuve.
- Simulation strictement non mutative.
- Aucune décision exploitable sans chaîne de preuve complète.

## Plan de preuve / gates
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/gate-pre-submit-simulation.test.js tests/edge/gate-pre-submit-simulation.edge.test.js tests/unit/gate-simulation-trends.test.js tests/edge/gate-simulation-trends.edge.test.js`
4. `npx playwright test tests/e2e/gate-pre-submit-simulation.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`
7. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-story-gates.sh S032`
8. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-ux-gates.sh S032`

## Checklist Delivery
- [ ] Implémentation conforme au scope canonique
- [ ] Tests unit/intégration
- [ ] Tests edge
- [ ] Tests e2e
- [ ] Coverage >= seuil
- [ ] Security scan dépendances
- [ ] Build
- [ ] Audit UX PASS

## Handoff explicite vers DEV (H13)
- DEV implémente strictement S032 selon ce pack.
- Toute dérive de scope => retour PM obligatoire.
- Sortie attendue DEV: handoffs `S032-dev-to-uxqa.md` et `S032-dev-to-tea.md` avec preuves complètes.

## Status
READY_FOR_DEV
