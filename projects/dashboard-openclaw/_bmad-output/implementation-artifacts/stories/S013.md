# S013 - Pipeline d’ingestion d’artefacts markdown/yaml sous allowlist (FR-021/FR-022)

## Epic
E02

## Handoff courant
H13 PM → DEV (scope strict S013)

## User story
En tant qu’orchestrateur BMAD,
je veux ingérer les artefacts markdown/yaml uniquement depuis des racines autorisées avec validation metadata minimale,
afin d’alimenter un socle de preuve fiable, traçable et exploitable pour les décisions de gate.

## Dépendances
- **Socle E01 (S001..S010)** : stabilité workflow/gates/diagnostics requise avant ingestion E02.
- **Planning E02-S01** (`_bmad-output/planning-artifacts/epics.md`) : story source de vérité pour FR-021/FR-022.
- **PRD FR-021/FR-022** (`_bmad-output/planning-artifacts/prd.md`) : exigences d’ingestion + metadata obligatoires.
- **Architecture AR** (`_bmad-output/planning-artifacts/architecture.md`) : alignement `svc-artifact-ingestor` + eventing artefact.

## Traçabilité
- **FR-021** : ingérer les artefacts markdown/yaml des dossiers BMAD autorisés.
- **FR-022** : vérifier `stepsCompleted` et `inputDocuments` sur artefacts majeurs.
- **AC-021A / AC-022A (PRD)** : performance pertinente p95 `< 2s` sur corpus 500 docs.
- **AC-021B / AC-022B (PRD)** : détection/flag 100% des metadata manquantes selon policy.
- **NFR-003** : p95 traitement delta `< 5s`.
- **NFR-004** : p95 `< 2s` sur 500 documents.
- **H06-UXC-06 / H06-UXC-10** : intention décisionnelle explicite + cas limites/payloads négatifs complets.
- **Risques couverts** : T01, T02, P02.

## Critères d'acceptation (mesurables)
- [x] **AC-01 — Ingestion nominale allowlist**
      Pour un lot d’artefacts `.md|.markdown|.yaml|.yml` tous situés sous `allowlistRoots`, `ingestBmadArtifacts` retourne:
  - `allowed: true`
  - `reasonCode: "OK"`
  - `diagnostics.ingestedCount = diagnostics.requestedCount`
  - `rejectedArtifacts: []`

- [x] **AC-02 — Blocage hors allowlist (FR-021)**
      Si au moins un artefact est hors `allowlistRoots`, la sortie retourne:
  - `allowed: false`
  - `reasonCode: "ARTIFACT_PATH_NOT_ALLOWED"`
  - `rejectedArtifacts` contient le chemin refusé + raison explicite
  - `correctiveActions` contient `RESTRICT_TO_ALLOWED_ROOTS`

- [x] **AC-03 — Blocage extension non supportée**
      Si un artefact a une extension non autorisée (`.json`, `.txt`, etc.), la sortie retourne:
  - `allowed: false`
  - `reasonCode: "UNSUPPORTED_ARTIFACT_TYPE"`
  - aucune exception non contrôlée

- [x] **AC-04 — Metadata obligatoire présente (FR-022)**
      Pour chaque artefact majeur (par défaut `prd.md`, `architecture.md`, `ux.md`, `epics.md`, `readiness-check.md`), absence de `stepsCompleted` ou `inputDocuments` =>
  - `allowed: false`
  - `reasonCode: "ARTIFACT_METADATA_MISSING"`
  - `diagnostics.missingMetadataCount` incrémenté
  - `correctiveActions` contient `ADD_REQUIRED_METADATA`

- [x] **AC-05 — Metadata invalide**
      Si `stepsCompleted` ou `inputDocuments` existent mais ne respectent pas le contrat attendu (tableau non vide de chaînes), la sortie retourne:
  - `allowed: false`
  - `reasonCode: "ARTIFACT_METADATA_INVALID"`
  - `rejectedArtifacts[*].metadataErrors` explicite les champs invalides

- [x] **AC-06 — Parse robuste markdown/yaml**
      Frontmatter/parse YAML invalide =>
  - `allowed: false`
  - `reasonCode: "ARTIFACT_PARSE_FAILED"`
  - erreurs localisées par artefact, sans crash global du lot

- [x] **AC-07 — Résolution des sources de données flexible**
  - `artifactDocuments` injecté -> utilisé tel quel
  - sinon `artifactPaths` + `options.documentReader` -> ingestion via lecture contrôlée
  - absence de source exploitable -> `INVALID_ARTIFACT_INGESTION_INPUT`

- [x] **AC-08 — Contrat de sortie stable**
      La fonction retourne systématiquement:
  `{ allowed, reasonCode, reason, diagnostics, ingestedArtifacts, rejectedArtifacts, correctiveActions }`
      avec:
  - `reasonCode` dans
    `OK | ARTIFACT_PATH_NOT_ALLOWED | UNSUPPORTED_ARTIFACT_TYPE | ARTIFACT_READ_FAILED | ARTIFACT_PARSE_FAILED | ARTIFACT_METADATA_MISSING | ARTIFACT_METADATA_INVALID | INVALID_ARTIFACT_INGESTION_INPUT`
  - `diagnostics` contient au minimum:
    `requestedCount`, `ingestedCount`, `rejectedCount`, `metadataValidatedCount`, `missingMetadataCount`, `allowlistRoots`, `durationMs`, `p95IngestMs`

- [x] **AC-09 — UI e2e démonstrateur minimal**
      Couvrir `empty`, `loading`, `success`, `error` avec affichage explicite:
  - `reasonCode`
  - `reason`
  - `requestedCount/ingestedCount/rejectedCount`
  - `correctiveActions`

- [x] **AC-10 — Seuil qualité/performance module**
  - Couverture module S013 >= **95% lignes** et **95% branches**.
  - Benchmark automatisé corpus 500 docs:
    - `p95IngestMs <= 2000`
    - traitement lot complet `< 5000 ms`.

## Cas de test obligatoires
### Fonctionnels
- [x] Cas nominal: lot markdown/yaml valide sous allowlist -> `OK`.
- [x] Cas hors allowlist: chemin externe refusé -> `ARTIFACT_PATH_NOT_ALLOWED`.
- [x] Cas extension invalide: `.json` -> `UNSUPPORTED_ARTIFACT_TYPE`.
- [x] Cas metadata manquante sur artefact majeur -> `ARTIFACT_METADATA_MISSING`.
- [x] Cas metadata invalide (`stepsCompleted` non tableau) -> `ARTIFACT_METADATA_INVALID`.
- [x] Cas parse invalide (frontmatter cassé / YAML invalide) -> `ARTIFACT_PARSE_FAILED`.
- [x] Cas source absente (`artifactDocuments` et `artifactPaths` absents) -> `INVALID_ARTIFACT_INGESTION_INPUT`.
- [x] Cas UI e2e: parcours `empty -> loading -> error/success` avec rendu explicite des compteurs.

### Non-régression
- [x] `app/src/index.js` conserve les exports existants S001..S010.
- [x] Les suites unit/edge/e2e S001..S010 restent vertes.
- [x] Aucun changement de comportement sur modules workflow/gate déjà livrés.

### Sécurité / robustesse
- [x] Validation stricte des entrées (`allowlistRoots`, chemins, payload documents, metadata).
- [x] Refus déterministe des chemins hors racine autorisée (normalisation path cross-platform).
- [x] Aucune exécution shell dans S013.
- [x] Aucune mutation observable des entrées.

## Scope DEV strict S013
### Autorisé
1. Implémenter `ingestBmadArtifacts(input, options?)` dans `app/src/artifact-ingestion-pipeline.js`.
2. Exporter S013 dans `app/src/index.js` (export S013 uniquement).
3. Ajouter/adapter les tests S013:
   - `app/tests/unit/artifact-ingestion-pipeline.test.js`
   - `app/tests/edge/artifact-ingestion-pipeline.edge.test.js`
   - `app/tests/e2e/artifact-ingestion-pipeline.spec.js`
4. Mettre à jour la story S013 + handoffs DEV (`S013-dev-to-uxqa.md`, `S013-dev-to-tea.md`) avec preuves d’exécution.

### Interdit (hors-scope)
- Toute évolution hors FR-021/FR-022 / S013.
- Toute modification métier S001..S010 non strictement nécessaire à l’intégration S013.
- Tout refactor transverse non requis par les AC S013.
- Toute exécution shell depuis le module S013.

## Contraintes
- Allowlist stricte obligatoire (`allowlistRoots`) avant toute ingestion.
- Types d’artefacts autorisés strictement: `.md`, `.markdown`, `.yaml`, `.yml`.
- Validation metadata obligatoire des artefacts majeurs (liste par défaut fournie ci-dessus).
- Sortie déterministe et reason codes stables (pas de messages ambigus).
- Story non-DONE tant que **G4-T** et **G4-UX** ne sont pas tous deux PASS.

## Implémentation
### Réalisé (DEV)
1. Création de `app/src/artifact-ingestion-pipeline.js` avec API `ingestBmadArtifacts(input, options?)`.
2. Implémentation de la résolution des sources conforme PM:
   - `artifactDocuments` prioritaire (injection directe),
   - sinon `artifactPaths` via `options.documentReader` (lecture contrôlée),
   - absence des deux => `INVALID_ARTIFACT_INGESTION_INPUT`.
3. Implémentation allowlist stricte:
   - normalisation des racines/chemins,
   - rejet déterministe hors racine avec `ARTIFACT_PATH_NOT_ALLOWED`.
4. Implémentation du filtrage de type strict (`.md`, `.markdown`, `.yaml`, `.yml`) avec rejet `UNSUPPORTED_ARTIFACT_TYPE`.
5. Implémentation parse robuste markdown/yaml:
   - frontmatter markdown optionnel,
   - parse YAML simple tolérant commentaires/lignes vides,
   - erreurs de parse localisées => `ARTIFACT_PARSE_FAILED`.
6. Implémentation validation metadata artefacts majeurs:
   - majors par défaut (`prd.md`, `architecture.md`, `ux.md`, `epics.md`, `readiness-check.md`),
   - présence `stepsCompleted` + `inputDocuments` obligatoire,
   - forme stricte (tableaux non vides de chaînes non vides),
   - reason codes dédiés `ARTIFACT_METADATA_MISSING` / `ARTIFACT_METADATA_INVALID`.
7. Implémentation du contrat de sortie stable:
   `{ allowed, reasonCode, reason, diagnostics, ingestedArtifacts, rejectedArtifacts, correctiveActions }`.
8. Export S013 ajouté dans `app/src/index.js` (`ingestBmadArtifacts`) sans casser les exports existants.
9. Ajout/renforcement des tests S013:
   - `app/tests/unit/artifact-ingestion-pipeline.test.js`
   - `app/tests/edge/artifact-ingestion-pipeline.edge.test.js`
   - `app/tests/e2e/artifact-ingestion-pipeline.spec.js`
10. Vérification performance intégrée au test unitaire corpus 500 docs (assertions p95/durée).

## Review
- [x] Mapping AC → tests documenté.
- [x] Vérification explicite des seuils performance NFR-003/NFR-004.
- [x] Vérification couverture module >= 95% lignes + branches.
- [x] Résultat gates techniques publié (PASS/CONCERNS/FAIL).

### Mapping AC → tests
- AC-01/02/03/04/05/06/07/08/10: `app/tests/unit/artifact-ingestion-pipeline.test.js`, `app/tests/edge/artifact-ingestion-pipeline.edge.test.js`
- AC-09: `app/tests/e2e/artifact-ingestion-pipeline.spec.js`
- AC-10 (coverage >=95% lignes+branches): `npm run test:coverage` (S013 `artifact-ingestion-pipeline.js` = **100% lines**, **100% branches**)
- AC-10 performance: test unitaire corpus **500 docs** avec assertions `p95IngestMs <= 2000` et durée `< 5000 ms`.

### Gates techniques (DEV)
Commande de revalidation exécutée depuis `app/` (UTC 2026-02-21T21:31:24Z):
`npm run lint && npm run typecheck && npx vitest run tests/unit tests/edge && npx playwright test tests/e2e && npm run test:coverage && npm run build && npm run security:deps` ✅
Log complet: `_bmad-output/implementation-artifacts/handoffs/S013-tech-gates.log`

Résultats observés:
- `npm run lint` ✅
- `npm run typecheck` ✅
- `npx vitest run tests/unit tests/edge` ✅ (**22 fichiers / 257 tests passés**)
- `npx playwright test tests/e2e` ✅ (**21/21 tests passés**)
- `npm run test:coverage` ✅
  - global: **99.67% statements / 98.24% branches / 100% functions / 99.67% lines**
  - module S013 `app/src/artifact-ingestion-pipeline.js`: **100% statements / 100% branches / 100% functions / 100% lines**
- `npm run build` ✅
- `npm run security:deps` ✅ (`npm audit --audit-level=high`: **0 vulnérabilité**)
- Verdict technique DEV: **PASS**

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/artifact-ingestion-pipeline.test.js tests/edge/artifact-ingestion-pipeline.edge.test.js`
4. `npx playwright test tests/e2e/artifact-ingestion-pipeline.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests cas limites (edge)
- [x] coverage >= seuil
- [x] security scan dépendances
- [x] build

## Règle Story DONE
- Interdit de passer DONE si un seul gate échoue (technique OU UX).
- Audit UX obligatoire: `_bmad-output/implementation-artifacts/ux-audits/<SID>-ux-audit.json` avec verdict PASS.
- Utiliser `bash scripts/story-done-guard.sh <SID>` pour valider la fin.

## UX Gates obligatoires
- [ ] conformité design-system (tokens, spacing, typo, composants)
- [ ] accessibilité WCAG 2.2 AA (minimum)
- [ ] responsive (mobile/tablet/desktop)
- [ ] états d'interface (loading/empty/error/success)
- [ ] hiérarchie visuelle et lisibilité
- [ ] evidence UX fournie (captures/rapports)

## Status
- Dernière revalidation DEV (UTC): 2026-02-21T21:31:24Z
READY_FOR_UX_AUDIT
READY_FOR_TEA
