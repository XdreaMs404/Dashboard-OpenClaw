# S020 - Evidence graph décision↔preuve↔gate↔commande

canonical_story_id: E02-S08
epic: E02
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Scope canonique
- Story ID canonique: `E02-S08`
- FR clés: FR-028, FR-029
- NFR clés: NFR-004, NFR-006
- Risques: T03, T08
- Dépendance story: E02-S07

## Checklist Delivery
- [x] Implémentation conforme au scope canonique
- [x] Tests unit/intégration
- [x] Tests edge
- [x] Tests e2e
- [x] Coverage >= seuil
- [x] Security scan dépendances
- [x] Build
- [x] Audit UX prêt pour revue

## Critères d’acceptation S020
- [x] **AC-01 / FR-028**: graph décision↔preuve↔gate↔commande construit (`nodes`, `edges`, `clusters`).
- [x] **AC-02 / FR-029**: backlinks décision exhaustifs via `decisionBacklinks[decisionId]` sans doublons.
- [x] **AC-03**: priorité source respectée (`artifactDiffResult` > `artifactDiffInput` > `graphEntries`).
- [x] **AC-04**: propagation stricte des blocages amont S019 (`ARTIFACT_*`, `INVALID_ARTIFACT_*`, `ARTIFACT_DIFF_NOT_ELIGIBLE`).
- [x] **AC-05**: liens incomplets -> `EVIDENCE_LINK_INCOMPLETE` + `orphanEvidence` + action corrective.
- [x] **AC-06**: décision ciblée absente -> `DECISION_NOT_FOUND`.
- [x] **AC-07**: ordre déterministe (`nodes`, `edges`, `clusters`, `decisionBacklinks`).
- [x] **AC-08**: contrat stable livré:
  `{ allowed, reasonCode, reason, diagnostics, graph, decisionBacklinks, orphanEvidence, correctiveActions }`.
- [x] **AC-09**: e2e UI états `empty/loading/error/success` + reason/counters/graph/backlinks/orphans/actions.
- [x] **AC-10**: qualité/perf module conforme (coverage >=95/95, p95 <= 2s, lot < 60s sur 500 docs).

## Implémentation S020
### Fichiers touchés (strict S020)
- `app/src/artifact-evidence-graph.js`
- `app/src/index.js` (export S020 uniquement)
- `app/tests/unit/artifact-evidence-graph.test.js`
- `app/tests/edge/artifact-evidence-graph.edge.test.js`
- `app/tests/e2e/artifact-evidence-graph.spec.js`
- `_bmad-output/implementation-artifacts/stories/S020.md`
- `_bmad-output/implementation-artifacts/handoffs/S020-dev-to-uxqa.md`
- `_bmad-output/implementation-artifacts/handoffs/S020-dev-to-tea.md`
- `_bmad-output/implementation-artifacts/handoffs/S020-tech-gates.log`

### Résumé fonctionnel
1. Nouveau module `buildArtifactEvidenceGraph(input, options?)`.
2. Résolution de source canonique:
   - `artifactDiffResult` prioritaire,
   - sinon délégation S019 via `artifactDiffInput` (`diffArtifactVersions`),
   - sinon `graphEntries` direct,
   - sinon fail-closed `INVALID_EVIDENCE_GRAPH_INPUT`.
3. Construction graph déterministe (`artifact/decision/gate/command`) avec IDs stables.
4. Backlinks décision (`decisionBacklinks`) exhaustifs et dédupliqués.
5. Détection d’orphelins (`orphanEvidence`) et actions correctives (`LINK_OR_RESTORE_EVIDENCE`).
6. Diagnostics complets (`nodesCount`, `edgesCount`, `decisionsCount`, `backlinkedArtifactsCount`, `orphanCount`, `durationMs`, `p95GraphMs`, `sourceReasonCode`).

## Mapping AC → tests
- AC-01..AC-08 + AC-10:
  - `app/tests/unit/artifact-evidence-graph.test.js`
  - `app/tests/edge/artifact-evidence-graph.edge.test.js`
- AC-09:
  - `app/tests/e2e/artifact-evidence-graph.spec.js`

## Couverture/performance S020
- `app/src/artifact-evidence-graph.js`:
  - **98.73% lines**
  - **97.79% branches**
  - **100% functions**
  - **98.80% statements**
- Perf (test synthétique 500 docs):
  - `p95GraphMs <= 2000`
  - `durationMs < 60000`

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/artifact-evidence-graph.test.js tests/edge/artifact-evidence-graph.edge.test.js`
4. `npx playwright test tests/e2e/artifact-evidence-graph.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests cas limites (edge)
- [x] coverage >= seuil
- [x] security scan dépendances
- [x] build

## Status
READY_FOR_UXQA_TEA
