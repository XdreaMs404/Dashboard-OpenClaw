# S008 - Override exceptionnel de transition avec justification et approbateur nominatif

## Epic
E01

## User story
En tant qu’orchestrateur BMAD,
je veux autoriser un override exceptionnel de transition uniquement lorsqu’une justification explicite et un approbateur nominatif sont fournis,
afin de débloquer un cas critique sans contourner la gouvernance ni perdre la traçabilité d’audit.

## Dépendances
- **S002** (`validatePhaseTransition`) : source de vérité de la validité de transition et des reason codes de blocage.
- **S007** (`evaluatePhaseSlaAlert`) : contexte de correction opérationnelle en cas d’incident SLA (`PHASE_NOTIFICATION_SLA_EXCEEDED`).
- **S001..S007** (`app/src` + `app/tests`) : continuité contractuelle et non-régression complète.

## Traçabilité
- **FR-009**: autoriser un override exceptionnel uniquement avec justification + approbateur.
- **FR-008 (réutilisation)**: continuité des incidents SLA déjà identifiés par S007.
- **NFR-024**: 100% des overrides approuvés avec approbateur nominatif.
- **NFR-013**: validation correcte >= 95% (contrat stable + reason codes explicites).
- **NFR-034**: diagnostics exploitables en continu pour pilotage / audit.
- **Risques couverts**: P06, P07, S03.

## Critères d'acceptation (mesurables)
- [x] **AC-01 — Nominal sans override requis**
      Si la transition est déjà valide (`reasonCode=OK` via `transitionValidation` ou `transitionInput`), `evaluatePhaseTransitionOverride` retourne:
  - `allowed: true`
  - `reasonCode: "OK"`
  - `override.required: false`
  - `override.applied: false`
  - `requiredActions: []`

- [x] **AC-02 — Override approuvé sur blocage éligible**
      Si la transition est bloquée pour un motif éligible
      (`TRANSITION_NOT_ALLOWED | PHASE_NOTIFICATION_MISSING | PHASE_NOTIFICATION_SLA_EXCEEDED`)
      **et** qu’une demande complète est fournie (`requestedBy`, `approver`, `justification`), la sortie retourne:
  - `allowed: true`
  - `reasonCode: "OK"`
  - `override.required: true`
  - `override.applied: true`
  - `diagnostics.sourceReasonCode` conserve strictement le motif amont
  - `requiredActions` ordonné: `REVALIDATE_TRANSITION`, `RECORD_OVERRIDE_AUDIT`

- [x] **AC-03 — Demande d’override absente**
      Sur blocage éligible sans `overrideRequest`, la sortie retourne:
  - `allowed: false`
  - `reasonCode: "OVERRIDE_REQUEST_MISSING"`
  - `override.required: true`
  - `override.applied: false`
  - `requiredActions` inclut `CAPTURE_JUSTIFICATION`, `CAPTURE_APPROVER`

- [x] **AC-04 — Validation stricte des champs d’override**
  - justification absente/trop courte (`minJustificationLength` défaut 20) -> `OVERRIDE_JUSTIFICATION_REQUIRED`
  - approbateur absent/invalide -> `OVERRIDE_APPROVER_REQUIRED`
  - approbateur identique au demandeur (règle par défaut `requireDistinctApprover=true`) -> `OVERRIDE_APPROVER_CONFLICT`

- [x] **AC-05 — Blocage non éligible à override**
      Si le motif amont n’est pas overrideable (ex: `INVALID_PHASE`), la sortie retourne:
  - `allowed: false`
  - `reasonCode: "OVERRIDE_NOT_ELIGIBLE"`
  - `override.required: false`
  - `override.applied: false`
  - `diagnostics.sourceReasonCode` renseigné

- [x] **AC-06 — Source de données flexible**
  - `transitionValidation` fourni -> utilisé tel quel (pas de recalcul)
  - sinon `transitionInput` -> délégation à S002 (`validatePhaseTransition`)
  - absence des deux -> `INVALID_OVERRIDE_INPUT`

- [x] **AC-07 — Contrat de sortie stable**
      La fonction retourne systématiquement:
  `{ allowed, reasonCode, reason, diagnostics, override, requiredActions }`
      avec:
  - `reasonCode` dans
    `OK | INVALID_PHASE | TRANSITION_NOT_ALLOWED | PHASE_NOTIFICATION_MISSING | PHASE_NOTIFICATION_SLA_EXCEEDED | OVERRIDE_NOT_ELIGIBLE | OVERRIDE_REQUEST_MISSING | OVERRIDE_JUSTIFICATION_REQUIRED | OVERRIDE_APPROVER_REQUIRED | OVERRIDE_APPROVER_CONFLICT | INVALID_OVERRIDE_INPUT`
  - `diagnostics` contenant au minimum:
    `fromPhase`, `toPhase`, `sourceReasonCode`, `overrideEligible`, `overrideRequested`, `justificationLength`, `approverPresent`, `approverDistinct`, `minJustificationLength`

- [x] **AC-08 — UI e2e démonstrateur minimal**
      Couvrir `empty`, `loading`, `success`, `error` avec affichage explicite:
  - `reasonCode`
  - `reason`
  - `override.required`
  - `override.applied`
  - `requiredActions`

- [x] **AC-09 — Seuil qualité module**
      Couverture module S008 >= **95% lignes** et **95% branches**.

## Cas de test obligatoires
### Fonctionnels
- [x] Cas nominal: transition valide (`H04 -> H05`) sans override -> `allowed=true`, `override.required=false`, `override.applied=false`.
- [x] Cas override approuvé: blocage éligible + `overrideRequest` complet -> `allowed=true`, `override.applied=true`, actions ordonnées.
- [x] Cas demande absente: blocage éligible sans request -> `OVERRIDE_REQUEST_MISSING`.
- [x] Cas champs invalides: justification trop courte / approbateur manquant / approbateur=demandeur -> reason codes explicites.
- [x] Cas blocage non éligible: `INVALID_PHASE` -> `OVERRIDE_NOT_ELIGIBLE`.
- [x] Cas délégation S002: sans `transitionValidation` mais avec `transitionInput`, délégation correcte à `validatePhaseTransition`.
- [x] Cas UI e2e: parcours `empty -> loading -> error/success` avec rendu explicite override et actions.

### Non-régression
- [x] `validatePhaseTransition` (S002) conserve son contrat et ses reason codes.
- [x] `evaluatePhaseSlaAlert` (S007) conserve son contrat et son plan correctif.
- [x] `recordPhaseTransitionHistory` (S006) conserve son contrat (filtres/rétention).
- [x] Les suites unit/edge/e2e existantes S001..S007 restent vertes.

### Sécurité / robustesse
- [x] Validation stricte des entrées (`transitionValidation`, `transitionInput`, `overrideRequest`, seuil de justification).
- [x] Aucune mutation observable des objets d’entrée.
- [x] Aucune exécution shell dans S008.
- [x] Vérification explicite du principe “approbateur distinct du demandeur” (par défaut).

## Scope DEV strict S008
### Autorisé
1. Implémenter `evaluatePhaseTransitionOverride(input, options?)` dans `app/src/phase-transition-override.js`.
2. Exporter S008 dans `app/src/index.js` (export S008 uniquement).
3. Ajouter/adapter les tests S008:
   - `app/tests/unit/phase-transition-override.test.js`
   - `app/tests/edge/phase-transition-override.edge.test.js`
   - `app/tests/e2e/phase-transition-override.spec.js`
4. Mettre à jour la story S008 + handoffs DEV (`S008-dev-to-uxqa.md`, `S008-dev-to-tea.md`) avec preuves d’exécution.

### Interdit (hors-scope)
- Toute évolution hors FR-009 / S008.
- Toute modification métier S001..S007 non strictement nécessaire à l’intégration S008.
- Tout refactor transverse non requis par les AC S008.
- Toute exécution shell depuis le module S008.

## Contraintes
- Scope strict S008: pas de modification produit hors FR-009.
- S002 reste la source de vérité sur la validité de transition.
- L’override n’est autorisé que pour les motifs explicitement éligibles définis dans cette story.
- Story non-DONE tant que **G4-T** et **G4-UX** ne sont pas tous deux PASS.

## Implémentation
### Réalisé (DEV)
1. Création de `app/src/phase-transition-override.js` avec API `evaluatePhaseTransitionOverride(input, options?)`.
2. Résolution de la source de transition conforme PM:
   - priorité à `transitionValidation` injecté,
   - sinon délégation `transitionInput` -> `validatePhaseTransition` (S002), avec support d’injection `options.transitionValidator`.
3. Implémentation de la politique d’override exceptionnel:
   - motifs éligibles stricts `TRANSITION_NOT_ALLOWED | PHASE_NOTIFICATION_MISSING | PHASE_NOTIFICATION_SLA_EXCEEDED`,
   - justification obligatoire (défaut `minJustificationLength=20`, configurable),
   - approbateur obligatoire,
   - distinct demandeur/approbateur par défaut (`requireDistinctApprover=true`, configurable).
4. Production du contrat de sortie stable:
   `{ allowed, reasonCode, reason, diagnostics, override, requiredActions }`.
5. Actions ordonnées implémentées selon état:
   - demande incomplète: `CAPTURE_JUSTIFICATION`, `CAPTURE_APPROVER`,
   - override approuvé: `REVALIDATE_TRANSITION`, `RECORD_OVERRIDE_AUDIT`.
6. Export public S008 ajouté dans `app/src/index.js` (`evaluatePhaseTransitionOverride`).
7. Ajout/renforcement des tests S008:
   - `app/tests/unit/phase-transition-override.test.js`
   - `app/tests/edge/phase-transition-override.edge.test.js`
   - `app/tests/e2e/phase-transition-override.spec.js`
8. Démonstrateur e2e S008 couvrant explicitement `empty/loading/error/success`, rendu `reasonCode/reason/override.required/override.applied/requiredActions` + vérification responsive sans overflow.
9. Exécution complète des gates techniques DEV = PASS.

## Review
- [x] Mapping AC → tests documenté.
- [x] Vérification explicite de la réutilisation S002 (injection ou délégation).
- [x] Vérification couverture module >= 95% lignes + branches.
- [x] Résultat gates techniques publié (PASS/CONCERNS/FAIL).

### Mapping AC → tests
- AC-01/02/03/04/05/06/07/09: `app/tests/unit/phase-transition-override.test.js`, `app/tests/edge/phase-transition-override.edge.test.js`
- AC-08: `app/tests/e2e/phase-transition-override.spec.js`
- AC-09 (coverage >=95% lignes+branches): `npm run test:coverage` (S008 `phase-transition-override.js` = **99.24% lines**, **98.57% branches**)

### Gates techniques (DEV)
Commande de revalidation exécutée depuis `app/` (UTC 2026-02-21T15:17:23Z):
`npm run lint && npm run typecheck && npx vitest run tests/unit tests/edge && npx playwright test tests/e2e && npm run test:coverage && npm run build && npm run security:deps` ✅

Résultats observés:
- `npm run lint` ✅
- `npm run typecheck` ✅
- `npx vitest run tests/unit tests/edge` ✅ (**16 fichiers / 170 tests passés**)
- `npx playwright test tests/e2e` ✅ (**15 tests passés**)
- `npm run test:coverage` ✅
  - global: **99.56% statements / 98.09% branches / 100% functions / 99.56% lines**
  - module S008 `app/src/phase-transition-override.js`: **99.25% statements / 98.57% branches / 100% functions / 99.24% lines**
- `npm run build` ✅
- `npm run security:deps` ✅ (`npm audit --audit-level=high`: **0 vulnérabilité**)
- Verdict technique DEV: **PASS**

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/phase-transition-override.test.js tests/edge/phase-transition-override.edge.test.js`
4. `npx playwright test tests/e2e/phase-transition-override.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests cas limites (edge)
- [x] coverage >= seuil
- [x] security scan dépendances
- [x] build

## Règle Story DONE
- Interdit de passer DONE si un seul gate échoue (technique OU UX).
- Audit UX obligatoire: `_bmad-output/implementation-artifacts/ux-audits/<SID>-ux-audit.json` avec verdict PASS.
- Utiliser `bash scripts/story-done-guard.sh <SID>` pour valider la fin.

## UX Gates obligatoires
- [ ] conformité design-system (tokens, spacing, typo, composants)
- [ ] accessibilité WCAG 2.2 AA (minimum)
- [ ] responsive (mobile/tablet/desktop)
- [ ] états d'interface (loading/empty/error/success)
- [ ] hiérarchie visuelle et lisibilité
- [ ] evidence UX fournie (captures/rapports)

## Status
- Dernière revalidation DEV (UTC): 2026-02-21T15:17:23Z
READY_FOR_REVIEW
