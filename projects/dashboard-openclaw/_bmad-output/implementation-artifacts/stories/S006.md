# S006 - Orchestration sequence-guard depuis le cockpit

canonical_story_id: E01-S06
epic: E01
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Scope canonique
- Story ID canonique: `E01-S06`
- FR clés: FR-006, FR-007
- NFR clés: NFR-011, NFR-013
- Risques: P01, P02
- Dépendance story: E01-S05

## Pourquoi réouverture
- Story réouverte pour réalignement canonique: fr_missing:FR-007
- Ancienne version archivée sous `_bmad-output/implementation-artifacts/archive/`.

## Checklist Delivery
- [x] Implémentation conforme au scope canonique
- [x] Tests unit/intégration
- [x] Tests edge
- [x] Tests e2e
- [x] Coverage >= seuil
- [x] Security scan dépendances
- [x] Build
- [ ] Audit UX PASS

## Exécution DEV (H13/H16)
- Date exécution gates (UTC): 2026-02-22T13:28:50Z → 2026-02-22T13:29:35Z
- Preuve logs: `_bmad-output/implementation-artifacts/handoffs/S006-tech-gates.log`
- Fichiers scope validés:
  - `app/src/phase-guards-orchestrator.js`
  - `app/tests/unit/phase-guards-orchestrator.test.js`
  - `app/tests/edge/phase-guards-orchestrator.edge.test.js`
  - `app/tests/e2e/phase-guards-orchestrator.spec.js`
- Résultats:
  - lint/typecheck/build/security: PASS
  - tests unit+edge: 32 fichiers / 421 tests PASS
  - tests e2e: 31/31 PASS
  - coverage module `phase-guards-orchestrator.js`: 100% lines / 100% branches / 100% functions

## Mapping AC → tests
- AC-01 (FR-006 exécution contrôlée CMD-008/CMD-009)
  - unit: `returns ordered guard plan in simulation mode by default...`
  - unit: `executes both commands sequentially when simulate=false...`
  - edge: `accepts string phase numbers in allowlist 1|2|3`
  - edge: `uses default executor success path with strict allowlist commands`
- AC-02 (FR-007 historique transitions + verdicts consultables)
  - unit: `stops immediately when first guard command fails and exposes failedCommand`
  - unit: `stops on second command exception and keeps ordered execution evidence`
  - edge: `uses default executor failure path with status/stdout/stderr propagation`
  - e2e: scénario `execution-failed` (affichage `commands`, `failedCommand`, détail échec)
- AC-03 (NFR-011 fiabilité >= 99.5)
  - unit/edge: robustesse entrées non objet, options invalides, normalisation `commandExecutor` results
  - edge: `does not throw on non-object inputs and fails closed with INVALID_GUARD_PHASE`
  - edge: `does not mutate input or runtime options objects`
- AC-04 (NFR-013 audit command logs >=95)
  - contrat vérifié: `commands[]`, `results[]`, `diagnostics.failedCommand`
  - e2e: scénario `blocked-prerequisites` + `execution-failed` + `success-simulation`

## Comment tester (simple)
- `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-story-gates.sh S006`
- `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-ux-gates.sh S006`

## Status
READY_FOR_UXQA_TEA
