# S006 - Historique consultable des transitions de phase et verdicts associés

## Epic
E01

## User story
En tant qu’orchestrateur BMAD,
je veux enregistrer chaque tentative de transition de phase avec son verdict opérationnel,
afin de disposer d’un historique consultable, filtrable et exploitable pour audit, diagnostic et handoff.

## Dépendances
- S002 (validateur de transitions) : source de vérité sur la validité canonique et le reasonCode de transition.
- S004 (prérequis de phase) : source de vérité des blocages checklist.
- S005 (orchestration guards) : source de vérité des verdicts d’exécution des guards.

## Traçabilité
- FR-007 : conserver un historique consultable des transitions de phase et des verdicts associés.
- FR-006 (réutilisation) : exploiter le verdict de l’orchestrateur guards sans ré-exécuter les scripts dans S006.
- NFR-011 : fiabilité opérationnelle >= 99.5% (journalisation déterministe + contrat stable).
- NFR-013 : validation correcte >= 95% (reason codes cohérents et propagés).
- NFR-034 : diagnostics continus exploitables côté pilotage.
- Risques couverts : P01, P02, P03, P06.

## Critères d'acceptation
- [x] AC-01 (Nominal enregistrement) : `recordPhaseTransitionHistory(input, options?)` ajoute une entrée quand `fromPhase/toPhase` sont valides et `guardResult` respecte le contrat S005; la sortie retourne `allowed=true`, `reasonCode="OK"`, `entry` non nul, et l’historique inclut la nouvelle entrée.
- [x] AC-02 (Propagation blocage) : si `guardResult.allowed=false` avec `reasonCode` valide (ex: `PHASE_PREREQUISITES_INCOMPLETE`, `GUARD_EXECUTION_FAILED`), la sortie propage strictement le même `reasonCode` + `reason`, **tout en enregistrant** l’événement dans l’historique.
- [x] AC-03 (Phase invalide) : si `fromPhase` ou `toPhase` n’appartient pas à `H01..H23`, la sortie est `allowed=false`, `reasonCode="INVALID_PHASE"`, `entry=null`, sans mutation de l’historique d’entrée.
- [x] AC-04 (Payload invalide) : si `history` n’est pas un tableau ou si `guardResult` est absent/invalide, la sortie est `allowed=false`, `reasonCode="INVALID_TRANSITION_HISTORY"`, sans exception non contrôlée.
- [x] AC-05 (Consultation filtrée) : la sortie expose un historique consultable et filtrable (`query.fromPhase`, `query.toPhase`, `query.reasonCode`, `query.allowed`, `query.limit`) trié du plus récent au plus ancien; `limit` par défaut = 50, borne max = 200.
- [x] AC-06 (Rétention) : `maxEntries` par défaut = 200 (borne max 1000). Quand la taille est dépassée, les plus anciennes entrées sont supprimées et `diagnostics.droppedCount` est correctement renseigné.
- [x] AC-07 (Contrat stable) : la fonction retourne systématiquement
  `{ allowed, reasonCode, reason, diagnostics, entry, history }`
  avec:
  - `reasonCode` dans
    `OK | INVALID_PHASE | TRANSITION_NOT_ALLOWED | PHASE_NOTIFICATION_MISSING | PHASE_NOTIFICATION_SLA_EXCEEDED | PHASE_PREREQUISITES_MISSING | PHASE_PREREQUISITES_INCOMPLETE | INVALID_PHASE_PREREQUISITES | INVALID_GUARD_PHASE | GUARD_EXECUTION_FAILED | INVALID_TRANSITION_HISTORY`
  - `diagnostics` contenant au minimum `fromPhase`, `toPhase`, `totalCount`, `returnedCount`, `droppedCount`, `blockedByGuard`.
- [x] AC-08 (UI e2e) : démonstrateur minimal avec états `empty`, `loading`, `success`, `error`, affichant `reasonCode`, `reason`, et la liste d’historique (transition + verdict + timestamp).
- [x] AC-09 (Seuil qualité) : couverture du module S006 >= 95% (lignes + branches).

## Cas de test obligatoires
### Fonctionnels
- [x] Cas nominal : ajout d’un événement `H03 -> H04` avec `guardResult=OK` => `allowed=true`, `entry` créé, historique +1.
- [x] Cas blocage propagé : ajout avec `guardResult.allowed=false` (`PHASE_PREREQUISITES_INCOMPLETE`) => reason propagé strictement + entrée enregistrée.
- [x] Cas phase invalide : `fromPhase="H00"` ou `toPhase="H99"` => `INVALID_PHASE`, aucun append.
- [x] Cas payload invalide : `history=null` ou `guardResult` absent => `INVALID_TRANSITION_HISTORY`.
- [x] Cas filtres : consultation avec `query.reasonCode` / `query.allowed` / `query.limit` renvoie la liste attendue dans l’ordre décroissant temporel.
- [x] Cas rétention : dépassement `maxEntries` => trim des plus anciennes entrées + `droppedCount` exact.
- [x] Cas UI e2e : parcours `empty -> loading -> success/error` avec rendu explicite des motifs et de l’historique.

### Non-régression
- [x] `validatePhaseTransition` (S002) conserve son contrat et ses reason codes.
- [x] `validatePhasePrerequisites` (S004) conserve son contrat et ses reason codes.
- [x] `orchestratePhaseGuards` (S005) conserve son contrat et ses reason codes.
- [x] Les suites unit/edge/e2e existantes S001..S005 restent vertes.

### Sécurité / robustesse
- [x] Validation stricte des entrées (`fromPhase`, `toPhase`, `history`, `guardResult`, `query`).
- [x] Aucune mutation observable des objets/collections d’entrée.
- [x] Aucune exécution shell dans S006 (consommation read-only du verdict S005).
- [x] Messages de blocage explicites et actionnables pour UI/opérations.

## Contraintes
- Scope strict S006 : aucune dérive fonctionnelle hors FR-007.
- Réutiliser les reason codes S002/S004/S005 sans redéfinition contradictoire.
- S006 ne déclenche pas l’exécution des scripts guards; il consomme `guardResult` fourni.
- Story non-DONE tant que G4-T et G4-UX ne sont pas tous deux PASS.

## Implémentation
### Réalisé (DEV)
1. Création de `app/src/phase-transition-history.js` avec API `recordPhaseTransitionHistory(input, options?)`.
2. Validation stricte des payloads (`history`, `guardResult`, cohérence allowed/reasonCode, phases H01..H23).
3. Append immuable d’entrée d’historique avec horodatage normalisé ISO + verdict guard + diagnostics.
4. Consultation filtrée implémentée: `query.fromPhase`, `query.toPhase`, `query.reasonCode`, `query.allowed`, `query.limit` (défaut 50, max 200).
5. Tri déterministe récent -> ancien avec tie-break stable.
6. Politique de rétention implémentée: `maxEntries` défaut 200, borne max 1000, `diagnostics.droppedCount` exact.
7. Export public ajouté dans `app/src/index.js`: `recordPhaseTransitionHistory`.
8. Ajout des tests S006:
   - `app/tests/unit/phase-transition-history.test.js`
   - `app/tests/edge/phase-transition-history.edge.test.js`
   - `app/tests/e2e/phase-transition-history.spec.js`
9. Démonstrateur e2e S006 couvrant `empty/loading/error/success`, rendu explicite `reasonCode/reason/history (transition + verdict + timestamp)` + vérification responsive sans overflow.
10. Revalidation DEV complète exécutée via gates techniques (lint/typecheck/tests/e2e/coverage/build/security) = PASS.

## Review
- [x] Mapping AC → tests documenté.
- [x] Vérification explicite de la propagation des reason codes S002/S004/S005.
- [x] Vérification coverage module >= 95% lignes + branches.
- [x] Résultat gates techniques publié (PASS/CONCERNS/FAIL).

### Mapping AC → tests
- AC-01/02/03/04/05/06/07: `app/tests/unit/phase-transition-history.test.js`, `app/tests/edge/phase-transition-history.edge.test.js`
- AC-08: `app/tests/e2e/phase-transition-history.spec.js`
- AC-09: `npm run test:coverage` (S006 `phase-transition-history.js` = **100% lines**, **98.52% branches**)

### Gates techniques (DEV)
- `npm run lint` ✅
- `npm run typecheck` ✅
- `npx vitest run tests/unit tests/edge` ✅ (12 fichiers, 122 tests)
- `npx playwright test tests/e2e` ✅ (11 tests)
- `npm run test:coverage` ✅
  - couverture globale: **99.51% lines / 98.25% branches / 100% functions / 99.52% statements**
  - module S006 `app/src/phase-transition-history.js`: **100% lines / 98.52% branches**
- `npm run build` ✅
- `npm run security:deps` ✅ (0 vulnérabilité)
- Revalidation DEV (2026-02-21T13:48:44Z):
  `npm run lint && npm run typecheck && npx vitest run tests/unit tests/edge && npx playwright test tests/e2e && npm run test:coverage && npm run build && npm run security:deps` = ✅
- Verdict technique DEV: **PASS**

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/phase-transition-history.test.js tests/edge/phase-transition-history.edge.test.js`
4. `npx playwright test tests/e2e/phase-transition-history.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests cas limites (edge)
- [x] coverage >= seuil
- [x] security scan dépendances
- [x] build

## Règle Story DONE
- Interdit de passer DONE si un seul gate échoue (technique OU UX).
- Audit UX obligatoire: `_bmad-output/implementation-artifacts/ux-audits/<SID>-ux-audit.json` avec verdict PASS.
- Utiliser `bash scripts/story-done-guard.sh <SID>` pour valider la fin.

## UX Gates obligatoires
- [ ] conformité design-system (tokens, spacing, typo, composants)
- [ ] accessibilité WCAG 2.2 AA (minimum)
- [ ] responsive (mobile/tablet/desktop)
- [ ] états d'interface (loading/empty/error/success)
- [ ] hiérarchie visuelle et lisibilité
- [ ] evidence UX fournie (captures/rapports)

## Status
- Dernière revalidation DEV (UTC): 2026-02-21T13:48:44Z
READY_FOR_REVIEW
