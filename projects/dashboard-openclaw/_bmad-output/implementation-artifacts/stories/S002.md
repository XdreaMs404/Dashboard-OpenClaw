# S002 - Validateur de transitions autorisées + blocage sans notification de phase

## Epic
E01

## User story
En tant qu’orchestrateur BMAD,
je veux valider automatiquement qu’une transition de phase respecte l’ordre canonique H01→H23 et la présence d’une notification de phase dans le SLA,
afin d’empêcher les transitions non autorisées (FR-002) et les passages sans `phase-notify` (FR-003).

## Traçabilité
- FR-002: empêcher toute transition non autorisée + raison de blocage explicite.
- FR-003: bloquer la transition si notification de phase manquante / hors fenêtre SLA.
- NFR-013: taux de validation correcte >= 95% sur la matrice de scénarios.
- NFR-017: SLA notification par défaut = 10 minutes (bloquant).
- Risques couverts: P02, P03.

## Critères d'acceptation
- [x] AC-01 (Nominal): avec `fromPhase="H01"`, `toPhase="H02"`, `notificationPublishedAt` présent et `elapsed <= 10 min`, la validation retourne `allowed: true` et `reasonCode: "OK"`.
- [x] AC-02 (Négatif - transition interdite): une transition qui saute une phase (ex: `H01 -> H03`) ou recule (ex: `H03 -> H02`) retourne `allowed: false`, `reasonCode: "TRANSITION_NOT_ALLOWED"`, et une raison lisible contenant `fromPhase`, `toPhase`, et la phase attendue.
- [x] AC-03 (Négatif - notification manquante): pour une transition canonique (ex: `H02 -> H03`) avec `notificationPublishedAt = null`, la validation retourne `allowed: false`, `reasonCode: "PHASE_NOTIFICATION_MISSING"`.
- [x] AC-04 (Négatif - SLA dépassé): pour une transition canonique avec `elapsed > notificationSlaMinutes`, la validation retourne `allowed: false`, `reasonCode: "PHASE_NOTIFICATION_SLA_EXCEEDED"`.
- [x] AC-05 (Seuil frontière): si `elapsed === 10 min` (600000 ms), la transition reste autorisée; si `elapsed === 600001 ms`, elle est bloquée.
- [x] AC-06 (Entrées invalides): une phase inconnue (ex: `H00`, `H24`, `"phase1"`) retourne `allowed: false`, `reasonCode: "INVALID_PHASE"`, sans exception non contrôlée.
- [x] AC-07 (Contrat de sortie stable): la fonction retourne systématiquement l’objet `{ allowed, reasonCode, reason, diagnostics }` avec:
  - `reasonCode` dans `OK | INVALID_PHASE | TRANSITION_NOT_ALLOWED | PHASE_NOTIFICATION_MISSING | PHASE_NOTIFICATION_SLA_EXCEEDED`
  - `diagnostics.slaMs` numérique
  - `diagnostics.elapsedMs` numérique ou `null`.
- [x] AC-08 (Seuil qualité): couverture du module `phase-transition-validator` >= 95% (lignes + branches) dans le rapport coverage.

## Cas de test obligatoires
### Fonctionnels
- [x] Cas nominal: `H01 -> H02` avec notification envoyée 5 min avant la demande → `allowed=true`, `reasonCode=OK`.
- [x] Cas interdit (skip): `H01 -> H03` → `TRANSITION_NOT_ALLOWED`.
- [x] Cas interdit (retour arrière): `H04 -> H03` → `TRANSITION_NOT_ALLOWED`.
- [x] Cas notification absente: `H02 -> H03` sans notification → `PHASE_NOTIFICATION_MISSING`.
- [x] Cas notification expirée: `H02 -> H03` avec notification plus ancienne que 10 min → `PHASE_NOTIFICATION_SLA_EXCEEDED`.
- [x] Cas frontière SLA: `elapsed=600000ms` autorisé, `elapsed=600001ms` bloqué.
- [x] Cas phase invalide: `fromPhase="H99"` ou `toPhase="H99"` → `INVALID_PHASE`.
- [x] Cas UI e2e: démonstrateur minimal avec états `empty`, `loading`, `success`, `error` et affichage de la raison de blocage.

### Non-régression
- [x] Les fonctions existantes (`safeDivide`, `normalizeEmail`, `normalizeUserName`, `clamp`) conservent leur comportement actuel.
- [x] Les tests unitaires/edge/e2e déjà en place restent verts.
- [x] Aucune régression sur les scripts npm (`lint`, `typecheck`, `build`).

### Sécurité / robustesse
- [x] Validation stricte des entrées (types, dates invalides, phases inconnues).
- [x] Aucun `eval`, aucune exécution dynamique risquée.
- [x] La validation ne modifie pas les objets d’entrée (immutabilité observable).
- [x] Les messages d’erreur/raison sont explicites et exploitables côté UI.

## Implémentation
### Réalisé (DEV)
1. Création du module `app/src/phase-transition-validator.js` avec:
   - export `BMAD_PHASE_ORDER` (`H01` → `H23`),
   - API `validatePhaseTransition(input)`,
   - validation phases,
   - validation transition canonique `from -> next(from)`,
   - validation notification présente/valide,
   - validation SLA (`notificationSlaMinutes`, défaut 10),
   - contrat de sortie stable `{ allowed, reasonCode, reason, diagnostics }`.
2. Export de l’API publique dans `app/src/index.js` (`BMAD_PHASE_ORDER`, `validatePhaseTransition`).
3. Ajout des tests unitaires story dans `app/tests/unit/phase-transition-validator.test.js`.
4. Ajout des tests edge robustesse dans `app/tests/edge/phase-transition-validator.edge.test.js`.
5. Ajout du test e2e UI démonstrateur dans `app/tests/e2e/phase-transition-validator.spec.js` (états `empty/loading/error/success` + raison de blocage visible).

## Review
- Mapping AC → tests:
  - AC-01/03/04/05/06/07: `tests/unit/phase-transition-validator.test.js`
  - AC-02 (message explicite + from/to/expected): `tests/unit/phase-transition-validator.test.js`, `tests/e2e/phase-transition-validator.spec.js`
  - AC-08 (coverage >=95% module): `npm run test:coverage` (module `phase-transition-validator.js` = **97.36% lines**, **95.34% branches**)
- Résultat gates techniques exécutés: PASS (`lint`, `typecheck`, `vitest`, `playwright`, `coverage`, `build`, `security:deps`).

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit tests/edge`
4. `npx playwright test tests/e2e`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`


## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests cas limites (edge)
- [x] coverage >= seuil
- [x] security scan dépendances
- [x] build

## Règle Story DONE
- Interdit de passer DONE si un seul gate échoue (technique OU UX).
- Audit UX obligatoire: `_bmad-output/implementation-artifacts/ux-audits/<SID>-ux-audit.json` avec verdict PASS.
- Utiliser `bash scripts/story-done-guard.sh <SID>` pour valider la fin.

## UX Gates obligatoires
- [ ] conformité design-system (tokens, spacing, typo, composants)
- [ ] accessibilité WCAG 2.2 AA (minimum)
- [ ] responsive (mobile/tablet/desktop)
- [ ] états d'interface (loading/empty/error/success)
- [ ] hiérarchie visuelle et lisibilité
- [ ] evidence UX fournie (captures/rapports)

## Status
READY_FOR_REVIEW
