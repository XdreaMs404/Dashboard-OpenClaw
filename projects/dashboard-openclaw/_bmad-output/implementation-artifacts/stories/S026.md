# S026 - Évaluation duale G4-T/G4-UX corrélée

canonical_story_id: E03-S02
epic: E03
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Scope canonique
- Story ID canonique: `E03-S02`
- FR clés: FR-012, FR-013
- NFR clés: NFR-007, NFR-018
- Risques: P05, P06
- Dépendance story: E03-S01

## Checklist Delivery
- [x] Implémentation conforme au scope canonique
- [x] Tests unit/intégration
- [x] Tests edge
- [x] Tests e2e
- [x] Coverage >= seuil
- [x] Security scan dépendances
- [x] Build
- [x] Audit UX prêt pour revue

## Critères d’acceptation S026
- [x] **AC-01 / FR-012**: exposition distincte de `G4-T` et `G4-UX` + corrélation explicite.
- [x] **AC-02 / FR-013**: verdict dual auto `PASS|CONCERNS|FAIL` selon `RULE-G4-01`.
- [x] **AC-03 / NFR-007**: latence de calcul dual conforme (`p95DualEvalMs <= 2000`).
- [x] **AC-04 / NFR-018**: baseline précision >=65% validée sur dataset de validation dual (9 cas).
- [x] **AC-05**: résolution source stricte (`gateCenterResult` prioritaire, sinon délégation S025 via `gateCenterInput`).
- [x] **AC-06**: propagation stricte des blocages S025 autorisés sans réécriture.
- [x] **AC-07**: incohérence synchro sous-gates => `G4_SUBGATES_UNSYNC` + `SYNC_G4_SUBGATES`.
- [x] **AC-08**: contrat stable livré:
  `{ allowed, reasonCode, reason, diagnostics, g4DualStatus, correlationMatrix, correctiveActions }`.
- [x] **AC-09**: e2e états `empty/loading/error/success` avec reason/counters/subgates/verdict/matrix/actions.
- [x] **AC-10**: qualité module >=95% lignes/branches.

## Implémentation S026
### Fichiers touchés (strict S026)
- `app/src/g4-dual-evaluation.js`
- `app/src/index.js` (export S026)
- `app/tests/unit/g4-dual-evaluation.test.js`
- `app/tests/edge/g4-dual-evaluation.edge.test.js`
- `app/tests/e2e/g4-dual-evaluation.spec.js`
- `_bmad-output/implementation-artifacts/stories/S026.md`
- `_bmad-output/implementation-artifacts/handoffs/S026-dev-to-uxqa.md`
- `_bmad-output/implementation-artifacts/handoffs/S026-dev-to-tea.md`

### Résumé fonctionnel
1. Résolution source stricte:
   - `gateCenterResult` injecté prioritaire
   - sinon délégation S025 via `buildGateCenterStatus(gateCenterInput)`
   - sinon `INVALID_G4_DUAL_INPUT`
2. Propagation stricte des blocages amont S025 (`INVALID_PHASE`, `TRANSITION_NOT_ALLOWED`, `GATE_STATUS_INCOMPLETE`, `G4_SUBGATE_MISMATCH`, `INVALID_GATE_CENTER_INPUT`, etc.).
3. Évaluation duale G4:
   - extraction/normalisation de `G4-T` et `G4-UX`
   - matrice explicite 3x3 (`PASS|CONCERNS|FAIL`) avec règle `RULE-G4-01`
   - verdict auto: PASS si 2 PASS, FAIL si au moins 1 FAIL, sinon CONCERNS
4. Diagnostics de synchro:
   - skew temporel sous-gates et G4 global
   - divergence owner attendu
   - mismatch statut G4 global vs verdict dual
5. Sécurité DONE:
   - `BLOCK_DONE_TRANSITION` ajouté dès qu’un cas non-PASS bloque la progression
   - `REQUEST_UX_EVIDENCE_REFRESH` sur non-PASS UX
6. Contrat stable + diagnostics complets:
   - `g4tStatus`, `g4uxStatus`, `dualVerdict`, `mismatchCount`, `durationMs`, `p95DualEvalMs`, `sourceReasonCode`

## Mapping AC -> tests
- AC-01, AC-02, AC-05, AC-06, AC-07, AC-08, AC-10:
  - `app/tests/unit/g4-dual-evaluation.test.js`
  - `app/tests/edge/g4-dual-evaluation.edge.test.js`
- AC-03 (perf) :
  - `app/tests/unit/g4-dual-evaluation.test.js` (`500 dual events`, assertion `p95DualEvalMs <= 2000`)
- AC-04 (précision baseline) :
  - `app/tests/unit/g4-dual-evaluation.test.js` (`RULE-G4-01` sur dataset 9 cas, précision observée 100%)
- AC-09 (UX/e2e) :
  - `app/tests/e2e/g4-dual-evaluation.spec.js`

## Couverture/performance S026
- `app/src/g4-dual-evaluation.js`:
  - **98.29% statements**
  - **95.43% branches**
  - **100% functions**
  - **98.23% lines**
- Perf synthétique:
  - `p95DualEvalMs <= 2000`
  - `durationMs < 60000` (stream 500 événements)
- Précision baseline:
  - dataset validation dual 9 cas: **100%** (>=65% requis)

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/g4-dual-evaluation.test.js tests/edge/g4-dual-evaluation.edge.test.js`
4. `npx playwright test tests/e2e/g4-dual-evaluation.spec.js`
5. `npx vitest run tests/unit/g4-dual-evaluation.test.js tests/edge/g4-dual-evaluation.edge.test.js --coverage --coverage.include=src/g4-dual-evaluation.js`
6. `npm run build && npm run security:deps`
7. `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-fast-quality-gates.sh S026`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests edge
- [x] coverage >= seuil
- [x] fast quality gates S026

## Status
READY_FOR_UXQA_TEA
