# S019 - Moteur diff version-vers-version d’artefacts

## Epic
E02

## Handoff courant
H13 PM → DEV (scope strict S019)

## User story
En tant qu’orchestrateur BMAD,
je veux comparer deux versions d’un artefact de manière déterministe avec un diff structuré,
afin de visualiser les changements structurants et préparer la traçabilité artefact↔décision↔gate↔commande.

## Dépendances
- **S018** (`applyArtifactContextFilters`) : source des `diffCandidates`.
- **S017/S016** : reason codes amont propagés via S018.
- **Planning canonique E02-S07** (`_bmad-output/planning-artifacts/epics.md`) : FR-027/FR-028 + NFR-003/NFR-004.
- **PRD** (`_bmad-output/planning-artifacts/prd.md`) : FR-027, FR-028, AC-027A/B, AC-028A/B.
- **Architecture** (`_bmad-output/planning-artifacts/architecture.md`) : `artifact.diff.generated`, `projection.artifact.diffs`.

## Traçabilité
- **FR-027** : comparer deux versions et souligner les changements structurants.
- **FR-028 (préparation S019)** : exposer des liens de provenance minimaux (`decisionRefs`, `gateRefs`, `commandRefs`) sans implémenter S020.
- **NFR-003** : p95 < 5s.
- **NFR-004** : p95 < 2s sur corpus 500 paires.

## Critères d'acceptation (mesurables)
- [x] **AC-01 — Diff nominal version-vers-version**
      `diffArtifactVersions` retourne `allowed=true`, `reasonCode=OK`, `diffResults` non vide sur paire valide.

- [x] **AC-02 — Résolution des sources prioritaire**
  - `contextFilterResult` injecté prioritaire,
  - sinon `contextFilterInput` délégué à `applyArtifactContextFilters`,
  - sinon `artifactPairs` direct,
  - sinon `INVALID_ARTIFACT_DIFF_INPUT`.

- [x] **AC-03 — Changements structurants déterministes**
      Calcul stable des deltas:
  - `metadata` (`added/removed/changed/unchanged`),
  - `sections` (`added/removed/unchanged`),
  - `tables` (`added/removed/unchanged`),
  - `contentSummary` (`left/right/changed`).

- [x] **AC-04 — Tri stable des sorties**
      Tri déterministe des paires/diffs par `groupKey`, puis `leftArtifactId`, puis `rightArtifactId`.

- [x] **AC-05 — Propagation stricte des blocages amont**
      `ARTIFACT_*`, `INVALID_ARTIFACT_SEARCH_INPUT`, `INVALID_ARTIFACT_CONTEXT_FILTER_INPUT` propagés sans réécriture.

- [x] **AC-06 — Candidats non éligibles**
      Candidats <2 versions ou non résolus -> `ARTIFACT_DIFF_NOT_ELIGIBLE` + `unresolvedCandidates` + action corrective.

- [x] **AC-07 — Provenance minimale FR-028**
      `provenanceLinks` agrège `decisionRefs`, `gateRefs`, `commandRefs` par paire comparée.

- [x] **AC-08 — Contrat de sortie stable**
      Retour systématique:
      `{ allowed, reasonCode, reason, diagnostics, diffResults, unresolvedCandidates, provenanceLinks, correctiveActions }`
      avec diagnostics minimum:
  - `requestedCandidatesCount`, `comparedPairsCount`, `unresolvedCount`,
  - `durationMs`, `p95DiffMs`, `sourceReasonCode`.

- [x] **AC-09 — UI e2e démonstrateur minimal**
      États `empty/loading/success/error` avec affichage explicite de:
  - `reasonCode`, `reason`,
  - compteurs, `diffResults`, `provenanceLinks`, `correctiveActions`.

- [x] **AC-10 — Qualité/performance module**
  - Couverture module S019 >= 95% lignes et branches.
  - Benchmark 500 paires: `p95DiffMs <= 2000`, lot `< 60000ms`.

## Cas de test obligatoires
### Fonctionnels
- [x] Cas nominal paire valide avec diff structuré + provenance.
- [x] Cas priorité source (`contextFilterResult` > `contextFilterInput` > `artifactPairs`).
- [x] Cas délégation S018 via `contextFilterInput`.
- [x] Cas propagation blocage amont S018.
- [x] Cas non-éligible (`ARTIFACT_DIFF_NOT_ELIGIBLE`).
- [x] Cas tri déterministe des sorties.
- [x] Cas benchmark 500 paires.
- [x] Cas e2e `empty -> loading -> error/success`.

### Non-régression
- [x] Export `diffArtifactVersions` ajouté sans casser les exports existants.
- [x] S018 reste source de vérité des `diffCandidates`.
- [x] Aucun comportement hors scope S019.

### Sécurité / robustesse
- [x] Validation stricte des entrées (source/paires/artifacts).
- [x] Aucun throw non contrôlé (fail-closed via reason codes invalides).
- [x] Aucune mutation observable des entrées.

## Scope DEV strict S019
### Autorisé
1. Implémenter `diffArtifactVersions(input, options?)` dans `app/src/artifact-version-diff.js`.
2. Exporter S019 dans `app/src/index.js` (export S019 uniquement).
3. Ajouter/adapter les tests S019:
   - `app/tests/unit/artifact-version-diff.test.js`
   - `app/tests/edge/artifact-version-diff.edge.test.js`
   - `app/tests/e2e/artifact-version-diff.spec.js`
4. Mettre à jour la story S019 + handoffs DEV S019.

### Interdit (hors-scope)
- Toute implémentation du graph de provenance complet (scope S020).
- Toute modification fonctionnelle S001..S018 non strictement nécessaire.

## Implémentation
### Réalisé (DEV)
1. Création module `app/src/artifact-version-diff.js` avec API `diffArtifactVersions`.
2. Résolution de source conforme PM:
   - `contextFilterResult` prioritaire,
   - sinon `contextFilterInput` via délégation S018,
   - sinon `artifactPairs` direct,
   - sinon fail-closed `INVALID_ARTIFACT_DIFF_INPUT`.
3. Moteur diff déterministe livré (`metadata/sections/tables/contentSummary`).
4. Gestion candidats non éligibles (`ARTIFACT_DIFF_NOT_ELIGIBLE`, `unresolvedCandidates`, actions).
5. Agrégation provenance minimale FR-028 (`decisionRefs`, `gateRefs`, `commandRefs`).
6. Export public S019 ajouté dans `app/src/index.js`.
7. Tests S019 ajoutés:
   - unit, edge, e2e.

## Review
- [x] Mapping AC → tests documenté.
- [x] Vérification couverture module >= 95% lignes + branches.
- [x] Vérification seuil perf S019 (500 paires).
- [x] Résultat fast gates publié.

### Mapping AC → tests
- AC-01..AC-08 + AC-10:
  - `app/tests/unit/artifact-version-diff.test.js`
  - `app/tests/edge/artifact-version-diff.edge.test.js`
- AC-09:
  - `app/tests/e2e/artifact-version-diff.spec.js`

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/artifact-version-diff.test.js tests/edge/artifact-version-diff.edge.test.js`
4. `npx playwright test tests/e2e/artifact-version-diff.spec.js`
5. `npm run test:coverage`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests cas limites (edge)
- [x] coverage >= seuil
- [x] security scan dépendances (fast gate n’exécute pas audit complet)
- [x] build (fast gate n’exécute pas build complet)

## Status
READY_FOR_UXQA
