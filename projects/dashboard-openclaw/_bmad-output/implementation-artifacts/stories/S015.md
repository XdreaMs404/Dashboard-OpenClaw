# S015 - Extracteur sections H2/H3 pour navigation structurée (FR-023/FR-024)

## Epic
E02

## Handoff courant
H13 PM → DEV (scope strict S015)

## User story
En tant qu’orchestrateur BMAD,
je veux extraire de façon fiable les sections H2/H3 des artefacts markdown conformes,
afin d’alimenter une navigation structurée des preuves et préparer l’indexation des tableaux.

## Dépendances
- **S012** (`validateArtifactMetadataCompliance`) : garde-fou metadata (`stepsCompleted`, `inputDocuments`) + `sectionExtractionEligible`.
- **Planning E02-S03** (`_bmad-output/planning-artifacts/epics.md`) : source de vérité story-level.
- **PRD** (`_bmad-output/planning-artifacts/prd.md`) : FR-023, FR-024, AC-023A/B, AC-024A/B, NFR-006, NFR-012.
- **Architecture** (`_bmad-output/planning-artifacts/architecture.md`) :
  - endpoint cible `GET /api/v1/artifacts/{artifactId}/sections`,
  - projection cible `projection.artifact.sections`,
  - événement cible `artifact.section.indexed`.

## Traçabilité
- **FR-023** : extraire sections H2/H3 pour navigation structurée.
- **FR-024 (préparation)** : produire une structure sectionnable stable pour l’indexeur de tableaux (story suivante).
- **AC PRD** : AC-023A, AC-023B, AC-024A, AC-024B.
- **NFR-006** : traitement lot complet `< 60s`.
- **NFR-012** : aucun artefact silencieusement perdu dans la chaîne de traitement (0 drop non diagnostiqué).
- **Contraintes UX (H06)** : diagnostics explicites/actionnables + états d’interface complets.
- **Risques couverts** : T03, T08.

## Critères d'acceptation (mesurables)
- [x] **AC-01 — Extraction nominale H2/H3**
      Pour un lot markdown conforme et éligible, `extractArtifactSectionsForNavigation` retourne :
  - `allowed: true`
  - `reasonCode: "OK"`
  - `diagnostics.extractedCount = diagnostics.requestedCount`
  - `extractedArtifacts[*].sections` non vide avec `headingLevel` limité à `2 | 3`

- [x] **AC-02 — Ordonnancement et hiérarchie stables**
      Les sections extraites sont ordonnées par position d’apparition et incluent la relation hiérarchique :
  - `sections[*].anchor` déterministe
  - `sections[*].startLine` / `endLine` cohérents
  - `sections[*].parentHeadingId` renseigné pour les H3

- [x] **AC-03 — Détection sections manquantes**
      Si un artefact ciblé ne contient aucune section H2/H3 exploitable :
  - `allowed: false`
  - `reasonCode: "ARTIFACT_SECTIONS_MISSING"`
  - `nonExtractedArtifacts[*].sectionErrors` explicite le diagnostic
  - `correctiveActions` contient `ADD_STRUCTURED_HEADINGS`

- [x] **AC-04 — Garde-fou metadata S012 intégré**
      Si metadata manquante/invalide sur artefact ciblé :
  - blocage d’extraction pour cet artefact
  - `reasonCode` final cohérent (`ARTIFACT_METADATA_MISSING` ou `ARTIFACT_METADATA_INVALID`)
  - aucun contournement silencieux de la conformité S012

- [x] **AC-05 — Blocage hors allowlist**
      Si un artefact sort des racines autorisées :
  - `reasonCode: "ARTIFACT_PATH_NOT_ALLOWED"`
  - aucune exception non contrôlée

- [x] **AC-06 — Blocage type non supporté pour extraction sections**
      Si une extension hors `.md|.markdown` est soumise :
  - `reasonCode: "UNSUPPORTED_ARTIFACT_TYPE"`
  - diagnostic explicite par artefact

- [x] **AC-07 — Parse markdown robuste**
      Frontmatter/markdown invalide :
  - `reasonCode: "ARTIFACT_PARSE_FAILED"` localisé par artefact
  - aucun crash global du lot

- [x] **AC-08 — Contrat de sortie stable + préparation FR-024**
      La fonction retourne systématiquement :
      `{ allowed, reasonCode, reason, diagnostics, extractedArtifacts, nonExtractedArtifacts, correctiveActions }`
      avec :
  - `reasonCode` dans
    `OK | ARTIFACT_PATH_NOT_ALLOWED | UNSUPPORTED_ARTIFACT_TYPE | ARTIFACT_READ_FAILED | ARTIFACT_PARSE_FAILED | ARTIFACT_METADATA_MISSING | ARTIFACT_METADATA_INVALID | ARTIFACT_SECTIONS_MISSING | INVALID_SECTION_EXTRACTION_INPUT`
  - `diagnostics` contient au minimum
    `requestedCount`, `processedCount`, `extractedCount`, `nonExtractedCount`, `sectionCount`, `h2Count`, `h3Count`, `missingSectionsCount`, `allowlistRoots`, `durationMs`, `p95ExtractionMs`
  - `extractedArtifacts[*].tableIndexEligible === true` (préparation S014)

- [x] **AC-09 — UI e2e démonstrateur minimal**
      Couvrir `empty`, `loading`, `success`, `error` avec affichage explicite :
  - `reasonCode`
  - `reason`
  - compteurs sections (`h2Count`, `h3Count`, `sectionCount`)
  - `correctiveActions`

- [x] **AC-10 — Seuil qualité/performance module**
  - Couverture module S015 >= **95% lignes** et **95% branches**.
  - Benchmark corpus 500 docs :
    - `p95ExtractionMs <= 2000`
    - durée lot complet `< 60000 ms`
  - Conservation des comptes: `processedCount + nonExtractedCount = requestedCount`.

## Cas de test obligatoires
### Fonctionnels
- [x] Cas nominal: extraction H2/H3 sur lot markdown conforme -> `OK`.
- [x] Cas hiérarchie: H2/H3 imbriqués -> `parentHeadingId` correct.
- [x] Cas sections manquantes -> `ARTIFACT_SECTIONS_MISSING`.
- [x] Cas metadata manquante/invalide héritée S012 -> blocage explicite.
- [x] Cas hors allowlist -> `ARTIFACT_PATH_NOT_ALLOWED`.
- [x] Cas extension invalide (`.yaml`, `.json`) -> `UNSUPPORTED_ARTIFACT_TYPE`.
- [x] Cas parse invalide -> `ARTIFACT_PARSE_FAILED`.
- [x] Cas source absente -> `INVALID_SECTION_EXTRACTION_INPUT`.
- [x] Cas UI e2e: parcours `empty -> loading -> error/success`.

### Non-régression
- [x] `ingestBmadArtifacts` (S011) conserve son contrat public et ses reason codes.
- [x] `validateArtifactMetadataCompliance` (S012) conserve son contrat public et ses reason codes.
- [x] Les suites S001..S012 restent vertes.
- [x] Aucun changement de comportement non requis hors scope S015.

### Sécurité / robustesse
- [x] Validation stricte des entrées (allowlist, chemins, payload, metadata, headings).
- [x] Refus déterministe des chemins hors racines autorisées.
- [x] Aucune exécution shell dans S015.
- [x] Aucune mutation observable des entrées.

## Scope DEV strict S015
### Autorisé
1. Implémenter `extractArtifactSectionsForNavigation(input, options?)` dans `app/src/artifact-section-extractor.js`.
2. Exporter S015 dans `app/src/index.js` (export S015 uniquement).
3. Ajouter/adapter les tests S015:
   - `app/tests/unit/artifact-section-extractor.test.js`
   - `app/tests/edge/artifact-section-extractor.edge.test.js`
   - `app/tests/e2e/artifact-section-extractor.spec.js`
4. Ajuster **minimalement** `app/src/artifact-metadata-validator.js` uniquement si nécessaire au partage utilitaire, sans changement de comportement S012.
5. Mettre à jour la story S015 + handoffs DEV (`S015-dev-to-uxqa.md`, `S015-dev-to-tea.md`) avec preuves d’exécution.

### Interdit (hors-scope)
- Toute évolution hors FR-023/FR-024 / S015.
- Toute modification fonctionnelle des stories S001..S012 non strictement nécessaire à l’intégration S015.
- Tout refactor transverse non requis par les AC S015.
- Toute indexation de tableaux complète (scope S014).
- Toute exécution shell depuis les modules S015.

## Contraintes
- Validation metadata S012 obligatoire avant extraction sections.
- Types d’artefacts supportés pour extraction sections : `.md`, `.markdown`.
- Extraction limitée aux niveaux H2/H3 uniquement.
- Contrat de sortie déterministe et reason codes stables.
- Story non-DONE tant que **G4-T** et **G4-UX** ne sont pas tous deux PASS.

## Implémentation
### Réalisé (DEV)
1. Création de `app/src/artifact-section-extractor.js` avec API `extractArtifactSectionsForNavigation(input, options?)`.
2. Résolution des sources conforme PM:
   - `artifactDocuments` prioritaire,
   - sinon `artifactPaths` + `options.documentReader`,
   - sinon `INVALID_SECTION_EXTRACTION_INPUT`.
3. Intégration explicite du garde-fou S012 via appel `validateArtifactMetadataCompliance` (allowlist + type + parse + metadata).
4. Extraction H2/H3 avec:
   - ancres déterministes (`anchor`),
   - identifiants stables (`headingId`),
   - hiérarchie H3 (`parentHeadingId`),
   - repères de ligne (`startLine`, `endLine`).
5. Gestion explicite `ARTIFACT_SECTIONS_MISSING` + `sectionErrors`.
6. Contrat de sortie stable livré:
   `{ allowed, reasonCode, reason, diagnostics, extractedArtifacts, nonExtractedArtifacts, correctiveActions }`.
7. Préparation FR-024 intégrée: `extractedArtifacts[*].tableIndexEligible = true`.
8. Export S015 ajouté dans `app/src/index.js` (`extractArtifactSectionsForNavigation`).
9. Tests S015 ajoutés/renforcés:
   - `app/tests/unit/artifact-section-extractor.test.js`
   - `app/tests/edge/artifact-section-extractor.edge.test.js`
   - `app/tests/e2e/artifact-section-extractor.spec.js`

## Review
- [x] Mapping AC → tests documenté.
- [x] Vérification explicite des seuils performance NFR-006/NFR-012.
- [x] Vérification couverture module >= 95% lignes + branches.
- [x] Résultat gates techniques publié (PASS/CONCERNS/FAIL).

### Mapping AC → tests
- AC-01/02/03/04/05/06/07/08/10: `app/tests/unit/artifact-section-extractor.test.js`, `app/tests/edge/artifact-section-extractor.edge.test.js`
- AC-09: `app/tests/e2e/artifact-section-extractor.spec.js`
- AC-10 coverage: `npm run test:coverage` (S015 `artifact-section-extractor.js` = **99.26% lines**, **97.92% branches**)
- AC-10 performance (500 docs): test unitaire dédié (`p95ExtractionMs <= 2000`, durée `< 60000`)

### Gates techniques (DEV)
Commande de revalidation exécutée depuis `app/` (UTC 2026-02-22T09:08:44Z → 2026-02-22T09:09:27Z):
`npm run lint && npm run typecheck && npx vitest run tests/unit tests/edge && npx playwright test tests/e2e && npm run test:coverage && npm run build && npm run security:deps` ✅

Preuve log complète: `_bmad-output/implementation-artifacts/handoffs/S015-tech-gates.log`

Résultats observés:
- `npm run lint` ✅
- `npm run typecheck` ✅
- `npx vitest run tests/unit tests/edge` ✅ (**30 fichiers / 382 tests passés**)
- `npx playwright test tests/e2e` ✅ (**29/29 tests passés**)
- `npm run test:coverage` ✅
  - global: **99.34% statements / 97.86% branches / 100% functions / 99.32% lines**
  - module S015 `app/src/artifact-section-extractor.js`: **99.30% statements / 97.92% branches / 100% functions / 99.26% lines**
- `npm run build` ✅
- `npm run security:deps` ✅ (`npm audit --audit-level=high`: **0 vulnérabilité**)
- Verdict technique DEV: **PASS**

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/artifact-section-extractor.test.js tests/edge/artifact-section-extractor.edge.test.js`
4. `npx playwright test tests/e2e/artifact-section-extractor.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests cas limites (edge)
- [x] coverage >= seuil
- [x] security scan dépendances
- [x] build

## Règle Story DONE
- Interdit de passer DONE si un seul gate échoue (technique OU UX).
- Audit UX obligatoire: `_bmad-output/implementation-artifacts/ux-audits/<SID>-ux-audit.json` avec verdict PASS.
- Utiliser `bash scripts/story-done-guard.sh <SID>` pour valider la fin.

## UX Gates obligatoires
- [ ] conformité design-system (tokens, spacing, typo, composants)
- [ ] accessibilité WCAG 2.2 AA (minimum)
- [ ] responsive (mobile/tablet/desktop)
- [ ] états d'interface (loading/empty/error/success)
- [ ] hiérarchie visuelle et lisibilité
- [ ] evidence UX fournie (captures/rapports)

## Status
- Dernière revalidation DEV (UTC): 2026-02-22T09:09:27Z
READY_FOR_UX_AUDIT
READY_FOR_TEA
