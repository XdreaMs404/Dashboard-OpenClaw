# S003 - Projection d’état de phase (owner, started_at, finished_at, statut, durée) avec blocage SLA visible

## Epic
E01

## User story
En tant qu’orchestrateur BMAD,
je veux disposer d’un objet de projection exploitable UI qui expose pour chaque phase `owner`, `started_at`, `finished_at`, `status` et `duration_ms`,
afin de visualiser instantanément l’état d’avancement d’une phase et le motif de blocage lié au SLA de notification.

## Dépendance
- S002 (validateur de transitions) doit être réutilisée comme source de vérité pour les motifs de blocage de transition (`reasonCode`, `reason`).

## Traçabilité
- FR-003: bloquer/expliciter les transitions lorsque la notification de phase est absente ou hors SLA.
- FR-004: afficher owner, started_at, finished_at, statut et durée pour chaque phase.
- NFR-017: SLA notification par défaut 10 minutes (bloquant).
- NFR-034: exposition continue de signaux exploitables pour pilotage.
- Risques couverts: P03, P06.

## Critères d'acceptation
- [x] AC-01 (Nominal - phase terminée): pour une phase valide avec `owner` non vide, `startedAt` et `finishedAt` valides (`finishedAt >= startedAt`), la projection retourne `status: "done"`, expose `owner`, `started_at`, `finished_at`, et calcule `duration_ms = finishedAt - startedAt`.
- [x] AC-02 (Nominal - phase en cours): pour `startedAt` valide et `finishedAt = null`, la projection retourne `status: "running"` et calcule `duration_ms = nowAt - startedAt` (avec `nowAt` injectable pour tests déterministes).
- [x] AC-03 (Nominal - phase non démarrée): pour `startedAt = null` et `finishedAt = null` sans blocage, la projection retourne `status: "pending"` et `duration_ms = null`.
- [x] AC-04 (Blocage lié transition): si le résultat S002 passé en entrée indique `allowed: false` avec `reasonCode` dans `TRANSITION_NOT_ALLOWED | PHASE_NOTIFICATION_MISSING | PHASE_NOTIFICATION_SLA_EXCEEDED`, la projection retourne `status: "blocked"` et ré-expose `blockingReasonCode` + `blockingReason`.
- [x] AC-05 (Horodatages invalides): si `finishedAt < startedAt` ou date invalide, la projection retourne `status: "blocked"`, `blockingReasonCode: "INVALID_PHASE_TIMESTAMPS"`, `duration_ms = null`, sans exception non contrôlée.
- [x] AC-06 (Entrées invalides): si `phaseId` hors `H01..H23` ou `owner` vide/blanc, la projection retourne `status: "blocked"`, `blockingReasonCode: "INVALID_PHASE_STATE"`, sans crash.
- [x] AC-07 (Contrat de sortie stable): la fonction retourne systématiquement
  `{ phaseId, owner, started_at, finished_at, status, duration_ms, blockingReasonCode, blockingReason, diagnostics }`
  avec `status` dans `pending | running | done | blocked` et `diagnostics` contenant au minimum `startedMs`, `finishedMs`, `nowMs`.
- [x] AC-08 (Seuil qualité): couverture du module de projection >= 95% (lignes + branches).

## Cas de test obligatoires
### Fonctionnels
- [x] Cas nominal done: `H02` avec owner + started/finished valides -> `status=done`, `duration_ms` exacte.
- [x] Cas nominal running: `H03` avec started valide, finished null -> `status=running`, `duration_ms` calculée depuis `nowAt`.
- [x] Cas nominal pending: started/finished absents -> `status=pending`, `duration_ms=null`.
- [x] Cas blocage transition: projection alimentée par résultat S002 `PHASE_NOTIFICATION_MISSING` -> `status=blocked` + motif visible.
- [x] Cas SLA dépassé: projection alimentée par résultat S002 `PHASE_NOTIFICATION_SLA_EXCEEDED` -> `status=blocked` + motif visible.
- [x] Cas UI e2e: démonstrateur minimal avec états `empty`, `loading`, `success`, `error` affichant owner + timestamps + statut + durée + raison de blocage.

### Non-régression
- [x] `validatePhaseTransition` (S002) conserve son contrat et ses reason codes.
- [x] Les fonctions existantes (`safeDivide`, `normalizeEmail`, `normalizeUserName`, `clamp`) restent inchangées.
- [x] Les tests unitaires/edge/e2e déjà en place restent verts.

### Sécurité / robustesse
- [x] Validation stricte des entrées (phase, owner, dates invalides).
- [x] Aucune mutation observable des objets d’entrée.
- [x] Aucun `eval`/exécution dynamique risquée.
- [x] Messages de blocage explicites et exploitables côté UI.

## Contraintes
- Réutiliser S002 comme source de vérité pour les blocages de transition (pas de duplication de logique métier contradictoire).
- SLA par défaut conservé à 10 minutes via le validateur S002.
- `status` autorisé uniquement dans `pending | running | done | blocked`.
- Scope strict S003: ne pas modifier d’autres stories.

## Implémentation
### Réalisé (DEV)
1. Création du module `app/src/phase-state-projection.js` avec API `buildPhaseStateProjection(input)`.
2. Implémentation des statuts `pending | running | done | blocked` avec calcul `duration_ms`.
3. Ajout des blocages locaux `INVALID_PHASE_STATE` et `INVALID_PHASE_TIMESTAMPS`.
4. Réutilisation explicite de S002 via:
   - `transitionValidation` en entrée (résultat de `validatePhaseTransition`),
   - support optionnel `transitionInput` délégué à `validatePhaseTransition`.
5. Export de l’API publique dans `app/src/index.js` (`buildPhaseStateProjection`).
6. Ajout des tests story:
   - `app/tests/unit/phase-state-projection.test.js`
   - `app/tests/edge/phase-state-projection.edge.test.js`
   - `app/tests/e2e/phase-state-projection.spec.js`

## Review
- Mapping AC → tests:
  - AC-01/02/03/05/06/07: `tests/unit/phase-state-projection.test.js`
  - AC-04 (blocages issus S002): `tests/unit/phase-state-projection.test.js`, `tests/edge/phase-state-projection.edge.test.js`, `tests/e2e/phase-state-projection.spec.js`
  - AC-08 (coverage module >=95%): `npm run test:coverage` (`phase-state-projection.js` = **100% lines**, **97.59% branches**)
- Résultat gates techniques exécutés: PASS (`lint`, `typecheck`, `vitest`, `playwright`, `edge`, `coverage`, `build`, `security:deps`).

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit tests/edge`
4. `npx playwright test tests/e2e`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`


## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests cas limites (edge)
- [x] coverage >= seuil
- [x] security scan dépendances
- [x] build

## Règle Story DONE
- Interdit de passer DONE si un seul gate échoue (technique OU UX).
- Audit UX obligatoire: `_bmad-output/implementation-artifacts/ux-audits/<SID>-ux-audit.json` avec verdict PASS.
- Utiliser `bash scripts/story-done-guard.sh <SID>` pour valider la fin.

## UX Gates obligatoires
- [ ] conformité design-system (tokens, spacing, typo, composants)
- [ ] accessibilité WCAG 2.2 AA (minimum)
- [ ] responsive (mobile/tablet/desktop)
- [ ] états d'interface (loading/empty/error/success)
- [ ] hiérarchie visuelle et lisibilité
- [ ] evidence UX fournie (captures/rapports)

## Status
READY_FOR_REVIEW
