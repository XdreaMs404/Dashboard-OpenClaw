# S003 - SLA de notification de phase et blocage

canonical_story_id: E01-S03
epic: E01
source_of_truth: _bmad-output/planning-artifacts/epics.md

## Scope canonique
- Story ID canonique: `E01-S03`
- FR clés: FR-003, FR-004
- NFR clés: NFR-017, NFR-034
- Risques: P03, P06
- Dépendance story: E01-S02

## Pourquoi réouverture
- Story réouverte pour réalignement canonique: fr_missing:FR-003,FR-004
- Ancienne version archivée sous `_bmad-output/implementation-artifacts/archive/`.

## Checklist Delivery
- [x] Implémentation conforme au scope canonique
- [x] Tests unit/intégration (intégration couverte via délégation S002 + e2e)
- [x] Tests edge
- [x] Tests e2e
- [x] Coverage >= seuil
- [x] Security scan dépendances
- [x] Build
- [ ] Audit UX PASS

## Exécution DEV (H13/H16)
- Date exécution gates (UTC): 2026-02-22T12:05:07Z → 2026-02-22T12:05:52Z
- Preuve logs: `_bmad-output/implementation-artifacts/handoffs/S003-tech-gates.log`
- Fichiers scope validés:
  - `app/src/phase-state-projection.js`
  - `app/src/index.js`
  - `app/tests/unit/phase-state-projection.test.js`
  - `app/tests/edge/phase-state-projection.edge.test.js`
  - `app/tests/e2e/phase-state-projection.spec.js`
- Résultats:
  - lint/typecheck/build/security: PASS
  - tests unit+edge (suite complète): 32 fichiers / 407 tests PASS
  - tests e2e (suite complète): 31/31 PASS
  - coverage module `phase-state-projection.js`: 100% lines / 97.59% branches / 100% functions

## Mapping AC → tests
- AC-01 (FR-003 blocage SLA notification)
  - unit: `returns blocked and re-exposes transition reason from S002 (missing notification)`
  - unit: `returns blocked and re-exposes transition reason from S002 (SLA exceeded)`
  - edge: `supports transitionInput by delegating validation to S002`
  - e2e: scénario `missing-notification` (blocage visible avec reason code)
- AC-02 (FR-004 affichage owner/started_at/finished_at/status/duration)
  - unit: `returns done with owner, timestamps and duration for completed phase`
  - unit: `returns running and uses injectable nowAt for deterministic duration`
  - e2e: scénario `done` (tous les champs FR-004 visibles)
- AC-03 (NFR-017 < 10 min)
  - unit: cas `SLA exceeded` (`elapsedMs=600001` via S002) ⇒ blocage déterministe
  - edge: propagation des codes SLA S002 sans contournement
- AC-04 (NFR-034 métriques disponibles en continu)
  - unit: `keeps stable output contract and index export` (présence diagnostics)
  - edge: `does not mutate the input payload`, `falls back to current time when nowAt is blank`
  - contrat diagnostics exposé: `startedMs`, `finishedMs`, `nowMs`, `transitionAllowed`, `transitionReasonCode`

## Comment tester (simple)
- `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-story-gates.sh S003`
- `BMAD_PROJECT_ROOT=/root/.openclaw/workspace/projects/dashboard-openclaw bash /root/.openclaw/workspace/bmad-total/scripts/run-ux-gates.sh S003`

## Status
READY_FOR_UXQA_TEA
