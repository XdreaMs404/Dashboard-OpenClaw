# S005 - Checklist prérequis avant activation de phase (FR-005/FR-006)

## Epic
E01

## Handoff courant
H13 PM → DEV (scope strict S005)

## User story
En tant qu’orchestrateur BMAD,
je veux valider de manière déterministe les prérequis obligatoires avant l’activation d’une phase,
afin d’empêcher les transitions non prêtes et de fournir un signal contrôlé pour l’exécution des guards `sequence-guard` / `ultra-quality-check`.

## Dépendances
- **S004** (`buildPhaseStateProjection`) : source d’état phase + contexte d’activation.
- **S002** (`validatePhaseTransition`) : contrôle canonique des transitions H01→H23.
- **S003** (SLA notification) : propagation des blocages `PHASE_NOTIFICATION_MISSING` / `PHASE_NOTIFICATION_SLA_EXCEEDED`.
- **S006** (`orchestratePhaseGuards`) : consommateur aval du verdict S005 pour orchestration contrôlée des guards.
- **Planning E01-S05** (`_bmad-output/planning-artifacts/epics.md`) : story canonique FR-005/FR-006.
- **PRD** (`_bmad-output/planning-artifacts/prd.md`) : FR-005, FR-006, AC-005A/B, AC-006A/B, NFR-040, NFR-011.
- **Architecture** (`_bmad-output/planning-artifacts/architecture.md`) :
  - API workflow `POST /api/v1/workflow/transitions/validate`,
  - commandes allowlist `CMD-008` (`phase13-sequence-guard.sh`) et `CMD-009` (`phase13-ultra-quality-check.sh`),
  - métrique `m_phase_transition_latency_ms`.
- **Epics index** (`_bmad-output/planning-artifacts/epics-index.md`) : E01 = fondation canonique avant extension.

## Traçabilité
- **FR-005** : exiger les prérequis déclarés avant activation de la phase suivante.
- **FR-006 (dans le scope S005)** : produire un verdict de contrôle exploitable et sûr pour l’exécution des guards en aval (S006), sans exécution shell directe dans S005.
- **AC PRD** : AC-005A, AC-005B, AC-006A, AC-006B.
- **NFR-040** : time-to-first-value < 14 jours (lisibilité + actionnabilité du verdict).
- **NFR-011** : fiabilité >= 99.5% (comportement déterministe, fail-closed).
- **Risques couverts** : P07, P01.

## Critères d'acceptation (mesurables)
- [ ] **AC-01 — Validation nominale FR-005**
      `validatePhasePrerequisites` retourne :
  - `allowed: true`
  - `reasonCode: "OK"`
  - `diagnostics.requiredCount` / `satisfiedCount` cohérents
      quand tous les prérequis requis sont `done` sur une transition canonique autorisée.

- [ ] **AC-02 — Blocage checklist absente / invalide / incomplète**
      Le module échoue en fail-closed avec reason codes stricts :
  - `PHASE_PREREQUISITES_MISSING` (checklist absente/vide/non tableau)
  - `INVALID_PHASE_PREREQUISITES` (items invalides)
  - `PHASE_PREREQUISITES_INCOMPLETE` (prérequis requis non `done`).

- [ ] **AC-03 — Propagation blocages transition/SLA amont**
      Si S002/S003 retourne `allowed=false` avec
      `INVALID_PHASE | TRANSITION_NOT_ALLOWED | PHASE_NOTIFICATION_MISSING | PHASE_NOTIFICATION_SLA_EXCEEDED`,
      S005 propage strictement ce `reasonCode` sans réécriture ambigüe.

- [ ] **AC-04 — Résolution sources flexible**
  - `transitionValidation` injecté prioritaire,
  - sinon `transitionInput` -> délégation `validatePhaseTransition`,
  - sinon fallback déterministe via payload direct.

- [ ] **AC-05 — Contrat checklist strict**
      Chaque item prérequis respecte :
  - `id` chaîne non vide,
  - `required` booléen,
  - `status` dans `done | pending | blocked`.
      Les IDs en doublon et statuts invalides sont rejetés (`INVALID_PHASE_PREREQUISITES`).

- [ ] **AC-06 — Signal contrôlé pour FR-006 (préparation S006)**
      La sortie S005 est directement exploitable par l’orchestrateur guards (S006) :
  - `allowed=false` bloque toute exécution guard,
  - `allowed=true` autorise la suite de flux,
  - aucune exécution script shell dans S005.

- [ ] **AC-07 — Contrat de sortie stable**
      La fonction retourne systématiquement:
      `{ allowed, reasonCode, reason, diagnostics }`
      avec `diagnostics` contenant au minimum :
  - `fromPhase`, `toPhase`,
  - `requiredCount`, `satisfiedCount`, `missingPrerequisiteIds`,
  - `blockedByTransition`, `transitionAllowed`, `transitionReasonCode`.

- [ ] **AC-08 — Robustesse entrées invalides**
      Entrées non objet / phases invalides / timestamps incohérents en amont ->
  - aucune exception non contrôlée,
  - blocage explicite (`INVALID_PHASE` ou code amont propagé).

- [ ] **AC-09 — UI e2e démonstrateur minimal**
      Couvrir `empty`, `loading`, `success`, `error` avec affichage explicite :
  - `reasonCode`, `reason`,
  - `missingPrerequisiteIds`,
  - état d’activation autorisée/refusée.

- [ ] **AC-10 — Seuil qualité/performance module**
  - Couverture module S005 >= **95% lignes** et **95% branches**.
  - p95 validation `< 5000 ms` sur corpus de 500 entrées.
  - non-régression S001..S004 prouvée.

## Cas de test obligatoires
### Fonctionnels
- [ ] Cas nominal transition canonique + checklist complète -> `OK`.
- [ ] Cas checklist absente/vide/non tableau -> `PHASE_PREREQUISITES_MISSING`.
- [ ] Cas checklist invalide (id vide, required non bool, status invalide, doublon) -> `INVALID_PHASE_PREREQUISITES`.
- [ ] Cas checklist incomplète (required != done) -> `PHASE_PREREQUISITES_INCOMPLETE` + IDs manquants.
- [ ] Cas propagation `TRANSITION_NOT_ALLOWED` depuis S002.
- [ ] Cas propagation SLA (`PHASE_NOTIFICATION_MISSING` / `PHASE_NOTIFICATION_SLA_EXCEEDED`) depuis S003.
- [ ] Cas fallback unknown reason amont -> blocage explicite et reason text stable.
- [ ] Cas UI e2e `empty -> loading -> error/success`.

### Non-régression
- [ ] `validatePhaseTransition` (S002) conserve son contrat public.
- [ ] `evaluatePhaseSlaAlert` (S003) conserve ses reason codes SLA.
- [ ] `buildPhaseStateProjection` (S004) conserve son contrat public.
- [ ] `orchestratePhaseGuards` (S006) consomme correctement le verdict S005 sans régression.

### Sécurité / robustesse
- [ ] Validation stricte des entrées et fail-closed.
- [ ] Aucune mutation observable du payload d’entrée.
- [ ] Aucune exécution shell dans S005.
- [ ] Reason codes bornés et messages explicites/actionnables.

## Scope DEV strict S005
### Autorisé
1. Implémenter/ajuster `validatePhasePrerequisites(input)` dans `app/src/phase-prerequisites-validator.js`.
2. Ajouter/ajuster l’export S005 dans `app/src/index.js` (sans changements hors S005).
3. Ajouter/adapter les tests S005:
   - `app/tests/unit/phase-prerequisites-validator.test.js`
   - `app/tests/edge/phase-prerequisites-validator.edge.test.js`
   - `app/tests/e2e/phase-prerequisites-validator.spec.js`
4. Ajuster **minimalement** `app/src/phase-transition-validator.js` uniquement si requis pour alignement contractuel S005.
5. Mettre à jour la story S005 + handoffs DEV (`S005-dev-to-uxqa.md`, `S005-dev-to-tea.md`) avec preuves gates.

### Interdit (hors-scope)
- Toute évolution hors FR-005/FR-006 / S005.
- Toute orchestration/exécution shell de `phase13-sequence-guard.sh` ou `phase13-ultra-quality-check.sh` (scope S006).
- Tout refactor transverse non requis par les AC S005.
- Toute modification fonctionnelle hors S005 non strictement nécessaire.

## Contraintes
- `BMAD_PHASE_ORDER` reste la source canonique de séquencement.
- Les blocages transition/SLA amont (S002/S003) sont propagés sans contournement.
- Les reason codes doivent rester déterministes et bornés à:
  `OK | INVALID_PHASE | TRANSITION_NOT_ALLOWED | PHASE_NOTIFICATION_MISSING | PHASE_NOTIFICATION_SLA_EXCEEDED | PHASE_PREREQUISITES_MISSING | PHASE_PREREQUISITES_INCOMPLETE | INVALID_PHASE_PREREQUISITES`.
- Story non-DONE tant que **G4-T** et **G4-UX** ne sont pas tous deux PASS.

## Implémentation
### À réaliser (DEV)
- Implémentation module + tests + e2e + preuves gates selon scope S005.

## Review
- [ ] Mapping AC → tests documenté.
- [ ] Vérification explicite FR-005/FR-006 + NFR-040/NFR-011.
- [ ] Vérification couverture >= 95% lignes + branches.
- [ ] Résultat gates techniques publié (PASS/CONCERNS/FAIL).

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/phase-prerequisites-validator.test.js tests/edge/phase-prerequisites-validator.edge.test.js`
4. `npx playwright test tests/e2e/phase-prerequisites-validator.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`

## Quality Gates obligatoires
- [ ] lint
- [ ] typecheck
- [ ] tests unit/intégration
- [ ] tests e2e
- [ ] tests cas limites (edge)
- [ ] coverage >= seuil
- [ ] security scan dépendances
- [ ] build

## Règle Story DONE
- Interdit de passer DONE si un seul gate échoue (technique OU UX).
- Audit UX obligatoire: `_bmad-output/implementation-artifacts/ux-audits/<SID>-ux-audit.json` avec verdict PASS.
- Utiliser `bash scripts/story-done-guard.sh <SID>` pour valider la fin.

## UX Gates obligatoires
- [ ] conformité design-system (tokens, spacing, typo, composants)
- [ ] accessibilité WCAG 2.2 AA (minimum)
- [ ] responsive (mobile/tablet/desktop)
- [ ] états d'interface (loading/empty/error/success)
- [ ] hiérarchie visuelle et lisibilité
- [ ] evidence UX fournie (captures/rapports)

## Status
READY_FOR_DEV
