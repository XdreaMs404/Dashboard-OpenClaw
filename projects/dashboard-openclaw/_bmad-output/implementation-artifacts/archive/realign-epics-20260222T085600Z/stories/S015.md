# S015 - Recherche full-text avec filtres dynamiques (FR-025/FR-026)

## Epic
E02

## Handoff courant
H13 PM → DEV (scope strict S015)

## User story
En tant qu’orchestrateur BMAD,
je veux rechercher en plein texte les artefacts indexés avec des filtres dynamiques,
afin d’identifier rapidement les preuves pertinentes sans naviguer manuellement tout le corpus.

## Dépendances
- **S014** (`indexArtifactMarkdownTables`) : source de vérité de l’éligibilité de recherche et des blocages d’indexation.
- **S013** (`extractArtifactSectionsForNavigation`) : sections structurées utilisées pour contextualiser les extraits de résultats.
- **S012** (`validateArtifactMetadataCompliance`) : conformité metadata obligatoire (prévention des faux positifs).
- **S011** (`ingestBmadArtifacts`) : ingestion allowlist + parse source.
- **Planning E02-S05** (`_bmad-output/planning-artifacts/epics.md`) : story source de vérité pour FR-025/FR-026.
- **PRD** (`_bmad-output/planning-artifacts/prd.md`) : FR-025, FR-026, AC-025A/B, AC-026A/B, NFR-016, NFR-038.
- **Architecture** (`_bmad-output/planning-artifacts/architecture.md`) :
  - endpoint cible `GET /api/v1/artifacts/search`,
  - projection cible `projection.artifact.search`,
  - service cible `svc-search`.
- **Epics index** (`_bmad-output/planning-artifacts/epics-index.md`) : E02 dépend de E01, cohérence de séquencement respectée.

## Traçabilité
- **FR-025** : fournir une recherche plein texte avec filtrage instantané par type d’artefact.
- **FR-026** : permettre le filtrage contextuel par phase, agent, date, gate, owner et niveau de risque.
- **AC PRD** : AC-025A, AC-025B, AC-026A, AC-026B.
- **NFR-016** : robustesse/retry borné et erreurs explicites exploitables.
- **NFR-038** : compatibilité parser/corpus de référence sans rupture.
- **Contraintes UX (H06)** : états `loading/empty/error/success`, microcopie non ambiguë, diagnostics actionnables.
- **Risques couverts** : P02, T01.

## Critères d'acceptation (mesurables)
- [ ] **AC-01 — Recherche nominale full-text**
      Pour une requête valide sur un corpus indexé, `searchArtifactsFullText` retourne :
  - `allowed: true`
  - `reasonCode: "OK"`
  - `results.length > 0`
  - `diagnostics.matchedCount > 0`
  - résultats triés de manière déterministe par `score` décroissant puis `artifactPath`.

- [ ] **AC-02 — Filtrage dynamique par type d’artefact (FR-025)**
      Avec `filters.artifactTypes` (ex: `prd|architecture|ux|epics|readiness-check`), la recherche :
  - limite les résultats aux types ciblés,
  - expose `appliedFilters.artifactTypes`,
  - met à jour `diagnostics.filteredOutCount`.

- [ ] **AC-03 — Filtrage contextuel (FR-026)**
      Avec filtres contextuels (`phase`, `agent`, `dateFrom/dateTo`, `gate`, `owner`, `riskLevel`) :
  - seuls les artefacts compatibles sont retournés,
  - chaque filtre appliqué est visible dans `appliedFilters`,
  - aucune exception non contrôlée n’est levée si un filtre exclut tous les résultats.

- [ ] **AC-04 — Extraits et pertinence explicites**
      Chaque résultat contient :
  - `artifactPath`, `artifactType`, `score`,
  - `snippet` textuel avec mise en évidence des tokens de requête,
  - `matchedFields` (au minimum `content`, et si disponible `sections`/`tables`).

- [ ] **AC-05 — Propagation stricte des blocages amont (S014)**
      Si la source d’indexation est bloquée (`ARTIFACT_PATH_NOT_ALLOWED | UNSUPPORTED_ARTIFACT_TYPE | ARTIFACT_READ_FAILED | ARTIFACT_PARSE_FAILED | ARTIFACT_METADATA_MISSING | ARTIFACT_METADATA_INVALID | ARTIFACT_SECTIONS_MISSING | ARTIFACT_TABLES_MISSING`), la sortie S015 :
  - propage strictement le `reasonCode` amont,
  - reste `allowed: false`,
  - inclut des `correctiveActions` explicites.

- [ ] **AC-06 — Résolution de sources flexible**
  - `searchIndex` injecté -> utilisé tel quel,
  - sinon `tableIndexResult` injecté -> utilisé comme base,
  - sinon `tableIndexInput` -> délégation à S014 (`indexArtifactMarkdownTables`),
  - absence de source exploitable -> `INVALID_ARTIFACT_SEARCH_INPUT`.

- [ ] **AC-07 — Entrées invalides**
      Entrées invalides (requête vide, filtres invalides, pagination invalide, payload index incohérent) ->
  - `allowed: false`
  - `reasonCode: "INVALID_ARTIFACT_SEARCH_INPUT"`
  - aucune exception non contrôlée.

- [ ] **AC-08 — Contrat de sortie stable**
      La fonction retourne systématiquement :
      `{ allowed, reasonCode, reason, diagnostics, results, appliedFilters, correctiveActions }`
      avec :
  - `reasonCode` dans
    `OK | ARTIFACT_PATH_NOT_ALLOWED | UNSUPPORTED_ARTIFACT_TYPE | ARTIFACT_READ_FAILED | ARTIFACT_PARSE_FAILED | ARTIFACT_METADATA_MISSING | ARTIFACT_METADATA_INVALID | ARTIFACT_SECTIONS_MISSING | ARTIFACT_TABLES_MISSING | INVALID_ARTIFACT_SEARCH_INPUT`
  - `diagnostics` contenant au minimum
    `query`, `requestedCount`, `indexedCount`, `matchedCount`, `filteredOutCount`, `durationMs`, `p95SearchMs`, `sourceReasonCode`
  - `results[*].artifactPath` non vide et `results[*].score` numérique.

- [ ] **AC-09 — UI e2e démonstrateur minimal**
      Couvrir `empty`, `loading`, `success`, `error` avec affichage explicite :
  - `reasonCode`
  - `reason`
  - `matchedCount` et `filteredOutCount`
  - `appliedFilters`
  - `correctiveActions`.

- [ ] **AC-10 — Seuil qualité/performance module**
  - Couverture module S015 >= **95% lignes** et **95% branches**.
  - Benchmark corpus 500 docs :
    - `p95SearchMs <= 2000`
    - lot de recherche complet `< 60000 ms`.
  - Pertinence vérifiable sur corpus de référence (requête connue -> artefact attendu présent dans top résultats).

## Cas de test obligatoires
### Fonctionnels
- [ ] Cas nominal: requête valide -> résultats ordonnés avec `score`/`snippet`.
- [ ] Cas filtre type artefact: exclusion/inclusion dynamique correcte.
- [ ] Cas filtres contextuels combinés (`phase+owner+gate`) -> résultat cohérent.
- [ ] Cas zéro résultat: `allowed=true`, `reasonCode=OK`, `results=[]`, compteurs cohérents.
- [ ] Cas propagation blocage amont S014 -> reason code strictement propagé.
- [ ] Cas délégation S014 (`tableIndexInput`) -> résolution correcte.
- [ ] Cas index injecté (`searchIndex`) -> prioritaire sur délégation.
- [ ] Cas query invalide/filtres invalides -> `INVALID_ARTIFACT_SEARCH_INPUT`.
- [ ] Cas UI e2e: `empty -> loading -> error/success`.

### Non-régression
- [ ] `indexArtifactMarkdownTables` (S014) conserve son contrat public et ses reason codes.
- [ ] `extractArtifactSectionsForNavigation` (S013), `validateArtifactMetadataCompliance` (S012), `ingestBmadArtifacts` (S011) conservent leurs contrats.
- [ ] Les suites S001..S014 restent vertes.
- [ ] Aucun changement de comportement non requis hors scope S015.

### Sécurité / robustesse
- [ ] Validation stricte des entrées (`query`, `filters`, `pagination`, payload index).
- [ ] Aucune exécution shell dans S015.
- [ ] Aucune mutation observable des entrées.
- [ ] Tokenisation/recherche sans regex dangereuse ni exécution dynamique.

## Scope DEV strict S015
### Autorisé
1. Implémenter `searchArtifactsFullText(input, options?)` dans `app/src/artifact-fulltext-search.js`.
2. Exporter S015 dans `app/src/index.js` (export S015 uniquement).
3. Ajouter/adapter les tests S015:
   - `app/tests/unit/artifact-fulltext-search.test.js`
   - `app/tests/edge/artifact-fulltext-search.edge.test.js`
   - `app/tests/e2e/artifact-fulltext-search.spec.js`
4. Ajuster **minimalement** `app/src/artifact-table-indexer.js` uniquement si nécessaire au partage utilitaire, sans changement de comportement S014.
5. Mettre à jour la story S015 + handoffs DEV (`S015-dev-to-uxqa.md`, `S015-dev-to-tea.md`) avec preuves d’exécution.

### Interdit (hors-scope)
- Toute évolution hors FR-025/FR-026 / S015.
- Toute implémentation du moteur diff d’artefacts (scope S016/S017 selon backlog effectif).
- Toute modification fonctionnelle des stories S001..S014 non strictement nécessaire à l’intégration S015.
- Tout refactor transverse non requis par les AC S015.
- Toute exécution shell depuis les modules S015.

## Contraintes
- S014 reste la source de vérité pour l’éligibilité de recherche et les blocages d’index.
- Recherche strictement bornée aux artefacts allowlist validés.
- Filtres FR-026 supportés sans ambiguïté de contrat (`phase`, `agent`, `date`, `gate`, `owner`, `riskLevel`).
- Contrat de sortie déterministe et reason codes stables.
- Story non-DONE tant que **G4-T** et **G4-UX** ne sont pas tous deux PASS.

## Implémentation
### À réaliser (DEV)
- Implémentation module + tests + e2e + evidence gates conformément au scope S015 ci-dessus.

## Review
- [ ] Mapping AC → tests documenté.
- [ ] Vérification explicite des seuils performance AC-025A/AC-026A.
- [ ] Vérification couverture module >= 95% lignes + branches.
- [ ] Résultat gates techniques publié (PASS/CONCERNS/FAIL).

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/artifact-fulltext-search.test.js tests/edge/artifact-fulltext-search.edge.test.js`
4. `npx playwright test tests/e2e/artifact-fulltext-search.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`


## Quality Gates obligatoires
- [ ] lint
- [ ] typecheck
- [ ] tests unit/intégration
- [ ] tests e2e
- [ ] tests cas limites (edge)
- [ ] coverage >= seuil
- [ ] security scan dépendances
- [ ] build

## Règle Story DONE
- Interdit de passer DONE si un seul gate échoue (technique OU UX).
- Audit UX obligatoire: `_bmad-output/implementation-artifacts/ux-audits/<SID>-ux-audit.json` avec verdict PASS.
- Utiliser `bash scripts/story-done-guard.sh <SID>` pour valider la fin.

## UX Gates obligatoires
- [ ] conformité design-system (tokens, spacing, typo, composants)
- [ ] accessibilité WCAG 2.2 AA (minimum)
- [ ] responsive (mobile/tablet/desktop)
- [ ] états d'interface (loading/empty/error/success)
- [ ] hiérarchie visuelle et lisibilité
- [ ] evidence UX fournie (captures/rapports)

## Status
READY_FOR_DEV
