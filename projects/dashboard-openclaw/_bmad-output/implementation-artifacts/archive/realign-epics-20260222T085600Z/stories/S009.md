# S009 - Matrice des dépendances bloquantes inter-phases en temps réel

## Epic
E01

## Handoff courant
H13 PM → DEV (scope strict S009)

## User story
En tant qu’orchestrateur BMAD,
je veux visualiser une matrice des dépendances bloquantes inter-phases avec un état temps réel,
afin d’identifier immédiatement ce qui bloque une transition et lancer l’action corrective la plus utile.

## Dépendances
- **S002** (`validatePhaseTransition`) : source de vérité des transitions autorisées et motifs de blocage.
- **S003** (`buildPhaseStateProjection`) : source de `owner` et contexte phase pour message de blocage explicite.
- **S004** (`validatePhasePrerequisites`) : source de vérité des dépendances checklist pré-phase.
- **S008** (`evaluatePhaseTransitionOverride`) : source de contexte override exceptionnel (demande, approbateur, conflit).
- **S001..S008** (`app/src` + tests) : non-régression obligatoire.

## Traçabilité
- **FR-010** : afficher les dépendances bloquantes inter-phases et leur état en temps réel.
- **FR-009 (réutilisation)** : contextualiser les blocages overrideables via la décision S008.
- **AC-010A (PRD)** : rafraîchissement visible <= 5s pour 95% des cas (détection staleness explicite).
- **AC-010B (PRD)** : blocage 100% sur transition invalide / notify manquant avec message explicite et owner affiché.
- **NFR-013** : validation correcte >= 95% (reason codes + contrat stable).
- **NFR-034** : diagnostics continus exploitables pour pilotage/handoff.
- **Risques couverts** : P01, P06, P07.

## Critères d'acceptation (mesurables)
- [x] **AC-01 — Nominal sans blocage**  
      Pour une transition valide (`S002=OK`) + prérequis validés (`S004=OK`), `buildPhaseDependencyMatrix` retourne:
  - `allowed: true`
  - `reasonCode: "OK"`
  - `blockingDependencies: []`
  - `dependencies` avec statuts non bloquants
  - `owner` visible dans `diagnostics`

- [x] **AC-02 — Blocage transition explicite (FR-010 + AC-010B)**  
      Si la transition est bloquée (`TRANSITION_NOT_ALLOWED | PHASE_NOTIFICATION_MISSING | PHASE_NOTIFICATION_SLA_EXCEEDED`), la matrice:
  - bloque (`allowed: false`)
  - propage le blocage (reason code explicite)
  - inclut la dépendance bloquante dans `blockingDependencies`
  - expose un message explicite contenant `owner`

- [x] **AC-03 — Blocage checklist prérequis**  
      Si S004 retourne `PHASE_PREREQUISITES_MISSING | PHASE_PREREQUISITES_INCOMPLETE | INVALID_PHASE_PREREQUISITES`, la matrice:
  - bloque (`allowed: false`)
  - propage strictement le reason code S004
  - ajoute une action corrective déterministe `COMPLETE_PREREQUISITES`

- [x] **AC-04 — Contexte override intégré**  
      Si un blocage transition est overrideable et une évaluation S008 est fournie:
  - la dépendance `OVERRIDE` reflète l’état réel (`required/applied`)
  - en cas d’override non appliqué, l’action `REQUEST_OVERRIDE_APPROVAL` est recommandée
  - en cas d’override appliqué, la dépendance transition passe à l’état `overridden`

- [x] **AC-05 — État temps réel / staleness (AC-010A)**  
      Avec `maxRefreshIntervalMs` (défaut **5000 ms**):
  - si `snapshotAgeMs <= maxRefreshIntervalMs` => `isStale=false`
  - si `snapshotAgeMs > maxRefreshIntervalMs` => `allowed=false`, `reasonCode="DEPENDENCY_STATE_STALE"`, action `REFRESH_DEPENDENCY_MATRIX`

- [x] **AC-06 — Sources de données flexibles**
  - `transitionValidation` fourni -> utilisé tel quel; sinon délégation à S002 via `transitionInput`
  - `prerequisitesValidation` fourni -> utilisé tel quel; sinon délégation à S004 via `prerequisitesInput`
  - `overrideEvaluation` fourni -> utilisé tel quel; sinon optionnel via `overrideInput` vers S008
  - absence des sources obligatoires (transition + prerequis) -> `INVALID_PHASE_DEPENDENCY_INPUT`

- [x] **AC-07 — Entrées invalides**  
      Entrées invalides (`owner` vide, `maxRefreshIntervalMs` invalide, payload incohérent) ->
  - `allowed=false`
  - `reasonCode="INVALID_PHASE_DEPENDENCY_INPUT"`
  - aucune exception non contrôlée

- [x] **AC-08 — Contrat de sortie stable**  
      La fonction retourne systématiquement:
  `{ allowed, reasonCode, reason, diagnostics, dependencies, blockingDependencies, correctiveActions }`  
      avec:
  - `reasonCode` dans  
    `OK | INVALID_PHASE | TRANSITION_NOT_ALLOWED | PHASE_NOTIFICATION_MISSING | PHASE_NOTIFICATION_SLA_EXCEEDED | PHASE_PREREQUISITES_MISSING | PHASE_PREREQUISITES_INCOMPLETE | INVALID_PHASE_PREREQUISITES | OVERRIDE_NOT_ELIGIBLE | OVERRIDE_REQUEST_MISSING | OVERRIDE_JUSTIFICATION_REQUIRED | OVERRIDE_APPROVER_REQUIRED | OVERRIDE_APPROVER_CONFLICT | DEPENDENCY_STATE_STALE | INVALID_PHASE_DEPENDENCY_INPUT`
  - `dependencies[*].status` dans `ready | blocked | warning | overridden | stale`
  - `diagnostics` contenant au minimum:  
    `fromPhase`, `toPhase`, `owner`, `snapshotAgeMs`, `maxRefreshIntervalMs`, `isStale`, `totalDependencies`, `blockedDependenciesCount`, `sourceReasonCode`

- [x] **AC-09 — UI e2e démonstrateur minimal**  
      Couvrir `empty`, `loading`, `success`, `error` avec affichage explicite:
  - `reasonCode`
  - `reason`
  - `owner`
  - `blockingDependencies`
  - `correctiveActions`

- [x] **AC-10 — Seuil qualité module**  
      Couverture module S009 >= **95% lignes** et **95% branches**.

## Cas de test obligatoires
### Fonctionnels
- [x] Cas nominal: transition OK + prérequis OK -> `allowed=true`, aucun blocker.
- [x] Cas transition non autorisée: blocker transition visible + owner explicitement affiché.
- [x] Cas notification manquante: blocage explicite `PHASE_NOTIFICATION_MISSING` + action corrective.
- [x] Cas prérequis incomplets: blocage `PHASE_PREREQUISITES_INCOMPLETE` + action `COMPLETE_PREREQUISITES`.
- [x] Cas override requis non appliqué: dépendance `OVERRIDE` bloquante + action `REQUEST_OVERRIDE_APPROVAL`.
- [x] Cas override appliqué: dépendance transition marquée `overridden` et blocage transition levé.
- [x] Cas staleness: `snapshotAgeMs > maxRefreshIntervalMs` -> `DEPENDENCY_STATE_STALE`.
- [x] Cas UI e2e: parcours `empty -> loading -> error/success` avec rendu explicite owner + blockers + actions.

### Non-régression
- [x] `validatePhaseTransition` (S002) conserve son contrat et ses reason codes.
- [x] `buildPhaseStateProjection` (S003) conserve son contrat (owner/timestamps/status).
- [x] `validatePhasePrerequisites` (S004) conserve son contrat et ses reason codes.
- [x] `evaluatePhaseTransitionOverride` (S008) conserve son contrat et ses reason codes.
- [x] Les suites unit/edge/e2e existantes S001..S008 restent vertes.

### Sécurité / robustesse
- [x] Validation stricte des entrées et normalisation défensive (`owner`, phases, freshness).
- [x] Aucune mutation observable des objets d’entrée.
- [x] Aucune exécution shell dans S009.
- [x] Messages de blocage explicites et actionnables pour pilotage.

## Scope DEV strict S009
### Autorisé
1. Implémenter `buildPhaseDependencyMatrix(input, options?)` dans `app/src/phase-dependency-matrix.js`.
2. Exporter S009 dans `app/src/index.js` (export S009 uniquement).
3. Ajouter/adapter les tests S009:
   - `app/tests/unit/phase-dependency-matrix.test.js`
   - `app/tests/edge/phase-dependency-matrix.edge.test.js`
   - `app/tests/e2e/phase-dependency-matrix.spec.js`
4. Mettre à jour la story S009 + handoffs DEV (`S009-dev-to-uxqa.md`, `S009-dev-to-tea.md`) avec preuves d’exécution.

### Interdit (hors-scope)
- Toute évolution hors FR-010 / S009.
- Toute modification métier S001..S008 non strictement nécessaire à l’intégration S009.
- Tout refactor transverse non requis par les AC S009.
- Toute exécution shell depuis le module S009.

## Contraintes
- Scope strict S009: pas de modification produit hors FR-010.
- Les sources S002/S003/S004/S008 restent la référence (pas de logique contradictoire).
- Fraîcheur temps réel par défaut: `maxRefreshIntervalMs=5000`.
- Story non-DONE tant que **G4-T** et **G4-UX** ne sont pas tous deux PASS.

## Implémentation
### Réalisé (DEV)
1. Création de `app/src/phase-dependency-matrix.js` avec API `buildPhaseDependencyMatrix(input, options?)`.
2. Résolution des sources conforme PM:
   - `transitionValidation` injecté, sinon délégation à S002 (`transitionInput` → `validatePhaseTransition`, injectable via `options.transitionValidator`),
   - `prerequisitesValidation` injecté, sinon délégation à S004 (`prerequisitesInput` → `validatePhasePrerequisites`, injectable via `options.prerequisitesValidator`),
   - `overrideEvaluation` injecté, sinon optionnel via `overrideInput` → S008 (`evaluatePhaseTransitionOverride`, injectable via `options.overrideEvaluator`),
   - `owner` direct ou fallback S003 (`phaseStateProjection`/`phaseStateInput`, `buildPhaseStateProjection` injectable via `options.phaseStateProjector`).
3. Implémentation de la matrice de dépendances (`TRANSITION`, `PREREQUISITES`, `OVERRIDE`, `FRESHNESS`) avec statuts `ready|blocked|warning|overridden|stale`.
4. Propagation explicite des blocages + owner dans les messages; `blockingDependencies` et `correctiveActions` déterministes.
5. Implémentation staleness temps réel:
   - `maxRefreshIntervalMs` défaut `5000`,
   - `snapshotAgeMs > maxRefreshIntervalMs` → `DEPENDENCY_STATE_STALE` + action `REFRESH_DEPENDENCY_MATRIX`.
6. Contrat de sortie stable garanti:
   `{ allowed, reasonCode, reason, diagnostics, dependencies, blockingDependencies, correctiveActions }`.
7. Export public S009 ajouté dans `app/src/index.js` (`buildPhaseDependencyMatrix`).
8. Ajout/renforcement des tests S009:
   - `app/tests/unit/phase-dependency-matrix.test.js`
   - `app/tests/edge/phase-dependency-matrix.edge.test.js`
   - `app/tests/e2e/phase-dependency-matrix.spec.js`
9. Exécution complète des gates techniques DEV = PASS.

## Review
- [x] Mapping AC → tests documenté.
- [x] Vérification explicite réutilisation S002/S003/S004/S008 (injection/délégation).
- [x] Vérification couverture module >= 95% lignes + branches.
- [x] Résultat gates techniques publié (PASS/CONCERNS/FAIL).

### Mapping AC → tests
- AC-01/02/03/04/05/06/07/08/10: `app/tests/unit/phase-dependency-matrix.test.js`, `app/tests/edge/phase-dependency-matrix.edge.test.js`
- AC-09: `app/tests/e2e/phase-dependency-matrix.spec.js`
- AC-10 (coverage >=95% lignes+branches): `npm run test:coverage` (S009 `phase-dependency-matrix.js` = **99.63% lines**, **99.23% branches**)

### Gates techniques (DEV)
Commande de revalidation exécutée depuis `app/` (UTC 2026-02-21T15:57:37Z):
`npm run lint && npm run typecheck && npx vitest run tests/unit tests/edge && npx playwright test tests/e2e && npm run test:coverage && npm run build && npm run security:deps` ✅

Résultats observés:
- `npm run lint` ✅
- `npm run typecheck` ✅
- `npx vitest run tests/unit tests/edge` ✅ (**18 fichiers / 198 tests passés**)
- `npx playwright test tests/e2e` ✅ (**17/17 tests passés**)
- `npm run test:coverage` ✅
  - global: **99.58% statements / 98.39% branches / 100% functions / 99.58% lines**
  - module S009 `app/src/phase-dependency-matrix.js`: **99.64% statements / 99.23% branches / 100% functions / 99.63% lines**
- `npm run build` ✅
- `npm run security:deps` ✅ (`npm audit --audit-level=high`: **0 vulnérabilité**)
- Verdict technique DEV: **PASS**

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit/phase-dependency-matrix.test.js tests/edge/phase-dependency-matrix.edge.test.js`
4. `npx playwright test tests/e2e/phase-dependency-matrix.spec.js`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`

## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests cas limites (edge)
- [x] coverage >= seuil
- [x] security scan dépendances
- [x] build

## Règle Story DONE
- Interdit de passer DONE si un seul gate échoue (technique OU UX).
- Audit UX obligatoire: `_bmad-output/implementation-artifacts/ux-audits/<SID>-ux-audit.json` avec verdict PASS.
- Utiliser `bash scripts/story-done-guard.sh <SID>` pour valider la fin.

## UX Gates obligatoires
- [ ] conformité design-system (tokens, spacing, typo, composants)
- [ ] accessibilité WCAG 2.2 AA (minimum)
- [ ] responsive (mobile/tablet/desktop)
- [ ] états d'interface (loading/empty/error/success)
- [ ] hiérarchie visuelle et lisibilité
- [ ] evidence UX fournie (captures/rapports)

## Status
- Dernière revalidation DEV (UTC): 2026-02-21T15:57:37Z
READY_FOR_REVIEW
