# S005 - Validation des prérequis obligatoires avant activation de phase

## Epic
E01

## User story
En tant qu’orchestrateur BMAD,
je veux valider les prérequis déclarés avant d’activer la phase suivante,
afin d’empêcher toute activation prématurée et de disposer d’un motif de blocage actionnable.

## Dépendances
- S002 (validateur de transition canonique + SLA notification) = source de vérité pour les reason codes transition.
- S003 (projection d’état de phase) = consommation UI des blocages et diagnostics.

## Traçabilité
- FR-005: exiger les prérequis déclarés avant activation de la phase suivante.
- FR-003 (réutilisation): ne pas contourner les blocages de transition/SLA issus de S002.
- NFR-034: diagnostics exploitables en continu pour le pilotage.
- Risques couverts: P01, P07.

## Critères d'acceptation
- [x] AC-01 (Nominal): pour une transition canonique autorisée (`S002.allowed=true`) avec checklist valide dont tous les prérequis `required=true` sont `status="done"`, la validation retourne `allowed: true`, `reasonCode: "OK"`.
- [x] AC-02 (Blocage transition propagé): si `transitionValidation.allowed=false` avec `reasonCode` dans `INVALID_PHASE | TRANSITION_NOT_ALLOWED | PHASE_NOTIFICATION_MISSING | PHASE_NOTIFICATION_SLA_EXCEEDED`, la validation retourne `allowed: false` et **ré-expose exactement** le même `reasonCode` + `reason`.
- [x] AC-03 (Checklist absente): si `prerequisites` est absent, non-tableau ou vide, la validation retourne `allowed: false`, `reasonCode: "PHASE_PREREQUISITES_MISSING"`, sans exception non contrôlée.
- [x] AC-04 (Prérequis requis incomplet): si au moins un prérequis requis n’est pas `done`, la validation retourne `allowed: false`, `reasonCode: "PHASE_PREREQUISITES_INCOMPLETE"`, avec la liste des identifiants manquants dans `diagnostics.missingPrerequisiteIds`.
- [x] AC-05 (Prérequis optionnels): les items `required=false` non `done` ne bloquent pas la transition si tous les items requis sont `done`.
- [x] AC-06 (Entrées checklist invalides): item invalide (`id` vide, `status` hors enum, doublon d’id) => `allowed: false`, `reasonCode: "INVALID_PHASE_PREREQUISITES"`, sans crash.
- [x] AC-07 (Contrat stable): la fonction retourne toujours
  `{ allowed, reasonCode, reason, diagnostics }` avec:
  - `reasonCode` dans `OK | INVALID_PHASE | TRANSITION_NOT_ALLOWED | PHASE_NOTIFICATION_MISSING | PHASE_NOTIFICATION_SLA_EXCEEDED | PHASE_PREREQUISITES_MISSING | PHASE_PREREQUISITES_INCOMPLETE | INVALID_PHASE_PREREQUISITES`
  - `diagnostics` contenant au minimum `fromPhase`, `toPhase`, `requiredCount`, `satisfiedCount`, `missingPrerequisiteIds`, `blockedByTransition`.
- [x] AC-08 (UI e2e): démonstrateur minimal avec états `empty`, `loading`, `success`, `error` affichant `reasonCode`, `reason` et la checklist manquante en cas de blocage.
- [x] AC-09 (Seuil qualité): couverture du module de validation prérequis >= 95% (lignes + branches).

## Cas de test obligatoires
### Fonctionnels
- [x] Cas nominal: transition `H03 -> H04` autorisée + 3/3 prérequis requis `done` => `allowed=true`, `reasonCode=OK`.
- [x] Cas blocage transition: transition invalide (ex: `H03 -> H05`) via S002 => propagation `TRANSITION_NOT_ALLOWED`.
- [x] Cas checklist absente: `prerequisites=null` ou `[]` => `PHASE_PREREQUISITES_MISSING`.
- [x] Cas prérequis incomplet: au moins un requis `pending`/`blocked` => `PHASE_PREREQUISITES_INCOMPLETE` + `missingPrerequisiteIds` renseigné.
- [x] Cas optionnel: item `required=false` non `done` mais requis complets => autorisé.
- [x] Cas entrée invalide: `id` vide, `status="unknown"`, doublon d’ID => `INVALID_PHASE_PREREQUISITES`.
- [x] Cas UI e2e: parcours `empty -> loading -> error/success` avec rendu explicite des motifs.

### Non-régression
- [x] `validatePhaseTransition` (S002) conserve son contrat et ses reason codes.
- [x] `buildPhaseStateProjection` (S003) conserve son contrat stable.
- [x] Les fonctions existantes (`safeDivide`, `normalizeEmail`, `normalizeUserName`, `clamp`) restent inchangées.
- [x] Les suites unit/edge/e2e existantes restent vertes.

### Sécurité / robustesse
- [x] Validation stricte des entrées (`fromPhase`, `toPhase`, `prerequisites[*]`).
- [x] Aucune mutation observable des objets d’entrée (immutabilité).
- [x] Aucun `eval` / exécution dynamique risquée.
- [x] Messages de blocage explicites et exploitables côté UI/opérations.

## Implémentation
### Réalisé (DEV)
1. Création du module `app/src/phase-prerequisites-validator.js` avec API publique `validatePhasePrerequisites(input)`.
2. Réutilisation explicite de S002 (`validatePhaseTransition`) via:
   - `transitionValidation` en entrée (source de vérité transmise),
   - `transitionInput` (délégation directe à S002).
3. Implémentation des reason codes S005:
   - `PHASE_PREREQUISITES_MISSING`
   - `PHASE_PREREQUISITES_INCOMPLETE`
   - `INVALID_PHASE_PREREQUISITES`
   avec propagation stricte des blocages transition S002 (`INVALID_PHASE`, `TRANSITION_NOT_ALLOWED`, `PHASE_NOTIFICATION_MISSING`, `PHASE_NOTIFICATION_SLA_EXCEEDED`).
4. Diagnostics stables fournis en sortie: `fromPhase`, `toPhase`, `requiredCount`, `satisfiedCount`, `missingPrerequisiteIds`, `blockedByTransition` (+ signaux transition).
5. Export ajouté dans `app/src/index.js`: `validatePhasePrerequisites`.
6. Ajout des tests S005:
   - `app/tests/unit/phase-prerequisites-validator.test.js`
   - `app/tests/edge/phase-prerequisites-validator.edge.test.js`
   - `app/tests/e2e/phase-prerequisites-validator.spec.js`
7. Démonstrateur e2e enrichi avec états `empty/loading/error/success`, rendu explicite `reasonCode/reason/missingPrerequisiteIds` et non-régression responsive (absence d’overflow horizontal mobile/tablette/desktop).

## Review
- [x] Mapping AC → tests documenté et complet.
- [x] Vérification explicite de la cohérence reason codes/diagnostics avec S002/S003.
- [x] Vérification coverage module >= 95% lignes + branches.
- [x] Résultat gates techniques publié (PASS/CONCERNS/FAIL).

### Mapping AC → tests
- AC-01/03/04/05/06/07: `app/tests/unit/phase-prerequisites-validator.test.js`, `app/tests/edge/phase-prerequisites-validator.edge.test.js`
- AC-02 (propagation S002): `app/tests/unit/phase-prerequisites-validator.test.js`, `app/tests/edge/phase-prerequisites-validator.edge.test.js`
- AC-08 (UI e2e): `app/tests/e2e/phase-prerequisites-validator.spec.js`
- AC-09 (coverage module): `app/src/phase-prerequisites-validator.js` = **98.8% lines**, **97.59% branches** (`npm run test:coverage`)

### Gates techniques (DEV)
- `npm run lint` ✅
- `npm run typecheck` ✅
- `npx vitest run tests/unit tests/edge` ✅ (70 tests)
- `npx playwright test tests/e2e` ✅ (7 tests)
- `npm run test:coverage` ✅
- `npm run build` ✅
- `npm run security:deps` ✅ (0 vulnérabilité)
- Revalidation DEV (2026-02-21T11:42:57Z): `lint`, `typecheck`, `vitest unit+edge`, `playwright S005`, `playwright e2e`, `coverage`, `build`, `security:deps` = ✅
- Verdict technique DEV: **PASS**

## Comment tester (simple)
1. `cd /root/.openclaw/workspace/projects/dashboard-openclaw/app`
2. `npm run lint && npm run typecheck`
3. `npx vitest run tests/unit tests/edge`
4. `npx playwright test tests/e2e`
5. `npm run test:coverage`
6. `npm run build && npm run security:deps`


## Quality Gates obligatoires
- [x] lint
- [x] typecheck
- [x] tests unit/intégration
- [x] tests e2e
- [x] tests cas limites (edge)
- [x] coverage >= seuil
- [x] security scan dépendances
- [x] build

## Règle Story DONE
- Interdit de passer DONE si un seul gate échoue (technique OU UX).
- Audit UX obligatoire: `_bmad-output/implementation-artifacts/ux-audits/<SID>-ux-audit.json` avec verdict PASS.
- Utiliser `bash scripts/story-done-guard.sh <SID>` pour valider la fin.

## UX Gates obligatoires
- [ ] conformité design-system (tokens, spacing, typo, composants)
- [ ] accessibilité WCAG 2.2 AA (minimum)
- [ ] responsive (mobile/tablet/desktop)
- [ ] états d'interface (loading/empty/error/success)
- [ ] hiérarchie visuelle et lisibilité
- [ ] evidence UX fournie (captures/rapports)

## Status
READY_FOR_REVIEW
